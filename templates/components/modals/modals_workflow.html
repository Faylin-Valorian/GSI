<div class="modal fade" id="cleanupModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content custom-panel border-info">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-info"><i class="bi bi-magic me-2"></i>Initial Data Preparation</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-dark border-secondary d-flex align-items-center mb-4">
                    <i class="bi bi-info-circle-fill fs-3 me-3 text-info"></i>
                    <div>
                        <strong>Standardization Routine</strong><br>
                        <small class="text-muted">Runs 7 processing steps including: Backup, Filename Normalization, Instrument ID Generation, and Legal Injection.</small>
                    </div>
                </div>
                <p class="text-center text-muted fst-italic">...Content from original cleanupModal...</p>
            </div>
             </div>
    </div>
</div>

<div class="modal fade" id="initialPrepModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content custom-panel border-info">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-info"><i class="bi bi-magic me-2"></i>Initial Preparation Tool</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-4">
                <div class="alert alert-dark border-secondary d-flex align-items-center mb-4">
                    <i class="bi bi-info-circle-fill fs-3 me-3 text-info"></i>
                    <div>
                        <strong>Database Preparation Routine</strong><br>
                        <small class="text-muted">Standardizes filenames, generates instrument IDs, and creates required external reference tables (Keli/Manifest) for the active county.</small>
                    </div>
                </div>

                <div class="card bg-dark border-secondary mb-3">
                    <div class="card-header border-secondary py-2 d-flex justify-content-between align-items-center">
                        <span class="small text-muted text-uppercase fw-bold">
                            <i class="bi bi-images me-2"></i>Image Path Cleanup (Optional)
                        </span>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="prepToggleBook" onchange="togglePrepBookInputs()">
                        </div>
                    </div>
                    
                    <div class="card-body py-3 d-none" id="prepBookInputsContainer">
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <label class="col-form-label small text-light">Book Start:</label>
                            </div>
                            <div class="col-auto">
                                <input type="text" id="prepBookStart" class="form-control form-control-sm bg-black text-light border-secondary" placeholder="---">
                            </div>
                            
                            <div class="col-auto ms-3">
                                <label class="col-form-label small text-light">Book End:</label>
                            </div>
                            <div class="col-auto">
                                <input type="text" id="prepBookEnd" class="form-control form-control-sm bg-black text-light border-secondary" placeholder="---">
                            </div>
                            
                            <div class="col text-end">
                                <small class="text-muted fst-italic" id="prepBookStatus">Ready to scan</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="prepProgressContainer" class="d-none mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label class="small text-info" id="prepProgressLabel">Processing...</label>
                        <span class="small text-muted" id="prepProgressPercent">0%</span>
                    </div>
                    <div class="progress bg-dark border border-secondary" style="height: 20px;">
                        <div id="prepProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>

                <div id="prepDebugPanel" class="d-none mb-3">
                    <div class="d-flex justify-content-between align-items-end mb-1">
                        <label class="text-warning small fw-bold"><i class="bi bi-bug me-1"></i>Debug: SQL Preview</label>
                        <div>
                            <button class="btn btn-xs btn-outline-secondary" onclick="copyPrepSql()">Copy</button>
                        </div>
                    </div>
                    <textarea id="prepSqlPreview" class="form-control bg-black text-success border-warning font-monospace small" style="height: 150px; font-size: 0.8rem; resize: vertical;" readonly></textarea>
                </div>

                <div id="prepResult" class="text-center small mt-3"></div>
            </div>

            <div class="modal-footer border-secondary justify-content-between">
                <div>
                    <button type="button" class="btn btn-outline-warning btn-sm d-none" id="btnPrepPreview" onclick="previewPrepSql()">
                        <i class="bi bi-file-earmark-code me-1"></i>Generate Preview
                    </button>
                </div>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-info fw-bold text-dark" onclick="runPrepTool()" id="btnRunPrep">
                        <i class="bi bi-play-fill me-1"></i>Run Preparation
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="eDataModal" tabindex="-1" style="z-index: 1080;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content custom-panel border-success">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="bi bi-table me-2"></i>Setup eData Table</h5>
                <button type="button" class="btn-close btn-close-white" onclick="closeEDataModal()"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2 text-muted small">Target Directory:</p>
                <div class="alert alert-dark border-secondary text-monospace small mb-3" role="alert">
                    <i class="bi bi-folder2-open me-2 text-warning"></i>
                    <span id="eDataDisplayPath" class="text-light">Loading...</span>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Import Mode</label>
                    <select id="eDataImportMode" class="form-select border-secondary bg-transparent text-light">
                        <option value="D" selected>Overwrite Existing Data (Drop)</option>
                        <option value="A">Append to Existing Data (Append)</option>
                    </select>
                    <div class="form-text text-end small fst-italic text-muted">Select 'Overwrite' to clear table before importing.</div>
                </div>
                <div id="eDataProgressContainer" class="d-none mb-3">
                    <div class="d-flex justify-content-between small mb-1">
                        <span class="text-muted">Importing...</span>
                        <span id="eDataProgressText" class="text-light">0%</span>
                    </div>
                    <div class="progress" style="height: 10px; background-color: #333;">
                        <div id="eDataProgressBar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;"></div>
                    </div>
                    <div id="eDataCurrentFile" class="text-muted small mt-1 text-truncate">Initializing...</div>
                </div>
                <div id="eDataResult" class="text-center small"></div>
                <input type="hidden" id="eDataCountyId">
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" onclick="closeEDataModal()">Close</button>
                <button type="button" class="btn btn-success" onclick="submitEDataSetup()">Run Import</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="keliModal" tabindex="-1" style="z-index: 1080;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content custom-panel" style="border-color: #a370f7;">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" style="color: #a370f7;"><i class="bi bi-collection me-2"></i>Setup Keli Tables</h5>
                <button type="button" class="btn-close btn-close-white" onclick="closeKeliModal()"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2 text-muted small">Target Directory:</p>
                <div class="alert alert-dark border-secondary text-monospace small mb-3" role="alert">
                    <i class="bi bi-folder-fill me-2" style="color: #a370f7;"></i>
                    <span id="keliDisplayPath" class="text-light">Loading...</span>
                </div>
                <div id="keliProgressContainer" class="d-none mb-3">
                    <div class="d-flex justify-content-between small mb-1">
                        <span class="text-muted">Importing...</span>
                        <span id="keliProgressText" class="text-light">0%</span>
                    </div>
                    <div class="progress" style="height: 10px; background-color: #333;">
                        <div id="keliProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%; background-color: #a370f7;"></div>
                    </div>
                    <div id="keliCurrentFile" class="text-muted small mt-1 text-truncate">Initializing...</div>
                </div>
                <div id="keliResult" class="text-center small"></div>
                <input type="hidden" id="keliCountyId">
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" onclick="closeKeliModal()">Close</button>
                <button type="button" class="btn text-white" style="background-color: #a370f7;" onclick="submitKeliSetup()">Run Import</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="keliLinkupModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content custom-panel" style="border-color: #d63384;">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" style="color: #d63384;"><i class="bi bi-link-45deg me-2"></i>Initial Keli Linkup</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-4">
                <div class="alert alert-dark border-secondary d-flex align-items-center mb-4">
                    <i class="bi bi-info-circle-fill fs-3 me-3" style="color: #d63384;"></i>
                    <div>
                        <strong>Data Linkup Routine</strong><br>
                        <small class="text-muted">Links Generic Data with Keli external tables and standardizes image paths.</small>
                    </div>
                </div>

                <div class="d-flex justify-content-end mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="linkupSplitImages">
                        <label class="form-check-label text-warning small fw-bold" for="linkupSplitImages">Split Images</label>
                    </div>
                </div>

                <div class="card bg-dark border-secondary mb-3">
                    <div class="card-header border-secondary py-2 d-flex justify-content-between align-items-center">
                        <span class="small text-muted text-uppercase fw-bold">Stech Image Path</span>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="linkupTogglePath" onchange="toggleLinkupPathInput()">
                        </div>
                    </div>
                    <div class="card-body py-3 d-none" id="linkupPathContainer">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label small text-light">Full Path Prefix</label>
                                <input type="text" id="linkupImgPath" class="form-control form-control-sm bg-black text-light border-secondary" placeholder="e.g. D:\data\OK\Cleveland\Images\">
                                <div class="form-text x-small text-muted">
                                    SQL: <code>UPDATE GenericDataImport SET stech_image_path = '{Prefix}' + col03varchar...</code>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card bg-dark border-secondary mb-3">
                    <div class="card-header border-secondary py-2 d-flex justify-content-between align-items-center">
                        <span class="small text-muted text-uppercase fw-bold">Book Range Constraints</span>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="linkupToggleBook" onchange="toggleLinkupBookInputs()">
                        </div>
                    </div>
                    <div class="card-body py-3 d-none" id="linkupBookContainer">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small text-light">Book Start</label>
                                <input type="text" id="linkupBookStart" class="form-control form-control-sm bg-black text-light border-secondary" placeholder="YYYY-BBBB">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small text-light">Book End</label>
                                <input type="text" id="linkupBookEnd" class="form-control form-control-sm bg-black text-light border-secondary" placeholder="YYYY-BBBB">
                            </div>
                            <div class="col-12">
                                <hr class="border-secondary">
                                <label class="form-label small text-light d-block mb-2">Key ID Source</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="linkupMode" id="linkupModeLegacy" value="legacy">
                                    <label class="btn btn-sm btn-outline-secondary" for="linkupModeLegacy">Legacy</label>

                                    <input type="radio" class="btn-check" name="linkupMode" id="linkupModeManifest" value="manifest">
                                    <label class="btn btn-sm btn-outline-secondary" for="linkupModeManifest">Combined Manifest</label>

                                    <input type="radio" class="btn-check" name="linkupMode" id="linkupModeNeither" value="neither" checked>
                                    <label class="btn btn-sm btn-outline-secondary" for="linkupModeNeither">Neither</label>
                                </div>
                            </div>
                            <div class="col-12 text-end">
                                <small class="text-muted fst-italic" id="linkupAutoStatus"></small>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="linkupProgressContainer" class="d-none mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label class="small" style="color: #d63384;" id="linkupProgressLabel">Processing...</label>
                        <span class="small text-muted" id="linkupProgressPercent">0%</span>
                    </div>
                    <div class="progress bg-dark border border-secondary" style="height: 20px;">
                        <div id="linkupProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%; background-color: #d63384;"></div>
                    </div>
                </div>

                <div id="linkupDebugPanel" class="d-none mb-3">
                    <div class="d-flex justify-content-between align-items-end mb-1">
                        <label class="text-warning small fw-bold"><i class="bi bi-bug me-1"></i>Debug: SQL Preview</label>
                        <div>
                            <button class="btn btn-xs btn-outline-secondary" onclick="copyLinkupSql()">Copy</button>
                        </div>
                    </div>
                    <textarea id="linkupSqlPreview" class="form-control bg-black text-success border-warning font-monospace small" style="height: 150px; font-size: 0.8rem; resize: vertical;" readonly></textarea>
                </div>
                
                <div id="linkupDiagnostics" class="alert alert-warning d-none mt-2 small font-monospace text-break">
                    <i class="bi bi-bug-fill me-2"></i><strong>Auto-Fill Diagnostics</strong><br>
                    <span id="linkupDiagContent">Loading...</span>
                </div>

                <div id="linkupResult" class="text-center small mt-3"></div>
            </div>

            <div class="modal-footer border-secondary justify-content-between">
                <div>
                    <button type="button" class="btn btn-outline-warning btn-sm d-none" id="btnLinkupPreview" onclick="previewLinkupSql()">
                        <i class="bi bi-file-earmark-code me-1"></i>Generate Preview
                    </button>
                </div>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn fw-bold text-white" style="background-color: #d63384;" onclick="runLinkupTool()" id="btnRunLinkup">
                        <i class="bi bi-play-fill me-1"></i>Run Linkup
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="edataErrorsModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content custom-panel" style="border-color: #dc3545;">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" style="color: #dc3545;"><i class="bi bi-exclamation-triangle-fill me-2"></i>eData Errors Tool</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-4">
                <div class="alert alert-dark border-secondary d-flex align-items-center mb-4">
                    <i class="bi bi-info-circle-fill fs-3 me-3" style="color: #dc3545;"></i>
                    <div>
                        <strong>Error Report Generator</strong><br>
                        <small class="text-muted">Runs validation queries and saves CSV reports to the <code>eData Errors</code> folder. Empty reports are skipped.</small>
                    </div>
                </div>

                <div class="card bg-dark border-secondary mb-3">
                    <div class="card-header border-secondary py-2 text-muted small text-uppercase fw-bold d-flex justify-content-between align-items-center">
                        <span>Query Parameters</span>
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input" type="checkbox" id="edeSplitImages">
                            <label class="form-check-label small text-warning" for="edeSplitImages">Split Images</label>
                        </div>
                    </div>
                    <div class="card-body py-3">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small text-light">Book Start</label>
                                <input type="text" id="edeBookStart" class="form-control form-control-sm bg-black text-light border-secondary" placeholder="YYYY-BBBB">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small text-light">Book End</label>
                                <input type="text" id="edeBookEnd" class="form-control form-control-sm bg-black text-light border-secondary" placeholder="YYYY-BBBB">
                            </div>
                            <div class="col-md-12">
                                <label class="form-label small text-light">Valid Township/Ranges (Comma Separated)</label>
                                <textarea id="edeTownships" class="form-control form-control-sm bg-black text-light border-secondary" rows="2" placeholder="e.g. 1N,1W, 1N,2W"></textarea>
                                <div class="form-text x-small text-muted">Required for <code>legalOutOfCountyTownshipRanges.csv</code></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="edeProgressContainer" class="d-none mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label class="small" style="color: #dc3545;" id="edeProgressLabel">Processing...</label>
                        <span class="small text-muted" id="edeProgressPercent">0%</span>
                    </div>
                    <div class="progress bg-dark border border-secondary" style="height: 20px;">
                        <div id="edeProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%; background-color: #dc3545;"></div>
                    </div>
                    <div id="edeLogBox" class="mt-2 p-2 bg-black border border-secondary text-muted font-monospace small" style="height: 100px; overflow-y: auto; font-size: 0.7rem;"></div>
                </div>

                <div id="edeResult" class="text-center small mt-3"></div>
            </div>

            <div class="modal-footer border-secondary justify-content-end">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn fw-bold text-white" style="background-color: #dc3545;" onclick="runEdataErrors()" id="btnRunEde">
                    <i class="bi bi-play-fill me-1"></i>Run Scan
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="importEDataErrorsModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content custom-panel" style="border-color: #dc3545;">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" style="color: #dc3545;"><i class="bi bi-upload me-2"></i>Import eData Errors</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2 text-muted small">Target Directory:</p>
                <div class="alert alert-dark border-secondary text-monospace small mb-3" role="alert">
                    <i class="bi bi-folder-fill me-2" style="color: #dc3545;"></i>
                    <span id="importEdeDisplayPath" class="text-light">Loading...</span>
                </div>
                
                <div class="text-center mb-3">
                    <span class="badge bg-secondary" id="importEdeFileCount">Scanning...</span>
                </div>

                <div id="importEdeProgressContainer" class="d-none mb-3">
                    <div class="d-flex justify-content-between small mb-1">
                        <span class="text-muted">Importing...</span>
                        <span id="importEdeProgressText" class="text-light">0%</span>
                    </div>
                    <div class="progress bg-dark border border-secondary" style="height: 20px;">
                        <div id="importEdeProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%; background-color: #dc3545;"></div>
                    </div>
                    <div id="importEdeCurrentFile" class="text-muted small mt-1 text-truncate">Initializing...</div>
                </div>
                
                <div id="importEdeDebugPanel" class="d-none mt-3">
                    <label class="text-warning small fw-bold"><i class="bi bi-bug me-1"></i>Debug Logs</label>
                    <div id="importEdeLogContent" class="bg-black border border-secondary p-2 small font-monospace text-muted" style="height: 150px; overflow-y: auto; white-space: pre-wrap;"></div>
                </div>

                <div id="importEdeResult" class="text-center small mt-3"></div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn fw-bold text-white" style="background-color: #dc3545;" onclick="runImportEDataErrors()" id="btnRunImportEde">
                    <i class="bi bi-box-arrow-in-down me-1"></i>Run Import
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="unindexedReviewModal" tabindex="-1" style="z-index: 1040;" data-bs-backdrop="false">
    <div class="modal-dialog" style="margin: 0; position: absolute; right: 0; top: 0; bottom: 0; width: auto; left: 60px; max-width: none !important; transition: left 0.3s ease;" id="unindexedModalDialog">
        <div class="modal-content custom-panel h-100 border-0 rounded-0 d-flex flex-column" style="border-left: 1px solid var(--border-color) !important;">
            <div class="modal-header border-secondary flex-shrink-0">
                <h5 class="modal-title text-warning">
                    <i class="bi bi-images me-2"></i>Review Unindexed Images
                </h5>
                <div class="ms-4 d-flex align-items-center">
                    <input type="text" id="scanPathInput" class="form-control form-control-sm bg-dark text-light border-secondary me-2" placeholder="Scan Path..." style="width: 300px;">
                    
                    <div class="form-check form-switch me-3">
                        <input class="form-check-input" type="checkbox" id="scanSplitToggle">
                        <label class="form-check-label small text-light" for="scanSplitToggle" title="Ignore suffixes like _001 or -1">Split Images</label>
                    </div>

                    <button class="btn btn-sm btn-warning" onclick="scanForUnindexed()">
                        <i class="bi bi-search me-1"></i>Scan
                    </button>
                </div>
                <button type="button" class="btn-close btn-close-white" onclick="closeUnindexedModal()"></button>
            </div>
            
            <div class="modal-body p-0 flex-grow-1" style="overflow: hidden;">
                <div class="row h-100 g-0">
                    <div class="col-4 border-end border-secondary d-flex flex-column h-100 bg-dark">
                        <div class="table-responsive flex-grow-1" style="overflow-y: auto;">
                            <table class="table table-dark table-hover table-sm mb-0 align-middle" style="font-size: 0.85rem;">
                                <thead class="sticky-top bg-secondary">
                                    <tr>
                                        <th class="ps-3">Image Reference</th>
                                        <th class="text-center" style="width: 120px;">Require Indexing</th>
                                    </tr>
                                </thead>
                                <tbody id="unindexedTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="imagePanContainer" class="col-8 h-100 bg-black position-relative" style="overflow: hidden; cursor: grab; user-select: none;">
                        <div id="imageLoader" class="spinner-border text-light position-absolute top-50 start-50 translate-middle d-none"></div>
                        <div id="noImageMsg" class="text-muted text-center position-absolute top-50 start-50 translate-middle">
                            <i class="bi bi-image fs-1 d-block mx-auto mb-2"></i>
                            Select an image from the list
                        </div>
                        
                        <div class="w-100 h-100 d-flex align-items-start justify-content-start pointer-events-none">
                            <img id="unindexedImagePreview" src="" alt="Preview" style="width: 100%; height: auto; transform-origin: 0 0; pointer-events: auto; display: none; user-select: none; -webkit-user-drag: none;">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer border-secondary py-1 flex-shrink-0">
                <input type="hidden" id="currentReviewCountyId">
                <small class="text-muted me-auto">Changes saved automatically.</small>
                <button type="button" class="btn btn-secondary btn-sm" onclick="closeUnindexedModal()">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="alterDbModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="background: #1e1e24; color: #e0e0e0;">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title fw-bold text-uppercase">
                    <i class="bi bi-database-gear me-2 text-warning"></i>Alter Database Fields
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-4">
                <div class="alert alert-info d-flex align-items-center mb-3">
                    <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                    <div>
                        <strong>Alter Fields Routine</strong><br>
                        This tool will rename legacy columns (e.g., col01other -> key_id) and add missing system columns required for the new workflow.
                        <br><small class="text-muted">Safe to run multiple times (checks for existence first).</small>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button class="btn btn-outline-primary" onclick="previewAlterDb()">
                        <i class="bi bi-code-square me-2"></i>Generate SQL Preview
                    </button>
                    
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="alterDbDebugToggle">
                        <label class="form-check-label text-muted small" for="alterDbDebugToggle">Debug Mode</label>
                    </div>
                </div>

                <div class="card bg-dark border-secondary mb-3">
                    <div class="card-header border-secondary py-1 text-muted small text-uppercase fw-bold">
                        SQL Execution Plan
                    </div>
                    <div class="card-body p-0 position-relative">
                        <div id="alterDbLoader" class="position-absolute w-100 h-100 d-none justify-content-center align-items-center" 
                             style="background: rgba(0,0,0,0.7); z-index: 5;">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                        
                        <pre id="alterDbSqlPreview" class="m-0 p-3 text-success" 
                             style="font-family: 'Consolas', monospace; font-size: 0.85rem; height: 300px; overflow-y: auto; white-space: pre-wrap;">
-- Click 'Generate SQL Preview' to analyze the database state...
                        </pre>
                    </div>
                </div>
            </div>

            <div class="modal-footer border-top border-secondary justify-content-between">
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="copyAlterDbSql()" title="Copy SQL">
                        <i class="bi bi-clipboard"></i>
                    </button>
                    <span class="text-muted small" id="alterDbStatusMsg">Ready</span>
                </div>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning fw-bold" onclick="runAlterDbMigration()" id="btnRunAlterDb" disabled>
                        <i class="bi bi-lightning-charge-fill me-1"></i>Execute Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="instCorrectionModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog" style="margin: 0; position: absolute; right: 0; top: 0; bottom: 0; width: auto; left: 60px; max-width: none !important; transition: left 0.3s ease;" id="itcModalDialog">
        <div class="modal-content border-0 rounded-0 h-100" style="background-color: #1a1a1a; color: #fff; border-left: 1px solid #333 !important;">
            
            <div class="modal-header border-secondary py-2 flex-shrink-0">
                <div class="d-flex align-items-center w-100">
                    <h5 class="modal-title text-uppercase fw-bold text-warning me-4">
                        <i class="bi bi-pencil-square me-2"></i>Instrument Type Corrections
                    </h5>
                    <div class="input-group input-group-sm w-50">
                        <span class="input-group-text bg-dark border-secondary text-secondary">Images Path</span>
                        <input type="text" id="itcPathInput" class="form-control bg-black text-light border-secondary font-monospace" placeholder="data/State/County/Images">
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-0 d-flex position-relative h-100" style="overflow: hidden;" id="itcModalBody">
                
                <div id="itcLeftPanel" class="d-flex flex-column border-end border-secondary h-100" 
                     style="width: 350px; min-width: 250px; max-width: 800px; background: #222; flex-shrink: 0;">
                    
                    <div class="p-2 border-bottom border-secondary bg-dark d-flex justify-content-between align-items-center">
                        <span class="text-muted small text-uppercase fw-bold">Records</span>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="itcHideCompleted" checked onchange="itcFetchList()">
                            <label class="form-check-label x-small text-muted" for="itcHideCompleted">Hide Done</label>
                        </div>
                    </div>
                    
                    <div id="itcRecordList" class="flex-grow-1 overflow-auto p-0 custom-scrollbar"></div>
                    <div class="p-2 border-top border-secondary text-center small text-muted" id="itcListStatus">
                        Loading...
                    </div>
                </div>

                <div id="itcResizer" class="h-100 border-start border-end border-secondary bg-black d-flex align-items-center justify-content-center" 
                     style="width: 8px; cursor: col-resize; flex-shrink: 0; z-index: 100;" 
                     title="Drag to resize">
                    <i class="bi bi-three-dots-vertical text-secondary x-small"></i>
                </div>

                <div class="d-flex flex-column flex-grow-1 h-100" style="background: #000; overflow: hidden; min-width: 400px;">
                    
                    <div class="p-2 border-bottom border-secondary bg-dark flex-shrink-0">
                        <div class="row g-2">
                            <div class="col-12">
                                <label class="x-small text-muted text-uppercase fw-bold">Header Text</label>
                                <div id="itcHeaderDisplay" class="text-info small font-monospace text-truncate">---</div>
                            </div>
                            <div class="col-6">
                                <label class="x-small text-muted text-uppercase fw-bold">Original Type (col03)</label>
                                <div id="itcOriginalDisplay" class="text-white small fw-bold">---</div>
                            </div>
                            <div class="col-6">
                                <label class="x-small text-muted text-uppercase fw-bold">Current Type (col03)</label>
                                <div id="itcCurrentDisplay" class="text-warning small fw-bold">---</div>
                            </div>
                        </div>
                    </div>

                    <div id="itcImagePanContainer" class="flex-grow-1 position-relative bg-black" style="overflow: hidden; cursor: grab; user-select: none;">
                        <div id="itcNoImage" class="text-muted fst-italic position-absolute top-50 start-50 translate-middle pointer-events-none">
                            Select a record to view images
                        </div>

                        <div class="w-100 h-100 d-flex align-items-start justify-content-start pointer-events-none">
                            <img id="itcMainImage" src="" alt="Correction Image" 
                                 style="width: 100%; height: auto; transform-origin: 0 0; pointer-events: auto; display: none; user-select: none; -webkit-user-drag: none;">
                        </div>
                        
                        <div class="position-absolute top-0 start-0 h-100 d-flex align-items-center justify-content-center" 
                             style="width: 80px; cursor: pointer; opacity: 0; transition: opacity 0.2s; z-index: 10;"
                             onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0"
                             onclick="event.stopPropagation(); itcPrevImage()">
                            <div class="bg-dark rounded-circle p-2 text-white shadow"><i class="bi bi-chevron-left fs-4"></i></div>
                        </div>
                        <div class="position-absolute top-0 end-0 h-100 d-flex align-items-center justify-content-center" 
                             style="width: 80px; cursor: pointer; opacity: 0; transition: opacity 0.2s; z-index: 10;"
                             onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0"
                             onclick="event.stopPropagation(); itcNextImage()">
                            <div class="bg-dark rounded-circle p-2 text-white shadow"><i class="bi bi-chevron-right fs-4"></i></div>
                        </div>
                    </div>

                    <div class="border-top border-secondary p-2 d-flex justify-content-center gap-2 bg-dark flex-shrink-0" 
                         style="height: 80px; overflow-x: auto;" id="itcThumbnailStrip">
                    </div>
                </div>

                <div id="itcPopover" class="position-absolute bg-dark border border-warning shadow-lg rounded p-2 d-none" 
                     style="z-index: 1070; width: 300px; max-height: 400px; display: flex; flex-direction: column;">
                    
                    <div class="mb-2 border-bottom border-secondary pb-2">
                        <div class="d-flex justify-content-between mb-2 px-1">
                            <span class="text-warning small fw-bold">Correction</span>
                            <button class="btn-close btn-close-white btn-sm" onclick="itcHidePopover()"></button>
                        </div>
                        <input type="text" id="itcPopSearch" class="form-control form-control-sm bg-black text-white border-secondary" 
                               placeholder="Search..." onkeyup="itcPopSearch()">
                    </div>
                    
                    <div id="itcPopResults" class="overflow-auto flex-grow-1 custom-scrollbar" style="max-height: 250px;"></div>
                </div>

            </div>
        </div>
    </div>
</div>