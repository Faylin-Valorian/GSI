<div class="popup-container">
    <style>
        /* ADAPTIVE BUTTONS: High Contrast for Light/Dark Modes */
        [data-bs-theme="dark"] .btn-outline-secondary,
        .dark-mode .btn-outline-secondary {
            --bs-btn-color: #f8f9fa;
            --bs-btn-border-color: #6c757d;
            --bs-btn-hover-bg: #f8f9fa;
            --bs-btn-hover-color: #000;
        }
        [data-bs-theme="light"] .btn-outline-secondary,
        .light-mode .btn-outline-secondary {
            --bs-btn-color: #000;
            --bs-btn-border-color: #000;
            --bs-btn-hover-bg: #000;
            --bs-btn-hover-color: #fff;
        }
    </style>

    <div class="popup-header">
        <div>
            <h6 class="mb-0 fw-bold text-uppercase">{{ name }}</h6>
            
            <div class="d-flex flex-column">
                {% if is_mine %}
                    <span class="small fw-bold text-primary">WORKING ON (YOU)</span>
                {% elif occupied_by %}
                    <span class="small fw-bold text-warning">LOCKED BY: {{ occupied_by|upper }}</span>
                {% elif not is_active %}
                    <span class="small fw-bold text-danger">INACTIVE (Admin Only)</span>
                {% else %}
                    <span class="small fw-bold text-success">AVAILABLE</span>
                {% endif %}

                <span class="small fw-bold text-uppercase {% if is_split_job %}text-warning{% else %}text-muted opacity-25{% endif %}" 
                      style="font-size: 0.7rem; transition: all 0.3s;">
                    <i class="bi bi-layout-split me-1"></i>Split Image Job
                </span>
            </div>
        </div>
        
        <div class="d-flex flex-column align-items-end gap-1">
            <div class="form-check form-switch m-0" title="Toggle Working Status">
                <input class="form-check-input" type="checkbox" role="switch" 
                    {% if is_mine %}checked{% endif %}
                    {% if (occupied_by or not is_active) and not is_mine %}disabled{% endif %}
                    onchange="toggleWork({{ id }}, this.checked)">
            </div>
            
            <div class="form-check form-switch m-0" title="Toggle Split Job Mode">
                <input class="form-check-input" type="checkbox" role="switch" id="splitJobSwitch_{{ id }}"
                    {% if is_split_job %}checked{% endif %}
                    onchange="initSplitJobToggle({{ id }}, this)">
            </div>
        </div>
    </div>

    <div class="row g-1 mb-3" style="height: 120px;">
        <div class="col h-100">
            <textarea class="form-control form-control-sm h-100 popup-notes" 
                {% if not is_mine %}disabled placeholder="Set as 'Working On' to edit notes"{% endif %}
                onblur="saveNotes({{ id }}, this.value)">{{ notes }}</textarea>
        </div>
        <div class="col-5 h-100">
            <div class="popup-image-container" 
                 style="cursor: {% if is_mine %}pointer{% else %}default{% endif %};"
                 onclick="triggerUpload({{ id }}, {{ 'true' if is_mine else 'false' }})">
                 {% if image_url %}
                    <img src="{{ image_url }}?t={{ time }}" class="popup-img">
                 {% else %}
                    <div class="d-flex justify-content-center align-items-center h-100 text-muted bg-dark bg-opacity-25">
                        <i class="bi bi-camera-fill fs-2 opacity-50"></i>
                    </div>
                 {% endif %}
                 {% if is_mine %}
                    <div class="popup-upload-overlay">Upload</div>
                 {% endif %}
                 <input type="file" id="upload-{{ id }}" hidden accept="image/*" onchange="uploadImage({{ id }}, this)">
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs nav-fill popup-tabs mb-2 flex-wrap" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-db-{{ id }}">Database Setup</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-edata-{{ id }}">eData Setup</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-keli-{{ id }}">Keli Setup</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-indexing-{{ id }}">Indexing Tools</button></li>
        
        <li class="w-100"></li>

        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-errors-{{ id }}" onclick="renderCountyErrors({{ id }})">eData Errors</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-merge-{{ id }}">Merge Data</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-db-{{ id }}">
            <div class="d-grid gap-2">
                <button class="btn btn-sm btn-outline-secondary text-start" {% if not is_mine %}disabled{% endif %} onclick="openDriveModal()">
                    <i class="bi bi-hdd-network me-2"></i>Open Drive Connection
                </button>
                <button class="btn btn-sm btn-outline-secondary text-start" {% if not is_mine %}disabled{% endif %} onclick="openDbCompatModal()">
                    <i class="bi bi-database-gear me-2"></i>Database Compatibility Level
                </button>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-edata-{{ id }}">
            <div class="row g-2">
                <div class="col-12">
                    <div class="d-grid gap-2">
                        <button class="btn btn-sm btn-outline-secondary text-start" {% if not is_mine %}disabled{% endif %} onclick="openEDataModal({{ id }}, '{{ state_name }}', '{{ name }}')">
                            <i class="bi bi-table me-1"></i>Setup eData
                        </button>
                        <button class="btn btn-sm btn-outline-secondary text-start" {% if not is_mine %}disabled{% endif %} onclick="openAlterDbTool()">
                            <i class="bi bi-database-exclamation me-1"></i>Alter Table
                        </button>
                         <button class="btn btn-sm btn-outline-secondary text-start" {% if not is_mine %}disabled{% endif %} onclick="openInitialPrepTool({{ id }})">
                            <i class="bi bi-magic me-1"></i>Initial Prep
                        </button>
                        <button class="btn btn-sm btn-outline-secondary text-start" onclick="openLinkupModal({{ id }})">
                            <i class="bi bi-link-45deg me-1"></i>Linkup
                        </button>
                        <button class="btn btn-sm btn-outline-secondary text-start" {% if not is_mine %}disabled{% endif %} onclick="openFinalPrepTool({{ id }})">
                            <i class="bi bi-check-all me-1"></i>Final Prep
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-keli-{{ id }}">
            <div class="d-grid gap-2">
                <button class="btn btn-sm btn-outline-secondary text-start" {% if not is_mine %}disabled{% endif %} onclick="openKeliModal({{ id }}, '{{ state_name }}', '{{ name }}')">
                    <i class="bi bi-collection me-2"></i>Setup Keli Tables
                </button>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-indexing-{{ id }}">
            <div class="d-grid gap-2">
                <button class="btn btn-sm btn-outline-secondary text-start" {% if not is_mine %}disabled{% endif %} onclick="openUnindexedReview({{ id }}, '{{ state_name }}', '{{ name }}')">
                    <i class="bi bi-images me-1"></i>Review Unindexed Images
                </button>
                <button class="btn btn-sm btn-outline-secondary text-start" {% if not is_mine %}disabled{% endif %} onclick="openInstCorrectionTool({{ id }}, '{{ state_name }}', '{{ name }}')">
                    <i class="bi bi-pencil-square me-1"></i>Instrument Corrections
                </button>
                <button class="btn btn-sm btn-outline-secondary text-start" {% if not is_mine %}disabled{% endif %} onclick="openReviewLegalOthersModal({{ id }})">
                    <i class="bi bi-ui-checks-grid me-1"></i>Review Legal Type Others
                </button>
                <button class="btn btn-sm btn-outline-secondary text-start" {% if not is_mine %}disabled{% endif %} onclick="openAdditionsCorrectionTool({{ id }}, '{{ state_name }}', '{{ name }}')">
                    <i class="bi bi-building-add me-1"></i>Additions Correction Tool
                </button>
                <button class="btn btn-sm btn-outline-secondary w-100 text-start mb-2" onclick="openMissingNamesTool({{ id }}, '{{ state_name }}', '{{ name }}')">
                    <i class="bi bi-person-x me-2"></i>Missing Names Corrections
                </button>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-errors-{{ id }}">
            <div class="input-group input-group-sm mb-2">
                <select class="form-select" id="errorCat_{{ id }}" onchange="renderCountyErrors({{ id }})">
                    <option value="Header" selected>Header</option>
                    <option value="Image">Image</option>
                    <option value="Legal">Legal</option>
                    <option value="Name">Name</option>
                    <option value="Reference">Reference</option>
                </select>
                <button class="btn btn-primary" type="button" id="btnScan_{{ id }}" onclick="initScanConfirmation({{ id }})">
                    <i class="bi bi-search me-1"></i>Scan
                </button>
            </div>
            
            <div id="scanSpinner_{{ id }}" class="d-none text-center my-2">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                <span class="small ms-2 text-muted" id="scanStatus_{{ id }}">Scanning...</span>
            </div>

            <div id="errorBtnContainer_{{ id }}" class="d-grid gap-2 overflow-auto custom-scrollbar" style="max-height: 250px; padding-right: 5px;"></div>
        </div>

        <div class="tab-pane fade" id="tab-merge-{{ id }}">
            <div class="d-grid gap-2">
                <button class="btn btn-sm btn-outline-secondary text-start opacity-50" disabled>
                    <i class="bi bi-journals me-2"></i>Merge Instrument Types (Coming Soon)
                </button>
                <button class="btn btn-sm btn-outline-secondary text-start opacity-50" disabled>
                    <i class="bi bi-bank me-2"></i>Merge Legal Type Other (Coming Soon)
                </button>
                <button class="btn btn-sm btn-outline-secondary text-start opacity-50" disabled>
                    <i class="bi bi-plus-square me-2"></i>Merge Additions (Coming Soon)
                </button>
                <button class="btn btn-sm btn-outline-secondary text-start opacity-50" disabled>
                    <i class="bi bi-person-badge me-2"></i>Merge Missing Names (Coming Soon)
                </button>
                
                <button class="btn btn-sm btn-outline-danger text-start fw-bold" onclick="initMergeConfirm({{ id }}, 'edata_errors')">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Merge eData Errors Corrections
                </button>
            </div>
            <div id="mergeResult_{{ id }}" class="mt-2 text-center small"></div>
        </div>
    </div>

    <div class="modal fade" id="confirmSplitModal_{{ id }}" tabindex="-1" aria-hidden="true" style="background: rgba(0,0,0,0.5); z-index: 1060;">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary text-white shadow-lg">
                <div class="modal-header border-secondary py-2">
                    <h6 class="modal-title fw-bold text-warning"><i class="bi bi-exclamation-triangle me-2"></i>Confirm Change</h6>
                </div>
                <div class="modal-body text-center py-4">
                    <p class="mb-0 small" id="confirmSplitText_{{ id }}">Are you sure you want to modify the Split Job setting?</p>
                </div>
                <div class="modal-footer border-secondary py-1 justify-content-center">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="finalizeSplitToggle({{ id }}, false)">Cancel</button>
                    <button type="button" class="btn btn-sm btn-warning" onclick="finalizeSplitToggle({{ id }}, true)">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmScanModal_{{ id }}" tabindex="-1" aria-hidden="true" style="background: rgba(0,0,0,0.5); z-index: 1060;">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary text-white shadow-lg">
                <div class="modal-header border-secondary py-2">
                    <h6 class="modal-title fw-bold text-primary"><i class="bi bi-search me-2"></i>Confirm Scan</h6>
                </div>
                <div class="modal-body text-center py-4">
                    <p class="mb-0 small">This will drop existing error tables and rescan the GenericDataImport table.<br><br>Continue?</p>
                </div>
                <div class="modal-footer border-secondary py-1 justify-content-center">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-sm btn-primary" onclick="finalizeScan({{ id }})">Start Scan</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmMergeModal_{{ id }}" tabindex="-1" aria-hidden="true" style="background: rgba(0,0,0,0.5); z-index: 1060;">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content bg-dark border-warning text-white shadow-lg">
                <div class="modal-header border-secondary py-2">
                    <h6 class="modal-title fw-bold text-warning"><i class="bi bi-database-fill-gear me-2"></i>Confirm Merge</h6>
                </div>
                <div class="modal-body text-center py-3">
                    <p class="mb-0 small">
                        Are you sure you want to merge these corrections?<br>
                        <strong>This will overwrite data in the main table.</strong>
                    </p>
                </div>
                <div class="modal-footer border-secondary py-1 justify-content-center">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-sm btn-warning fw-bold" onclick="finalizeMerge({{ id }})">Yes, Merge</button>
                </div>
            </div>
        </div>
    </div>
</div>