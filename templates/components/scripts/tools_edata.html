<script>
    // ==========================================
    // EDATA TOOLS (Integrated)
    // ==========================================

    // --- SETUP EDATA TABLE ---
    function openEDataModal(id, stateName, countyName) { 
        closeAllModals(); 
        document.getElementById('eDataCountyId').value = id;
        const displayPath = `/data/${stateName}/${countyName}/eData Files`;
        document.getElementById('eDataDisplayPath').innerText = displayPath;
        if(eDataModal) eDataModal.show(); 
    }

    function closeEDataModal() { if(eDataModal) eDataModal.hide(); }

    async function submitEDataSetup() {
        const btn = document.querySelector('#eDataModal .btn-success');
        const resultDiv = document.getElementById('eDataResult');
        const idVal = document.getElementById('eDataCountyId').value;
        const mode = document.getElementById('eDataImportMode').value;
        
        btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Initializing...';
        resultDiv.innerHTML = ''; 
        document.getElementById('eDataProgressContainer').classList.remove('d-none');
        document.getElementById('eDataProgressBar').style.width = '0%';
        document.getElementById('eDataProgressText').innerText = '0%';

        try {
            const response = await fetch('/api/tools/setup-edata', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ county_id: idVal, mode: mode })
            });
            const reader = response.body.getReader(); const decoder = new TextDecoder();
            while (true) {
                const { done, value } = await reader.read(); if (done) break;
                const lines = decoder.decode(value).split('\n');
                lines.forEach(l => { if(l) try {
                    const d = JSON.parse(l);
                    if(d.type==='progress') {
                        document.getElementById('eDataProgressBar').style.width = d.percent+'%';
                        document.getElementById('eDataProgressText').innerText = d.percent+'%'; // FIX: Update Text
                    }
                    if(d.type==='complete') {
                        document.getElementById('eDataProgressBar').style.width = '100%';
                        document.getElementById('eDataProgressText').innerText = '100%';
                        resultDiv.innerHTML=`<div class="alert alert-success">${d.message}</div>`;
                    }
                } catch(e){} });
            }
        } catch (e) { resultDiv.innerHTML = '<div class="alert alert-danger">Connection Failed</div>'; } 
        finally { btn.disabled = false; btn.innerText = 'Run Import'; }
    }

    // --- UNINDEXED IMAGES ---
    function openUnindexedReview(countyId, stateName, countyName) {
        closeAllModals();
        document.getElementById('currentReviewCountyId').value = countyId;
        document.getElementById('scanPathInput').value = `data/${stateName}/${countyName}/Images`;
        document.getElementById('unindexedTableBody').innerHTML = '';
        document.getElementById('unindexedImagePreview').style.display = 'none';
        document.getElementById('noImageMsg').style.display = 'block';
        if(unindexedReviewModal) unindexedReviewModal.show();
        loadUnindexedTable(countyId);
    }
    
    function closeUnindexedModal() { if(unindexedReviewModal) unindexedReviewModal.hide(); }

    function scanForUnindexed() {
        const cid = document.getElementById('currentReviewCountyId').value;
        document.getElementById('globalLoader').style.display = 'flex';
        fetch('/api/edata/scan-unindexed', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ county_id: cid, scan_path: document.getElementById('scanPathInput').value, check_split: document.getElementById('scanSplitToggle').checked })
        }).then(r=>r.json()).then(d => {
            document.getElementById('globalLoader').style.display = 'none';
            if(d.success) loadUnindexedTable(cid); else showNotification(d.message);
        });
    }
    function loadUnindexedTable(cid) {
        fetch(`/api/edata/unindexed-list/${cid}`).then(r=>r.json()).then(data => {
            const b = document.getElementById('unindexedTableBody'); b.innerHTML = '';
            data.forEach(img => {
                const tr = document.createElement('tr');
                tr.onclick = () => { document.getElementById('unindexedImagePreview').src = `/api/edata/view-image/${img.id}?t=${Date.now()}`; document.getElementById('unindexedImagePreview').style.display='block'; document.getElementById('noImageMsg').style.display='none'; };
                tr.innerHTML = `<td class="ps-3 text-truncate" style="max-width:200px" title="${img.path}">${img.display_name}</td><td class="text-center">${img.require_indexing}</td>`;
                b.appendChild(tr);
            });
        });
    }

    // --- SCAN EDATA ERRORS ---
    function openEdataErrorsModal(id) {
        closeAllModals();
        document.getElementById('eDataCountyId').value = id; 
        if(edataErrorsModal) edataErrorsModal.show();
        fetch(`/api/tools/edata-errors/get-defaults/${id}`).then(r=>r.json()).then(d=>{
            if(d.success) {
                document.getElementById('edeBookStart').value = d.book_start;
                document.getElementById('edeBookEnd').value = d.book_end;
                document.getElementById('edeTownships').value = d.townships;
            }
        });
    }
    function runEdataErrors() {
        const id = document.getElementById('eDataCountyId').value;
        const btn = document.getElementById('btnRunEde'); btn.disabled=true;
        
        // Reset
        document.getElementById('edeProgressContainer').classList.remove('d-none');
        document.getElementById('edeProgressBar').style.width = '0%';
        document.getElementById('edeProgressPercent').innerText = '0%';

        fetch('/api/tools/edata-errors/execute', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
            county_id: id,
            book_start: document.getElementById('edeBookStart').value,
            book_end: document.getElementById('edeBookEnd').value,
            townships: document.getElementById('edeTownships').value,
            split_images: document.getElementById('edeSplitImages').checked
        })}).then(response => {
            const reader = response.body.getReader(); const decoder = new TextDecoder();
            function read() { 
                reader.read().then(({ done, value }) => {
                    if (done) { 
                        btn.disabled = false; 
                        document.getElementById('edeResult').innerText = "Done";
                        document.getElementById('edeProgressBar').style.width = '100%'; 
                        return; 
                    }
                    const lines = decoder.decode(value).split('\n');
                    lines.forEach(l => {
                        try { 
                            const d = JSON.parse(l);
                            if(d.type === 'progress') {
                                document.getElementById('edeProgressBar').style.width = d.percent + '%';
                                document.getElementById('edeProgressPercent').innerText = d.percent + '%'; // FIX
                            }
                        } catch(e){}
                    });
                    read();
                }); 
            } 
            read();
        });
    }

    // --- IMPORT EDATA ERRORS ---
    var currentImportEdeCountyId = null; 
    
    function openImportEDataErrorsModal(passedId) {
        closeAllModals(); currentImportEdeCountyId = passedId;
        if(importEdeModal) importEdeModal.show();
        
        // Reset UI
        document.getElementById('importEdeResult').innerText = '';
        document.getElementById('importEdeProgressContainer').classList.add('d-none');
        
        const debug = document.getElementById('debugModeToggle') && document.getElementById('debugModeToggle').checked;
        if(debug) document.getElementById('importEdeDebugPanel').classList.remove('d-none');
        
        fetch('/api/tools/import-edata-errors/init', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ county_id: passedId })})
        .then(r => r.json()).then(d => {
            if(d.success) {
                document.getElementById('importEdeDisplayPath').innerText = d.path;
                document.getElementById('importEdeFileCount').innerText = d.file_count + " files";
                const btn = document.getElementById('btnRunImportEde');
                btn.disabled = (d.file_count === 0);
                if(d.file_count === 0) document.getElementById('importEdeResult').innerText = "No .csv files found in folder.";
            }
        });
    }

    function runImportEDataErrors() {
        const btn = document.getElementById('btnRunImportEde'); btn.disabled = true;
        document.getElementById('importEdeProgressContainer').classList.remove('d-none');
        
        const pBar = document.getElementById('importEdeProgressBar');
        const pText = document.getElementById('importEdeProgressText');
        const logBox = document.getElementById('importEdeLogContent');

        // Reset
        pBar.style.width = '0%';
        pText.innerText = '0%';
        if(logBox) logBox.innerHTML = '';

        const debug = document.getElementById('debugModeToggle') && document.getElementById('debugModeToggle').checked;
        fetch('/api/tools/import-edata-errors/execute', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ county_id: currentImportEdeCountyId, debug: debug })})
        .then(response => {
            const reader = response.body.getReader(); const decoder = new TextDecoder();
            let hasProgress = false;

            function read() { reader.read().then(({ done, value }) => {
                if (done) { 
                    btn.disabled = false; 
                    if(!hasProgress) {
                        pBar.style.width = '100%';
                        pText.innerText = '100%';
                        document.getElementById('importEdeResult').innerText = "Completed (Instant)";
                    }
                    return; 
                }
                const lines = decoder.decode(value).split('\n');
                lines.forEach(l => {
                    try { const d = JSON.parse(l); 
                        if(d.type==='progress') {
                            hasProgress = true;
                            pBar.style.width = d.percent + '%';
                            pText.innerText = d.percent + '%'; // FIX
                        }
                        if(d.type==='log' && logBox) { const div = document.createElement('div'); div.innerText = d.message; logBox.appendChild(div); }
                        if(d.type==='complete') {
                            pBar.style.width = '100%';
                            pBar.classList.add('bg-success');
                            pText.innerText = '100%';
                            document.getElementById('importEdeResult').innerText = "Done";
                        }
                    } catch(e){}
                });
                read();
            }); } read();
        });
    }
</script>