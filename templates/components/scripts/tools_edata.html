<script>
    // ==========================================
    // 2. EDATA TOOLS
    // ==========================================

    // --- UNINDEXED IMAGES ---
    function openUnindexedReview(countyId, stateName, countyName) {
        closeAllModals();
        document.getElementById('currentReviewCountyId').value = countyId;
        document.getElementById('scanPathInput').value = `data/${stateName}/${countyName}/Images`;
        document.getElementById('unindexedTableBody').innerHTML = '';
        document.getElementById('unindexedImagePreview').style.display = 'none';
        document.getElementById('noImageMsg').style.display = 'block';
        if(unindexedReviewModal) unindexedReviewModal.show();
        loadUnindexedTable(countyId);
    }
    function scanForUnindexed() {
        const cid = document.getElementById('currentReviewCountyId').value;
        document.getElementById('globalLoader').style.display = 'flex';
        fetch('/api/edata/scan-unindexed', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ county_id: cid, scan_path: document.getElementById('scanPathInput').value, check_split: document.getElementById('scanSplitToggle').checked })
        }).then(r=>r.json()).then(d => {
            document.getElementById('globalLoader').style.display = 'none';
            if(d.success) loadUnindexedTable(cid); else showNotification(d.message);
        });
    }
    function loadUnindexedTable(cid) {
        fetch(`/api/edata/unindexed-list/${cid}`).then(r=>r.json()).then(data => {
            const b = document.getElementById('unindexedTableBody'); b.innerHTML = '';
            data.forEach(img => {
                const tr = document.createElement('tr');
                tr.onclick = () => { document.getElementById('unindexedImagePreview').src = `/api/edata/view-image/${img.id}?t=${Date.now()}`; document.getElementById('unindexedImagePreview').style.display='block'; document.getElementById('noImageMsg').style.display='none'; };
                tr.innerHTML = `<td class="ps-3 text-truncate" style="max-width:200px" title="${img.path}">${img.display_name}</td><td class="text-center">${img.require_indexing}</td>`;
                b.appendChild(tr);
            });
        });
    }

    // --- SCAN EDATA ERRORS ---
    function openEdataErrorsModal(id) {
        closeAllModals();
        document.getElementById('eDataCountyId').value = id; 
        if(edataErrorsModal) edataErrorsModal.show();
        fetch(`/api/tools/edata-errors/get-defaults/${id}`).then(r=>r.json()).then(d=>{
            if(d.success) {
                document.getElementById('edeBookStart').value = d.book_start;
                document.getElementById('edeBookEnd').value = d.book_end;
                document.getElementById('edeTownships').value = d.townships;
            }
        });
    }
    function runEdataErrors() {
        const id = document.getElementById('eDataCountyId').value;
        const btn = document.getElementById('btnRunEde'); btn.disabled=true;
        document.getElementById('edeProgressContainer').classList.remove('d-none');
        fetch('/api/tools/edata-errors/execute', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
            county_id: id,
            book_start: document.getElementById('edeBookStart').value,
            book_end: document.getElementById('edeBookEnd').value,
            townships: document.getElementById('edeTownships').value,
            split_images: document.getElementById('edeSplitImages').checked
        })}).then(r => { btn.disabled=false; document.getElementById('edeResult').innerText = "Done"; });
    }

    // --- IMPORT EDATA ERRORS ---
    let currentImportEdeCountyId = null;
    function openImportEDataErrorsModal(passedId) {
        closeAllModals(); currentImportEdeCountyId = passedId;
        if(importEdeModal) importEdeModal.show();
        const debug = document.getElementById('debugModeToggle') && document.getElementById('debugModeToggle').checked;
        if(debug) document.getElementById('importEdeDebugPanel').classList.remove('d-none');
        
        fetch('/api/tools/import-edata-errors/init', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ county_id: passedId })})
        .then(r => r.json()).then(d => {
            if(d.success) {
                document.getElementById('importEdeDisplayPath').innerText = d.path;
                document.getElementById('importEdeFileCount').innerText = d.file_count + " files";
                document.getElementById('btnRunImportEde').disabled = (d.file_count === 0);
            }
        });
    }
    function runImportEDataErrors() {
        const btn = document.getElementById('btnRunImportEde'); btn.disabled = true;
        document.getElementById('importEdeProgressContainer').classList.remove('d-none');
        const debug = document.getElementById('debugModeToggle') && document.getElementById('debugModeToggle').checked;
        fetch('/api/tools/import-edata-errors/execute', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ county_id: currentImportEdeCountyId, debug: debug })})
        .then(response => {
            const reader = response.body.getReader(); const decoder = new TextDecoder();
            const logBox = document.getElementById('importEdeLogContent');
            function read() { reader.read().then(({ done, value }) => {
                if (done) { btn.disabled = false; return; }
                const lines = decoder.decode(value).split('\n');
                lines.forEach(l => {
                    try { const d = JSON.parse(l); 
                        if(d.type==='progress') document.getElementById('importEdeProgressBar').style.width = d.percent + '%';
                        if(d.type==='log' && logBox) { const div = document.createElement('div'); div.innerText = d.message; logBox.appendChild(div); }
                        if(d.type==='complete') document.getElementById('importEdeResult').innerText = "Done";
                    } catch(e){}
                });
                read();
            }); } read();
        });
    }
</script>