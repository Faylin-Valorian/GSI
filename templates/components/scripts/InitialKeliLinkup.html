<script>
    let currentLinkupCountyId = null;
    let linkupMgr = null;

    function openLinkupModal(id, name) {
        closeAllModals(); currentLinkupCountyId = id;
        document.getElementById('linkupCountyName').innerText = name;
        
        // UI Toggles
        const bookToggle = document.getElementById('linkupToggleBook');
        const pathToggle = document.getElementById('linkupTogglePath');
        bookToggle.onchange = () => document.getElementById('linkupBookContainer').classList.toggle('d-none', !bookToggle.checked);
        pathToggle.onchange = () => document.getElementById('linkupImgPath').classList.toggle('d-none', !pathToggle.checked);

        if(!linkupMgr) {
            linkupMgr = new PreviewManager({
                prefix: 'linkup',
                apiPreview: '/api/tools/initial-keli-linkup/preview',
                apiDownload: '/api/tools/initial-keli-linkup/download-sql',
                filename: 'Keli_Linkup.sql',
                payloadProvider: () => ({
                    county_id: currentLinkupCountyId,
                    use_book_range: document.getElementById('linkupToggleBook').checked,
                    book_start: document.getElementById('linkupBookStart').value,
                    book_end: document.getElementById('linkupBookEnd').value,
                    use_path: document.getElementById('linkupTogglePath').checked,
                    image_path_prefix: document.getElementById('linkupImgPath').value,
                    split_images: document.getElementById('linkupSplitImages').checked,
                    linkup_mode: document.querySelector('input[name="linkupMode"]:checked').value
                })
            });
        }
        linkupMgr.reset();
        
        if(typeof updateAllToolsDebug === 'function') updateAllToolsDebug();
        if(linkupModal) linkupModal.show();
    }

    function closeLinkupModal() { if(linkupModal) linkupModal.hide(); }

    function runLinkupTool() {
        const btn = document.querySelector('#linkupModal .btn-warning');
        const res = document.getElementById('linkupResult');
        btn.disabled = true; res.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
        
        if(linkupMgr) linkupMgr.reset();
        
        const payload = linkupMgr.payloadProvider(); // Reuse payload logic
        
        fetch('/api/tools/initial-keli-linkup/run', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
        }).then(r => r.json()).then(d => {
            btn.disabled = false;
            if(d.success) res.innerHTML = `<div class="alert alert-success">${d.message}</div>`;
            else res.innerHTML = `<div class="alert alert-danger">${d.message}</div>`;
        }).catch(e => { btn.disabled = false; res.innerHTML = `<div class="alert alert-danger">Error: ${e}</div>`; });
    }
</script>