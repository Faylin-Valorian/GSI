<script>
    // ==========================================
    // DB TOOLS SCRIPTS (Maintenance & Updates)
    // ==========================================

    // --- ALTER DB FIELDS TOOL ---
    function openAlterDbModal() {
        closeAllModals();
        
        // 1. Reset UI
        document.getElementById('alterDbStatusMsg').innerText = 'Ready';
        document.getElementById('btnRunAlterDb').disabled = true;
        document.getElementById('alterDbSqlPreview').innerText = '-- Click \'Generate SQL Preview\' to analyze the database state...';
        document.getElementById('alterDbLoader').classList.add('d-none');
        
        // 2. Check Global Debug State & Update Button Visibility
        // This relies on the global function in tools_edata.html, but we also manually check here to be safe
        const toggle = document.getElementById('debugModeToggle');
        const btn = document.getElementById('btnAlterDbPreview');
        if (toggle && btn) {
            if (toggle.checked) btn.classList.remove('d-none');
            else btn.classList.add('d-none');
        }

        // 3. Show Modal
        if(alterDbModal) alterDbModal.show();
    }

    function previewAlterDb() {
        const btn = document.getElementById('btnAlterDbPreview');
        const previewBox = document.getElementById('alterDbSqlPreview');
        const loader = document.getElementById('alterDbLoader');
        
        btn.disabled = true;
        loader.classList.remove('d-none');
        previewBox.innerText = '-- Generating Preview...';

        fetch('/api/tools/alter-db/preview', {
            method: 'POST', headers: {'Content-Type': 'application/json'}
        })
        .then(r => r.json())
        .then(d => {
            loader.classList.add('d-none');
            btn.disabled = false;
            if(d.success) {
                previewBox.innerText = d.sql;
                // Enable run button if there are valid changes
                document.getElementById('btnRunAlterDb').disabled = false;
                document.getElementById('alterDbStatusMsg').innerHTML = `<span class="text-success"><i class="bi bi-check-circle me-1"></i>Plan Generated</span>`;
            } else {
                previewBox.innerText = '-- Error: ' + d.message;
                document.getElementById('alterDbStatusMsg').innerText = 'Error generating plan';
            }
        })
        .catch(e => {
            loader.classList.add('d-none');
            btn.disabled = false;
            previewBox.innerText = '-- Connection Error: ' + e;
        });
    }

    function copyAlterDbSql() {
        const text = document.getElementById('alterDbSqlPreview').innerText;
        navigator.clipboard.writeText(text);
        showNotification('SQL copied to clipboard');
    }

    function runAlterDbMigration() {
        const btn = document.getElementById('btnRunAlterDb');
        const status = document.getElementById('alterDbStatusMsg');
        btn.disabled = true;
        status.innerHTML = '<span class="text-warning"><i class="spinner-border spinner-border-sm me-1"></i>Executing...</span>';

        fetch('/api/tools/alter-db/execute', {
            method: 'POST', headers: {'Content-Type': 'application/json'}
        })
        .then(r => r.json())
        .then(d => {
            btn.disabled = false;
            if(d.success) {
                status.innerHTML = `<span class="text-success fw-bold"><i class="bi bi-check-lg me-1"></i>Success!</span>`;
                document.getElementById('alterDbSqlPreview').innerText += '\n\n-- EXECUTION COMPLETE: ' + d.message;
            } else {
                status.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle me-1"></i>Failed</span>`;
                document.getElementById('alterDbSqlPreview').innerText += '\n\n-- ERROR: ' + d.message;
            }
        })
        .catch(e => {
            btn.disabled = false;
            status.innerText = 'Connection Error';
        });
    }

    // --- OTHER DB TOOLS (Stubs for existing functions) ---
    function openProceduresModal() { closeAllModals(); if(proceduresModal) proceduresModal.show(); }
    function closeProceduresModal() { if(proceduresModal) proceduresModal.hide(); }
    
    function openDbCompatModal() { closeAllModals(); if(dbCompatModal) dbCompatModal.show(); }
    function closeDbCompatModal() { if(dbCompatModal) dbCompatModal.hide(); }

    function openPatchModal() { closeAllModals(); if(patchModal) patchModal.show(); }
    function closePatchModal() { if(patchModal) patchModal.hide(); }

    function openDriveModal() { closeAllModals(); if(driveModal) driveModal.show(); }
    function closeDriveModal() { if(driveModal) driveModal.hide(); }
</script>