<script>
    // ==========================================
    // 4. DATABASE TOOLS (Drive, Compat, Proc, Alter)
    // ==========================================
    
    // --- DRIVE CONNECTION ---
    function openDriveModal() { 
        closeAllModals(); // Good practice to ensure no overlaps
        if(driveModal) driveModal.show(); 
    }
    
    function closeDriveModal() { 
        if(driveModal) driveModal.hide(); 
        document.getElementById('driveResult').innerHTML = ''; 
    }

    function submitDriveConnection() {
        const btn = document.querySelector('#driveModal .btn-primary');
        const resultDiv = document.getElementById('driveResult');
        btn.disabled = true; 
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Connecting...'; 
        resultDiv.innerHTML = '';

        const payload = {
            drive_letter: document.getElementById('driveLetter').value,
            network_path: document.getElementById('drivePath').value,
            username: document.getElementById('driveUser').value,
            password: document.getElementById('drivePass').value
        };

        fetch('/api/tools/connect-drive', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify(payload) 
        })
        .then(r => r.json()).then(d => {
            btn.disabled = false; 
            btn.innerHTML = '<i class="bi bi-plug-fill me-2"></i>Connect';
            if (d.success) {
                resultDiv.innerHTML = `<span class="text-success fw-bold"><i class="bi bi-check-circle me-2"></i>${d.message}</span>`;
                setTimeout(closeDriveModal, 2000);
            } else {
                resultDiv.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-circle me-2"></i>${d.message}</span>`;
            }
        }).catch(e => { 
            btn.disabled = false; 
            btn.innerHTML = '<i class="bi bi-plug-fill me-2"></i>Connect';
            resultDiv.innerHTML = `<span class="text-danger">Request Failed: ${e}</span>`; 
        });
    }

    // --- DB COMPATIBILITY ---
    function openDbCompatModal() { 
        closeAllModals(); 
        if(dbCompatModal) dbCompatModal.show(); 
    }
    
    function closeDbCompatModal() { 
        if(dbCompatModal) dbCompatModal.hide(); 
        document.getElementById('dbCompatResult').innerHTML = ''; 
        document.getElementById('targetCompatLevel').value = ''; 
    }
    
    function closeDowngradeModal() {
        if(dbDowngradeModal) dbDowngradeModal.hide();
        document.getElementById('dbCompatResult').innerHTML = `<div class="alert alert-secondary mt-2 mb-0 py-2">Action Cancelled</div>`;
    }

    function confirmDowngrade() {
        if(dbDowngradeModal) dbDowngradeModal.hide();
        submitDbCompat(true); 
    }

    function submitDbCompat(isConfirmed = false) {
        const btn = document.querySelector('#dbCompatModal .btn-info');
        const resultDiv = document.getElementById('dbCompatResult');
        const levelVal = document.getElementById('targetCompatLevel').value;
        
        if(!levelVal) { resultDiv.innerHTML = '<span class="text-warning">Please enter a value.</span>'; return; }

        btn.disabled = true; 
        if(!isConfirmed) btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Checking...';
        else btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Updating...';
        
        resultDiv.innerHTML = '';

        fetch('/api/tools/db-compatibility', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ target_level: levelVal, confirmed: isConfirmed }) 
        })
        .then(r => r.json())
        .then(d => {
            btn.disabled = false; btn.innerText = 'Update Level';
            
            if (d.success) { 
                resultDiv.innerHTML = `<div class="alert alert-success mt-2 mb-0 py-2"><i class="bi bi-check-circle me-2"></i>${d.message}</div>`; 
            } 
            else if (d.requires_confirmation) {
                document.getElementById('dbDowngradeMessage').innerText = d.message;
                if(dbDowngradeModal) dbDowngradeModal.show();
            }
            else { 
                resultDiv.innerHTML = `<div class="alert alert-warning mt-2 mb-0 py-2"><i class="bi bi-info-circle me-2"></i>${d.message}</div>`; 
            }
        }).catch(e => { 
            btn.disabled = false; btn.innerText = 'Update Level';
            resultDiv.innerHTML = `<div class="alert alert-danger mt-2 mb-0 py-2">Request Failed</div>`; 
        });
    }

    // --- PROCEDURES ---
    function openProceduresModal() { 
        closeAllModals(); 
        if(proceduresModal) proceduresModal.show(); 
    }
    
    function closeProceduresModal() { 
        if(proceduresModal) proceduresModal.hide(); 
        document.getElementById('proceduresResult').innerHTML = ''; 
    }
    
    function submitProcedures() {
        const btn = document.querySelector('#proceduresModal .btn-warning');
        const resultDiv = document.getElementById('proceduresResult');
        btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...'; resultDiv.innerHTML = '';

        fetch('/api/tools/setup-procedures', { method: 'POST' })
        .then(r => r.json()).then(d => {
            btn.disabled = false; btn.innerText = 'Yes, Execute';
            if (d.success) { resultDiv.innerHTML = `<div class="alert alert-success mt-3 mb-0 py-2"><i class="bi bi-check-circle me-2"></i>${d.message}</div>`; } 
            else { resultDiv.innerHTML = `<div class="alert alert-danger mt-3 mb-0 py-2"><i class="bi bi-exclamation-triangle me-2"></i>${d.message}</div>`; }
        }).catch(e => { btn.disabled = false; resultDiv.innerHTML = `<div class="alert alert-danger mt-3 mb-0 py-2">System Error</div>`; });
    }
    
    function openPatchModal() { 
        closeAllModals();
        if(patchModal) patchModal.show(); 
    }
    
    function closePatchModal() { 
        if(patchModal) patchModal.hide(); 
    }

// ==========================================
    // ALTER DATABASE FIELDS (Dynamic Tool)
    // ==========================================

    function openAlterDbModal() {
        closeAllModals();
        if(alterDbModal) alterDbModal.show();
        
        // 1. Reset UI
        document.getElementById('alterDbFieldsBody').innerHTML = '<tr><td colspan="4" class="text-center p-3 text-muted">Scanning Schema...</td></tr>';
        document.getElementById('alterDbAddBody').innerHTML = '';
        document.getElementById('alterDbPreviewContainer').classList.add('d-none');
        document.getElementById('alterDbStatus').innerText = 'Scanning Schema...';
        document.getElementById('btnAlterDbRun').disabled = true;

        // 2. Force Global Debug Check (ensures preview button visibility is correct)
        if(typeof updateToolDebugVisibility === 'function') updateToolDebugVisibility();

        // 3. Fetch Data (Schema + Config + Defaults)
        fetch('/api/tools/alter-db/init')
            .then(r => r.json())
            .then(d => {
                if(d.success) {
                    renderAlterDbFields(d.fields);
                    renderAlterDbAdds(d.new_fields);
                    document.getElementById('alterDbStatus').innerText = 'Ready';
                    document.getElementById('btnAlterDbRun').disabled = false;
                } else {
                    document.getElementById('alterDbFieldsBody').innerHTML = `<tr><td colspan="4" class="text-center text-danger p-3">Error: ${d.error || d.message}</td></tr>`;
                }
            })
            .catch(e => {
                document.getElementById('alterDbStatus').innerText = 'Connection Error';
            });
    }

    function renderAlterDbFields(fields) {
        const tbody = document.getElementById('alterDbFieldsBody');
        tbody.innerHTML = '';
        
        fields.forEach(f => {
            const tr = document.createElement('tr');
            // Highlight row if renamed
            const isRenamed = f.original !== f.current;
            if(isRenamed) tr.classList.add('table-dark'); 

            tr.innerHTML = `
                <td class="ps-4 font-monospace small text-muted">${f.original}</td>
                <td class="text-center text-muted"><i class="bi bi-arrow-right"></i></td>
                <td>
                    <input type="text" class="form-control form-control-sm bg-black text-light border-secondary font-monospace field-rename-input" 
                           data-original="${f.original}" value="${f.current}" 
                           oninput="this.classList.add('border-warning')">
                </td>
                <td class="small text-muted fst-italic">${f.type}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderAlterDbAdds(newFields) {
        const tbody = document.getElementById('alterDbAddBody');
        tbody.innerHTML = '';
        
        newFields.forEach(f => {
            alterDbAddNewRow(f.name, f.type, f.default);
        });
    }

    function alterDbAddNewRow(name='', type='VARCHAR(255)', def='') {
        const tbody = document.getElementById('alterDbAddBody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="ps-4"><input type="text" class="form-control form-control-sm bg-black text-light border-secondary input-name" value="${name}" placeholder="Column Name"></td>
            <td><input type="text" class="form-control form-control-sm bg-black text-info border-secondary input-type" value="${type}" placeholder="Type"></td>
            <td><input type="text" class="form-control form-control-sm bg-black text-muted border-secondary input-default" value="${def}" placeholder="NULL"></td>
            <td class="text-end pe-4"><button class="btn btn-sm btn-outline-danger border-0" onclick="this.closest('tr').remove()"><i class="bi bi-trash"></i></button></td>
        `;
        tbody.appendChild(tr);
    }

    function alterDbCollectData() {
        // 1. Collect Renames
        let renames = {};
        document.querySelectorAll('.field-rename-input').forEach(input => {
            renames[input.dataset.original] = input.value.trim();
        });

        // 2. Collect Adds
        let newFields = [];
        document.querySelectorAll('#alterDbAddBody tr').forEach(tr => {
            const name = tr.querySelector('.input-name').value.trim();
            if(name) {
                newFields.push({
                    name: name,
                    type: tr.querySelector('.input-type').value.trim(),
                    default: tr.querySelector('.input-default').value.trim()
                });
            }
        });

        return { renames, new_fields: newFields };
    }

    function alterDbGeneratePreview() {
        const payload = alterDbCollectData();
        const container = document.getElementById('alterDbPreviewContainer');
        const output = document.getElementById('alterDbSqlOutput');
        
        output.innerText = 'Generating...';
        container.classList.remove('d-none');

        fetch('/api/tools/alter-db/preview', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(d => {
            if(d.success) output.innerText = d.sql;
            else output.innerText = "Error: " + d.message;
        });
    }

    function alterDbRun() {
        const payload = alterDbCollectData();
        const btn = document.getElementById('btnAlterDbRun');
        btn.disabled = true;
        document.getElementById('alterDbStatus').innerHTML = '<span class="text-warning spinner-border spinner-border-sm"></span> Processing...';

        fetch('/api/tools/alter-db/execute', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(d => {
            btn.disabled = false;
            if(d.success) {
                document.getElementById('alterDbStatus').innerHTML = '<span class="text-success fw-bold">Success! Reloading schema...</span>';
                setTimeout(openAlterDbModal, 1500); // Reload tool to show updated schema
            } else {
                document.getElementById('alterDbStatus').innerHTML = `<span class="text-danger">Error: ${d.message}</span>`;
            }
        })
        .catch(e => {
            btn.disabled = false;
            document.getElementById('alterDbStatus').innerText = 'Connection Failed';
        });
    }
    
    function copyAlterDbSql() {
        const text = document.getElementById('alterDbSqlOutput').innerText;
        navigator.clipboard.writeText(text);
    }
</script>