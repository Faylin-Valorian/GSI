<script>
/**
 * Universal Image Manager
 * Refactored: Fit-Width, Overlay Thumbnails, Click-and-Hold Panning, and Active Toggle Button.
 */
if (typeof window.ImageManager === 'undefined') {
    window.ImageManager = class {
        constructor(config) {
            this.prefix = config.prefix;
            this.apiEndpoint = config.apiEndpoint;
            this.onSelectCallback = config.onSelect || null;
            
            // State
            this.images = [];
            this.currentIndex = -1;
            this.zoomLevel = 1.0; 

            // Bind Elements
            this.viewport = document.getElementById(`${this.prefix}ImageViewport`);
            this.mainImg = document.getElementById(`${this.prefix}MainImage`);
            this.strip = document.getElementById(`${this.prefix}ThumbnailStrip`);
            this.lblCount = document.getElementById(`${this.prefix}ImageCount`);
            this.lblName = document.getElementById(`${this.prefix}ImageName`);
            this.loader = document.getElementById(`${this.prefix}Loading`);
            this.noImage = document.getElementById(`${this.prefix}NoImage`);

            // Controls
            document.getElementById(`${this.prefix}BtnPrev`).onclick = () => this.prev();
            document.getElementById(`${this.prefix}BtnNext`).onclick = () => this.next();
            document.getElementById(`${this.prefix}BtnZoomIn`).onclick = () => this.zoom(0.2);
            document.getElementById(`${this.prefix}BtnZoomOut`).onclick = () => this.zoom(-0.2);
            document.getElementById(`${this.prefix}BtnReset`).onclick = () => this.resetZoom();
            
            const btnToggle = document.getElementById(`${this.prefix}BtnToggleThumbs`);
            if(btnToggle) btnToggle.onclick = () => this.toggleThumbnails();

            // Keyboard Nav
            this.viewport.tabIndex = 0;
            this.viewport.onkeydown = (e) => {
                if(e.key === 'ArrowRight') this.next();
                if(e.key === 'ArrowLeft') this.prev();
            };

            // --- DRAG TO PAN LOGIC ---
            this.isDown = false;
            this.startX = 0;
            this.startY = 0;
            this.scrollLeft = 0;
            this.scrollTop = 0;
            
            this.viewport.style.cursor = 'grab';

            this.viewport.addEventListener('mousedown', (e) => {
                e.preventDefault();
                this.isDown = true;
                this.viewport.style.cursor = 'grabbing';
                this.startX = e.pageX - this.viewport.offsetLeft;
                this.startY = e.pageY - this.viewport.offsetTop;
                this.scrollLeft = this.viewport.scrollLeft;
                this.scrollTop = this.viewport.scrollTop;
            });

            this.viewport.addEventListener('mouseleave', () => {
                this.isDown = false;
                this.viewport.style.cursor = 'grab';
            });

            this.viewport.addEventListener('mouseup', () => {
                this.isDown = false;
                this.viewport.style.cursor = 'grab';
            });

            this.viewport.addEventListener('mousemove', (e) => {
                if (!this.isDown) return;
                e.preventDefault();
                const x = e.pageX - this.viewport.offsetLeft;
                const y = e.pageY - this.viewport.offsetTop;
                const walkX = (x - this.startX); 
                const walkY = (y - this.startY);
                this.viewport.scrollLeft = this.scrollLeft - walkX;
                this.viewport.scrollTop = this.scrollTop - walkY;
            });
        }

        // [CHANGED] Update Button State logic
        toggleThumbnails() {
            const btn = document.getElementById(`${this.prefix}BtnToggleThumbs`);
            
            if(this.strip.classList.contains('d-none')) {
                // Showing Thumbnails
                this.strip.classList.remove('d-none');
                if(btn) {
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-light'); // Light up
                }
            } else {
                // Hiding Thumbnails
                this.strip.classList.add('d-none');
                if(btn) {
                    btn.classList.remove('btn-light'); // Dim
                    btn.classList.add('btn-outline-secondary');
                }
            }
        }

        load(payload) {
            this.resetUI();
            this.loader.classList.remove('d-none');
            this.noImage.classList.add('d-none');

            fetch(this.apiEndpoint, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(d => {
                this.loader.classList.add('d-none');
                if (d.success && d.images && d.images.length > 0) {
                    this.images = d.images;
                    this.renderThumbnails();
                    this.select(0);
                } else {
                    this.noImage.innerText = d.message || "No images found.";
                    this.noImage.classList.remove('d-none');
                }
            })
            .catch(e => {
                this.loader.classList.add('d-none');
                this.noImage.innerText = "Error loading images.";
                this.noImage.classList.remove('d-none');
                console.error(e);
            });
        }

        renderThumbnails() {
            this.strip.innerHTML = '';
            this.images.forEach((img, idx) => {
                const t = document.createElement('img');
                t.src = img.src;
                t.className = 'h-100 border border-secondary opacity-50 shadow-sm';
                t.style.cursor = 'pointer';
                t.style.pointerEvents = 'auto'; // Re-enable clicks
                
                t.onclick = () => this.select(idx);
                t.id = `${this.prefix}Thumb_${idx}`;
                this.strip.appendChild(t);
            });
        }

        select(index) {
            if (index < 0 || index >= this.images.length) return;
            this.currentIndex = index;
            const imgData = this.images[index];

            this.mainImg.src = imgData.src;
            this.mainImg.style.display = 'block';
            
            this.resetZoom();
            this.viewport.scrollTop = 0; 
            this.viewport.scrollLeft = 0;

            this.lblCount.innerText = `${index + 1} / ${this.images.length}`;
            this.lblName.innerText = imgData.name || 'Image';

            [...this.strip.children].forEach((c, i) => {
                if(i === index) {
                    c.classList.remove('opacity-50', 'border-secondary');
                    c.classList.add('opacity-100', 'border-warning');
                    c.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                    c.classList.add('opacity-50', 'border-secondary');
                    c.classList.remove('opacity-100', 'border-warning');
                }
            });

            if(this.onSelectCallback) {
                this.onSelectCallback(imgData, index);
            }
        }

        next() { this.select(this.currentIndex + 1); }
        prev() { this.select(this.currentIndex - 1); }

        resetUI() {
            this.images = [];
            this.currentIndex = -1;
            this.mainImg.src = '';
            this.mainImg.style.display = 'none';
            this.strip.innerHTML = '';
            this.lblCount.innerText = '0 / 0';
            this.lblName.innerText = '---';
        }

        zoom(amount) {
            this.zoomLevel += amount;
            if (this.zoomLevel < 0.1) this.zoomLevel = 0.1;
            this.updateTransform();
        }
        resetZoom() {
            this.zoomLevel = 1.0;
            this.updateTransform();
        }
        updateTransform() {
            this.mainImg.style.width = `${this.zoomLevel * 100}%`;
        }
    };
}
</script>