<script>
    // ==========================================
    // 2. WINDOW MANAGER (Helpers Only)
    // ==========================================
    
    // Note: Modals are now initialized in admin_core.html to prevent crashes.
    // This file only handles generic window actions.

    function closeAllModals() {
        // Fallback list of known modals to hide
        // These variables are global (defined in admin_core.html)
        const all = [
            typeof seedConfirmModal !== 'undefined' ? seedConfirmModal : null,
            typeof seedSuccessModal !== 'undefined' ? seedSuccessModal : null,
            typeof statesModal !== 'undefined' ? statesModal : null,
            typeof countiesModal !== 'undefined' ? countiesModal : null,
            typeof accountsModal !== 'undefined' ? accountsModal : null,
            typeof userEditModal !== 'undefined' ? userEditModal : null,
            typeof driveModal !== 'undefined' ? driveModal : null,
            typeof dbCompatModal !== 'undefined' ? dbCompatModal : null,
            typeof proceduresModal !== 'undefined' ? proceduresModal : null,
            typeof eDataModal !== 'undefined' ? eDataModal : null,
            typeof keliModal !== 'undefined' ? keliModal : null,
            typeof dbDowngradeModal !== 'undefined' ? dbDowngradeModal : null,
            typeof codeViewerModal !== 'undefined' ? codeViewerModal : null,
            typeof notificationModal !== 'undefined' ? notificationModal : null,
            typeof confirmationModal !== 'undefined' ? confirmationModal : null,
            typeof adminAuthModal !== 'undefined' ? adminAuthModal : null,
            typeof unindexedReviewModal !== 'undefined' ? unindexedReviewModal : null,
            typeof patchModal !== 'undefined' ? patchModal : null,
            typeof cleanupModal !== 'undefined' ? cleanupModal : null,
            typeof initialPrepModal !== 'undefined' ? initialPrepModal : null,
            typeof alterDbModal !== 'undefined' ? alterDbModal : null,
            typeof instCorrectionModal !== 'undefined' ? instCorrectionModal : null,
            typeof linkupModal !== 'undefined' ? linkupModal : null,
            typeof edataErrorsModal !== 'undefined' ? edataErrorsModal : null,
            typeof importEdeModal !== 'undefined' ? importEdeModal : null
        ];

        all.forEach(m => { 
            if(m && typeof m.hide === 'function') m.hide(); 
        });
        
        // Force cleanup of backdrops
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style = '';
    }

    // --- CONFIRMATION & NOTIFICATION ---
    let pendingConfirmationAction = null;

    // Use a getter to safely find the modal even if initialized later
    function getConfirmationModal() {
        if (typeof confirmationModal !== 'undefined' && confirmationModal) return confirmationModal;
        const el = document.getElementById('confirmationModal');
        return el ? new bootstrap.Modal(el) : null;
    }

    function getNotificationModal() {
        if (typeof notificationModal !== 'undefined' && notificationModal) return notificationModal;
        const el = document.getElementById('notificationModal');
        return el ? new bootstrap.Modal(el) : null;
    }

    function showConfirmation(message, actionCallback) {
        document.getElementById('confirmationMessage').innerText = message;
        pendingConfirmationAction = actionCallback; 
        const m = getConfirmationModal();
        if(m) m.show();
    }

    function executeConfirmation() {
        if (pendingConfirmationAction) {
            pendingConfirmationAction(); 
            pendingConfirmationAction = null; 
        }
        const m = getConfirmationModal();
        if(m) m.hide();
    }

    function closeConfirmationModal() {
        pendingConfirmationAction = null;
        const m = getConfirmationModal();
        if(m) m.hide();
    }

    function showNotification(message) {
        const el = document.getElementById('notificationMessage');
        if(el) el.innerText = message;
        const m = getNotificationModal();
        if(m) m.show();
    }
</script>