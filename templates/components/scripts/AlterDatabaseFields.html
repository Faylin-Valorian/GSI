<script>
    let alterDbMgr = null;

    function openAlterDbModal() { 
        closeAlterDbModal(); 
        if(typeof updateAllToolsDebug === 'function') updateAllToolsDebug();
        
        if(!alterDbMgr) {
            alterDbMgr = new PreviewManager({
                prefix: 'alterDb',
                apiPreview: '/api/tools/alter-db/preview',
                apiDownload: '/api/tools/alter-db/download-sql',
                filename: 'Schema_Update.sql',
                payloadProvider: alterDbCollectData
            });
        }
        alterDbMgr.reset();
        
        if(alterDbModal) alterDbModal.show(); 
    }

    function closeAlterDbModal() { if(alterDbModal) alterDbModal.hide(); }

    function alterDbCollectData() {
        const renames = {};
        document.querySelectorAll('.rename-input').forEach(input => {
            const original = input.dataset.original;
            const newVal = input.value.trim();
            if (newVal && newVal !== original) renames[original] = newVal;
        });
        const newFields = [];
        document.querySelectorAll('#alterDbAddBody tr').forEach(row => {
            const name = row.querySelector('.new-field-name').value.trim();
            const type = row.querySelector('.new-field-type').value;
            if (name) newFields.push({ name: name, type: type });
        });
        return { renames: renames, new_fields: newFields };
    }

    function alterDbRun() {
        const payload = alterDbCollectData();
        if (Object.keys(payload.renames).length === 0 && payload.new_fields.length === 0) {
            alert("No changes to apply."); return;
        }
        if (!confirm("Are you sure? This will modify the database schema.")) return;

        const btn = document.querySelector('#alterDbModal .btn-info');
        const status = document.createElement('div'); status.id = 'alterDbRunStatus';
        document.querySelector('.modal-body').appendChild(status);
        btn.disabled = true; btn.innerText = "Applying...";

        if(alterDbMgr) alterDbMgr.reset();

        fetch('/api/tools/alter-db/run', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) })
        .then(r => r.json()).then(d => {
            btn.disabled = false; btn.innerText = "Apply Changes";
            if (d.success) { alert("Success! Schema updated."); closeAlterDbModal(); } 
            else { alert("Error: " + d.message); }
        }).catch(e => { btn.disabled = false; alert("Connection Error"); });
    }

    // --- FIX: Add Aliases for Backward Compatibility ---
    window.openAlterDbTool = openAlterDbModal;
</script>