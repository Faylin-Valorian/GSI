<script>
    // Global variable, but we don't rely on it being set at load time anymore
    var patchModalInstance = null;

    function getPatchModal() {
        // 1. If we already have the instance, return it
        if (patchModalInstance) return patchModalInstance;

        // 2. Try to find the element
        const el = document.getElementById('patchModal');
        if (!el) {
            console.error("CRITICAL ERROR: element #patchModal not found in DOM.");
            alert("System Error: The Patch Manager HTML is missing from the page. Please ensure modals.html is included.");
            return null;
        }

        // 3. Create the Bootstrap instance
        try {
            patchModalInstance = new bootstrap.Modal(el);
            return patchModalInstance;
        } catch (e) {
            console.error("Bootstrap Error:", e);
            alert("System Error: Could not initialize Bootstrap modal.");
            return null;
        }
    }

    function openPatchModal() {
        // 1. Check Debug Mode
        const debugToggle = document.getElementById('debugModeToggle');
        if (!debugToggle || !debugToggle.checked) {
            showNotification("Debug Mode must be enabled to access System Updater.", "error");
            return;
        }

        // 2. Get (or create) the Modal Instance
        const modal = getPatchModal();
        if (!modal) return; // Error already alerted in getPatchModal

        // 3. Fetch Version info
        fetch('/api/admin/version')
            .then(r => r.json())
            .then(d => {
                const badge = document.getElementById('currentVersionBadge');
                if(d.version && badge) badge.innerText = 'v' + d.version;
            })
            .catch(e => console.log("Ver Check Fail", e));

        // 4. Open Modal
        if (typeof closeAllModals === 'function') closeAllModals();
        modal.show();
        
        // 5. Reset UI Safely
        const fileInput = document.getElementById('patchFileInput');
        const contentInput = document.getElementById('patchContentInput');
        const modeSwitch = document.getElementById('patchModeSwitch');
        const errorDiv = document.getElementById('patchError');
        const logDiv = document.getElementById('patchLogOutput');

        if(fileInput) fileInput.value = '';
        if(contentInput) contentInput.value = '';
        
        // Reset switch to "Upload" (or default)
        if(modeSwitch) {
            modeSwitch.checked = false; // Default to Text Paste
            togglePatchMode();
        }
        
        if(errorDiv) errorDiv.innerHTML = '';
        if(logDiv) {
            logDiv.classList.add('d-none');
            logDiv.innerText = '';
        }
    }

    function closePatchModal() {
        const modal = getPatchModal();
        if (modal) modal.hide();
    }

    function togglePatchMode() {
        const switchEl = document.getElementById('patchModeSwitch');
        if(!switchEl) return;

        const isUpload = switchEl.checked;
        const pasteCont = document.getElementById('pasteContainer');
        const uploadCont = document.getElementById('uploadContainer');
        
        if (isUpload) {
            if(pasteCont) pasteCont.classList.add('d-none');
            if(uploadCont) uploadCont.classList.remove('d-none');
        } else {
            if(pasteCont) pasteCont.classList.remove('d-none');
            if(uploadCont) uploadCont.classList.add('d-none');
        }
    }

    function submitPatchFile() {
        const switchEl = document.getElementById('patchModeSwitch');
        const isUpload = switchEl ? switchEl.checked : false;
        
        const fileInput = document.getElementById('patchFileInput');
        const contentInput = document.getElementById('patchContentInput');
        const errorDiv = document.getElementById('patchError');
        const logDiv = document.getElementById('patchLogOutput');
        
        const formData = new FormData();

        if (isUpload) {
            if (!fileInput.files.length) {
                errorDiv.innerHTML = '<span class="text-danger">Please select a .json patch file</span>';
                return;
            }
            formData.append('file', fileInput.files[0]);
        } else {
            if (!contentInput.value.trim()) {
                errorDiv.innerHTML = '<span class="text-danger">Please paste the patch content</span>';
                return;
            }
            formData.append('patch_content', contentInput.value);
        }

        // Loader Logic
        const loader = document.getElementById('globalLoader');
        if(loader) {
            loader.style.display = 'flex';
            loader.innerHTML = `
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                <h4 class="text-white">Processing Update...</h4>
                <ul class="text-muted text-start small mt-2" style="list-style: none;">
                    <li><i class="bi bi-check2 text-success me-2"></i>Creating Backup...</li>
                    <li><i class="bi bi-check2 text-success me-2"></i>Applying Anchors...</li>
                    <li><i class="bi bi-arrow-repeat text-warning me-2"></i>Restarting Server...</li>
                </ul>
            `;
        }

        fetch('/api/admin/patch/apply', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                if(loader) {
                    loader.innerHTML = `
                        <div class="spinner-border text-success mb-3" style="width: 3rem; height: 3rem;"></div>
                        <h4 class="text-white">Update Complete!</h4>
                        <p class="text-success">Restarting System...</p>
                    `;
                }
                setTimeout(() => { window.location.reload(); }, 5000);
            } else {
                if(loader) {
                    loader.style.display = 'none';
                    loader.innerHTML = '';
                }
                errorDiv.innerHTML = `<span class="text-danger fw-bold">Update Failed:</span> ${d.message}`;
                if (d.logs && logDiv) {
                    logDiv.classList.remove('d-none');
                    logDiv.innerText = d.logs;
                }
            }
        })
        .catch(e => {
            if(loader) loader.style.display = 'none';
            if(errorDiv) errorDiv.innerHTML = `<span class="text-danger">Connection Error: ${e}</span>`;
        });
    }
</script>