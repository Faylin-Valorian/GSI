<script>
    // ==========================================
    // COUNTY MANAGEMENT
    // ==========================================

    function openCountiesModal() { 
        closeAllModals(); 
        if(countiesModal) countiesModal.show(); 
        fetchEnabledStatesForCounties(); 
    }

    function fetchEnabledStatesForCounties() {
        fetch('/api/admin/states/list').then(r=>r.json()).then(data => {
            const sel = document.getElementById('countyStateSelect'); 
            sel.innerHTML = '<option value="">Select State...</option>';
            data.filter(s=>s.status).forEach(s => { 
                sel.innerHTML += `<option value="${s.id}">${s.name}</option>`; 
            });
        });
    }

    function fetchCountiesForState() {
        const sid = document.getElementById('countyStateSelect').value;
        if(!sid) return;
        fetch(`/api/admin/counties/list/${sid}`).then(r=>r.json()).then(data => {
            const b = document.getElementById('countiesTableBody'); b.innerHTML = '';
            data.forEach(c => {
                b.innerHTML += `<tr>
                    <td class="county-name">${c.name}</td>
                    
                    <td class="text-center">
                        <button class="btn btn-sm ${c.is_enabled ? 'btn-info' : 'btn-outline-secondary'} w-100" 
                                onclick="toggleCountyField(${c.id}, 'enabled', ${!c.is_enabled})" style="max-width: 120px;">
                            ${c.is_enabled ? '<i class="bi bi-eye-fill me-2"></i>Visible' : '<i class="bi bi-eye-slash me-2"></i>Hidden'}
                        </button>
                    </td>

                    <td class="text-end">
                        <div class="d-flex justify-content-end align-items-center gap-2">
                            <span class="small text-muted" style="min-width: 50px;">${c.is_active ? 'Active' : 'Inactive'}</span>
                            <div class="form-check form-switch m-0" style="min-height: auto;">
                                <input class="form-check-input m-0" type="checkbox" role="switch" 
                                       style="cursor: pointer;"
                                       ${c.is_active ? 'checked' : ''} 
                                       onchange="toggleCountyField(${c.id}, 'active', this.checked)">
                            </div>
                        </div>
                    </td>
                </tr>`;
            });
        });
    }

    function toggleCountyField(id, field, newStatus) {
        fetch('/api/admin/counties/toggle', {
            method:'POST', headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify({id:id, field:field, status:newStatus})
        }).then(r=>r.json()).then(d=>{ 
            if(d.success) {
                fetchCountiesForState(); // Refresh UI
                // Update Map if Visibility changed
                if(field === 'enabled' && typeof loadCountyLayers === 'function') {
                    loadCountyLayers();
                }
            }
        });
    }
    
    function filterCountiesTable() {
        const filter = document.getElementById('countySearchInput').value.toLowerCase();
        const rows = document.getElementById('countiesTableBody').getElementsByTagName('tr');
        for (let i = 0; i < rows.length; i++) {
            const td = rows[i].getElementsByClassName("county-name")[0];
            if (td) rows[i].style.display = (td.innerText.toLowerCase().indexOf(filter) > -1) ? "" : "none";
        }
    }
</script>