<script>
    let dbCompatMgr = null;

    function openDbCompatTool() {
        closeAllModals();
        if(document.getElementById('dbCompatModal')) {
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('dbCompatModal'));
            modal.show();
        }

        if(!dbCompatMgr) {
            dbCompatMgr = new PreviewManager({
                prefix: 'dbCompat',
                apiPreview: '/api/tools/db-compat/preview',
                apiDownload: '/api/tools/db-compat/download-sql',
                filename: 'Set_Compatibility.sql',
                payloadProvider: () => ({ level: document.getElementById('dbCompatLevel').value })
            });
        }
        dbCompatMgr.reset();
        document.getElementById('dbCompatResult').innerText = '';
    }

    function runDbCompat() {
        const btn = document.querySelector('#dbCompatModal .btn-info');
        btn.disabled = true; btn.innerText = "Applying...";
        document.getElementById('dbCompatResult').innerText = '';
        
        if(dbCompatMgr) dbCompatMgr.reset();

        const payload = dbCompatMgr.payloadProvider();

        fetch('/api/tools/db-compat/run', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
        }).then(r => r.json()).then(d => {
            btn.disabled = false; btn.innerText = "Apply Level";
            if(d.success) document.getElementById('dbCompatResult').innerHTML = `<div class="alert alert-success">${d.message}</div>`;
            else document.getElementById('dbCompatResult').innerHTML = `<div class="alert alert-danger">${d.message}</div>`;
        }).catch(e => { btn.disabled = false; btn.innerText = "Apply Level"; document.getElementById('dbCompatResult').innerText = "Error: " + e; });
    }

    // --- ALIAS FOR SIDEBAR COMPATIBILITY ---
    window.openDbCompatModal = openDbCompatTool;
</script>