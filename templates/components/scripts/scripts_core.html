<script>
    // ==========================================
    // GSI CORE SYSTEM (SANITIZED)
    // Only handles Modals, Init, and Alerts
    // ==========================================

    // --- 1. GLOBAL VARIABLES (MODALS ONLY) ---
    // System Modals
    var alertModal, confirmationModal, adminAuthModal, codeViewerModal, timeoutModal;
    
    // Tool Modals
    var seedConfirmModal, seedSuccessModal, statesModal, countiesModal, accountsModal, userEditModal;
    var dbCompatModal, dbDowngradeModal, proceduresModal, driveModal, alterDbModal, patchModal;
    var cleanupModal, initialPrepModal, edataErrorsModal, importEdeModal, linkupModal, eDataModal, keliModal;
    var unindexedReviewModal, instCorrectionModal, schemaModal;

    var pendingConfirmationAction = null;

    // --- 2. INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        const init = (id) => { const el = document.getElementById(id); return el ? new bootstrap.Modal(el) : null; };
        
        // Init System Modals
        alertModal = init('universalAlertModal'); 
        confirmationModal = init('confirmationModal');
        adminAuthModal = init('adminAuthModal');
        codeViewerModal = init('codeViewerModal');
        timeoutModal = init('timeoutModal');
        
        // Init Tool Modals
        seedConfirmModal = init('seedConfirmModal');
        seedSuccessModal = init('seedSuccessModal');
        statesModal = init('statesModal');
        countiesModal = init('countiesModal');
        accountsModal = init('accountsModal');
        userEditModal = init('userEditModal');
        patchModal = init('patchModal');
        driveModal = init('driveModal');
        dbCompatModal = init('dbCompatModal');
        dbDowngradeModal = init('dbDowngradeModal');
        proceduresModal = init('proceduresModal');
        alterDbModal = init('alterDbModal');
        cleanupModal = init('cleanupModal');
        initialPrepModal = init('initialPrepModal');
        edataErrorsModal = init('edataErrorsModal');
        importEdeModal = init('importEDataErrorsModal');
        linkupModal = init('keliLinkupModal');
        eDataModal = init('eDataModal');
        keliModal = init('keliModal');
        unindexedReviewModal = init('unindexedReviewModal');
        instCorrectionModal = document.getElementById('itcModalDialog') ? new bootstrap.Modal(document.getElementById('instCorrectionModal')) : init('instCorrectionModal');
        schemaModal = init('schemaModal');
    });

    // ==========================================
    // 3. WINDOW MANAGER
    // ==========================================
    function closeAllModals() {
        const all = [
            alertModal, confirmationModal, adminAuthModal, codeViewerModal, timeoutModal,
            seedConfirmModal, seedSuccessModal, statesModal, countiesModal, accountsModal, userEditModal, 
            dbCompatModal, dbDowngradeModal, proceduresModal, patchModal, cleanupModal, initialPrepModal, 
            alterDbModal, edataErrorsModal, importEdeModal, linkupModal, unindexedReviewModal, 
            instCorrectionModal, eDataModal, keliModal, driveModal, schemaModal
        ];
        all.forEach(m => { if(m) m.hide(); });
        
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style = '';
    }

    // ==========================================
    // 4. SYSTEM NOTIFICATIONS
    // ==========================================
    function showNotification(message, type = 'info') {
        const title = document.getElementById('alertModalTitle');
        const msg = document.getElementById('alertModalMessage');
        const header = document.getElementById('alertModalHeader');
        
        if (!title) { alert(message); return; } // Fallback

        // Reset Styles
        header.className = 'modal-header border-secondary text-white';
        if (type === 'success') header.classList.add('bg-success');
        else if (type === 'error') header.classList.add('bg-danger');
        else header.classList.add('bg-info');

        title.innerText = type === 'error' ? 'Error' : (type === 'success' ? 'Success' : 'System Message');
        msg.innerText = message;
        
        if(alertModal) alertModal.show();
    }

    function showConfirmation(message, actionCallback) {
        if(document.getElementById('confirmationMessage')) {
            document.getElementById('confirmationMessage').innerText = message;
            pendingConfirmationAction = actionCallback; 
            if(confirmationModal) confirmationModal.show();
        } else {
            if(confirm(message)) actionCallback();
        }
    }

    function executeConfirmation() {
        if (pendingConfirmationAction) pendingConfirmationAction(); 
        if(confirmationModal) confirmationModal.hide();
        pendingConfirmationAction = null;
    }

    function closeConfirmationModal() {
        pendingConfirmationAction = null; 
        if(confirmationModal) confirmationModal.hide();
    }
</script>