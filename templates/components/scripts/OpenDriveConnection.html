<script>
    let driveMgr = null;

    function openDriveTool() {
        closeAllModals();
        if(document.getElementById('openDriveModal')) {
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('openDriveModal'));
            modal.show();
        }

        if(!driveMgr) {
            driveMgr = new PreviewManager({
                prefix: 'drive',
                apiPreview: '/api/tools/open-drive/preview',
                apiDownload: '/api/tools/open-drive/download-sql',
                filename: 'Map_Drive.sql',
                payloadProvider: () => ({
                    letter: document.getElementById('driveLetter').value,
                    path: document.getElementById('drivePath').value,
                    user: document.getElementById('driveUser').value,
                    pass: document.getElementById('drivePass').value
                })
            });
        }
        driveMgr.reset();
        document.getElementById('driveResult').innerText = '';
    }

    function runOpenDrive() {
        const btn = document.querySelector('#openDriveModal .btn-light');
        btn.disabled = true; btn.innerText = "Connecting...";
        document.getElementById('driveResult').innerText = '';
        
        if(driveMgr) driveMgr.reset();

        const payload = driveMgr.payloadProvider();

        fetch('/api/tools/open-drive/run', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
        }).then(r => r.json()).then(d => {
            btn.disabled = false; btn.innerText = "Connect";
            if(d.success) document.getElementById('driveResult').innerHTML = `<div class="alert alert-success">${d.message}</div>`;
            else document.getElementById('driveResult').innerHTML = `<div class="alert alert-danger">${d.message}</div>`;
        }).catch(e => { btn.disabled = false; btn.innerText = "Connect"; document.getElementById('driveResult').innerText = "Error: " + e; });
    }

    // --- ALIAS FOR SIDEBAR COMPATIBILITY ---
    window.openDriveModal = openDriveTool;
</script>