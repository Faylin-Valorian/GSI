<script>
    // ==========================================
    // 3. ADMIN TOOLS & SEEDING
    // ==========================================
    
// --- SEEDING ---
    function showSeedConfirm(){ 
        seedConfirmModal.show(); 
    }
    
    function runSeeding(){
        seedConfirmModal.hide(); 
        document.getElementById('globalLoader').style.display='flex';
        
        fetch('/api/admin/seed', {method:'POST'})
        .then(r=>r.json())
        .then(d=>{
            document.getElementById('globalLoader').style.display='none';
            if(d.success){ 
                document.getElementById('seedSuccessMessage').innerText = d.message;
                seedSuccessModal.show();
                fetchStates(); 
                loadStateLayers(); 
                loadCountyLayers();
            } else {
                // <--- FIX: Use showNotification instead of alert --->
                showNotification("Seeding failed: " + d.message);
            }
        })
        .catch(e => { 
            document.getElementById('globalLoader').style.display = 'none'; 
            // <--- FIX: Use showNotification instead of alert --->
            showNotification("Error: " + e); 
        });
    }
    
    // --- STATES MANAGEMENT ---
    function openStatesModal(){ 
        closeAllModals(); 
        statesModal.show(); 
        fetchStates(); 
    }
    
    function fetchStates() {
        fetch('/api/admin/states')
        .then(r=>r.json())
        .then(data => {
            let h = ''; 
            data.forEach(s => { 
                const statusBadge = s.is_enabled 
                    ? '<span class="badge bg-success">Enabled</span>' 
                    : '<span class="badge bg-secondary">Disabled</span>';
                
                const toggleBtn = `<button class="btn btn-sm ${s.is_enabled?'btn-warning':'btn-success'} me-1" onclick="toggleState(${s.id})">
                    ${s.is_enabled?'Disable':'Enable'}
                </button>`;

                h += `<tr>
                    <td>${s.name}</td>
                    <td>${s.fips}</td>
                    <td>${statusBadge}</td>
                    <td class="text-end">${toggleBtn}</td>
                </tr>`; 
            });
            document.getElementById('statesTableBody').innerHTML = h;
        });
    }

    function toggleState(id) { 
        fetch(`/api/admin/state/${id}/toggle`, {method:'POST'})
        .then(r=>r.json())
        .then(d=>{
            if(d.success){
                fetchStates(); 
                loadStateLayers(); 
                loadCountyLayers();
            } else {
                showNotification(d.message);
            }
        }); 
    }

    // --- COUNTIES MANAGEMENT ---
    function openCountiesModal(){ 
        closeAllModals(); 
        countiesModal.show(); 
        
        // Load States Dropdown first
        fetch('/api/admin/states').then(r=>r.json()).then(data => {
            let h = '<option value="">Select State...</option>';
            data.filter(s=>s.is_enabled).forEach(s => {
                h += `<option value="${s.fips}">${s.name}</option>`;
            });
            document.getElementById('countyStateSelect').innerHTML = h;
            document.getElementById('countiesTableBody').innerHTML = '';
        });
    }

    function fetchCountiesForState() {
        const fips = document.getElementById('countyStateSelect').value; 
        if(!fips) return;
        
        fetch(`/api/admin/counties/${fips}`)
        .then(r=>r.json())
        .then(data => {
            let h = ''; 
            data.forEach(c => { 
                const enableBtn = `<button class="btn btn-sm ${c.is_enabled?'btn-outline-warning':'btn-outline-secondary'} me-1" onclick="toggleCounty(${c.id})" title="${c.is_enabled?'Hide from Map':'Show on Map'}"><i class="bi ${c.is_enabled?'bi-eye-fill':'bi-eye-slash'}"></i></button>`;
                const activeBtn = `<button class="btn btn-sm ${c.is_active?'btn-success':'btn-danger'} me-1" onclick="toggleGlobalActive(${c.id})" title="${c.is_active?'Mark Inactive':'Mark Active'}">${c.is_active?'Active':'Inactive'}</button>`;

                h += `<tr>
                    <td class="county-name">${c.name}</td>
                    <td>${c.is_enabled?'<span class="badge bg-info">Visible</span>':'<span class="badge bg-secondary">Hidden</span>'}</td>
                    <td class="text-end">
                        ${activeBtn}
                        ${enableBtn}
                    </td>
                </tr>`; 
            });
            document.getElementById('countiesTableBody').innerHTML = h;
        });
    }

    function toggleCounty(id) { 
        fetch(`/api/admin/county/${id}/toggle`, {method:'POST'})
        .then(r=>r.json())
        .then(d=>{
            if(d.success){
                fetchCountiesForState(); 
                loadCountyLayers();
            }
        }); 
    }
    
    function toggleGlobalActive(id) {
        fetch(`/api/admin/county/${id}/set-global-active`, {method: 'POST'})
        .then(r => r.json())
        .then(d => {
            if(d.success) {
                fetchCountiesForState(); 
                loadCountyLayers();      
            } else {
                showNotification("Error: " + d.message);
            }
        });
    }

    // ==========================================
    // ACCOUNT MANAGEMENT
    // ==========================================

    function openAccountsModal(){
        closeAllModals(); 
        accountsModal.show();
        fetch('/api/users')
            .then(r => r.json())
            .then(users => {
                let h = ''; 
                users.forEach(u => {
                    const isAdmin = u.role === 'admin';
                    
                    const editBtn = `<button class="btn btn-sm btn-outline-primary me-1" onclick="openUserEditModal(${u.id}, '${u.username}', '${u.email}')" title="Edit Details"><i class="bi bi-pencil-fill"></i></button>`;
                    const roleBtn = `<button class="btn btn-sm ${isAdmin ? 'btn-outline-custom-purple' : 'btn-outline-secondary'} me-1" onclick="toggleUserRole(${u.id})" title="Toggle Admin Role"><i class="bi ${isAdmin ? 'bi-shield-lock-fill' : 'bi-person-fill'}"></i></button>`;
                    const isLocked = u.is_locked;
                    const lockBtn = `<button class="btn btn-sm ${isLocked ? 'btn-warning' : 'btn-outline-warning'} me-1" onclick="toggleUserLock(${u.id})" title="${isLocked ? 'Unlock Account' : 'Lock Account'}"><i class="bi ${isLocked ? 'bi-lock-fill' : 'bi-unlock-fill'}"></i></button>`;
                    const deleteBtn = `<button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${u.id}, '${u.username}')" title="Delete User"><i class="bi bi-trash-fill"></i></button>`;

                    h += `<tr>
                        <td class="fw-bold">${u.username}</td>
                        <td class="text-muted small">${u.email}</td>
                        <td>${isAdmin ? '<span class="badge bg-custom-purple">Admin</span>' : '<span class="badge bg-secondary">User</span>'}</td>
                        <td>
                            ${u.is_locked ? '<span class="badge bg-danger">Locked</span>' : 
                              (u.is_verified ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-warning text-dark">Pending</span>')}
                        </td>
                        <td class="text-end" style="min-width: 160px;">
                            ${editBtn}${roleBtn}${lockBtn}${deleteBtn}
                        </td>
                    </tr>`;
                });
                document.getElementById('userTableBody').innerHTML = h;
            });
    }

    // --- USER EDIT MODAL FUNCTIONS ---

    function openUserEditModal(id, username, email) {
        document.getElementById('editUserId').value = id;
        document.getElementById('editUsername').value = username;
        document.getElementById('editEmail').value = email;
        document.getElementById('resetPasswordResult').classList.add('d-none');
        document.getElementById('tempPassDisplay').value = '';
        userEditModal.show();
    }

    function closeUserEditModal() {
        userEditModal.hide();
        openAccountsModal();
    }

    function submitUserEdit() {
        const id = document.getElementById('editUserId').value;
        const username = document.getElementById('editUsername').value;
        const email = document.getElementById('editEmail').value;

        fetch(`/api/admin/user/${id}/update`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: username, email: email })
        })
        .then(r => r.json())
        .then(d => {
            if(d.success) {
                showNotification("User updated successfully.");
                closeUserEditModal();
            } else {
                showNotification("Error: " + d.message);
            }
        });
    }

    function resetUserPassword() {
        const id = document.getElementById('editUserId').value;
        
        showConfirmation("Are you sure you want to generate a new temporary password for this user?", () => {
            fetch(`/api/admin/user/${id}/reset-password`, {method: 'POST'})
            .then(r => r.json())
            .then(d => {
                if(d.success) {
                    document.getElementById('resetPasswordResult').classList.remove('d-none');
                    document.getElementById('tempPassDisplay').value = d.temp_pass;
                } else {
                    showNotification("Error: " + d.message);
                }
            });
        });
    }

    // --- OTHER USER ACTIONS ---

    function toggleUserLock(id) {
        fetch(`/api/admin/user/${id}/toggle-lock`, {method: 'POST'})
        .then(r => r.json()).then(d => {
            if(d.success) openAccountsModal(); 
            else showNotification(d.message);
        });
    }

    function toggleUserRole(id) {
        showConfirmation("Are you sure you want to change this user's role?", () => {
            fetch(`/api/admin/user/${id}/toggle-role`, {method: 'POST'})
            .then(r => r.json()).then(d => {
                if(d.success) openAccountsModal();
                else showNotification(d.message);
            });
        });
    }

    function deleteUser(id, username) {
        showConfirmation(`DANGER: Are you sure you want to PERMANENTLY delete user "${username}"?`, () => {
            fetch(`/api/admin/user/${id}/delete`, {method: 'POST'})
            .then(r => r.json()).then(d => {
                if(d.success) openAccountsModal();
                else showNotification(d.message);
            });
        });
    }

    // ==========================================
    // MAP INTERACTION (POPUP ACTIONS)
    // ==========================================

    function toggleUserWorkingCounty(id, isChecked) {
        fetch('/api/user/set-working-county', {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ county_id: id, toggle_on: isChecked })
        })
        .then(r=>r.json()).then(d => {
            if(d.success) { 
                loadCountyLayers(); 
            } 
            else { 
                showNotification("Action Failed: " + d.message);
                loadCountyLayers(); 
            }
        });
    }
    
    function saveNotes(id) {
        const text = document.getElementById(`notes-${id}`).value;
        fetch(`/api/county/${id}/save-notes`, {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ notes: text })
        });
    }

    function triggerUpload(id, isWorking) {
        if (!isWorking) {
            showNotification("You must set this county as 'Working On' (Blue Toggle) before uploading images.");
            return;
        }
        document.getElementById(`upload-${id}`).click();
    }

    function uploadImage(id, input) {
        const file = input.files[0];
        if(!file) return;
        const formData = new FormData(); 
        formData.append('file', file);
        fetch(`/api/county/${id}/upload-image`, {method: 'POST', body: formData})
        .then(r => r.json()).then(d => {
            if(d.success) { loadCountyLayers(); } 
            else { showNotification("Upload failed: " + d.message); }
        });
    }

    // ==========================================
    // UNINDEXED IMAGES REVIEW (SIDEBAR AWARE)
    // ==========================================

    function openUnindexedReview(countyId, stateName, countyName) {
        closeAllModals();
        document.getElementById('currentReviewCountyId').value = countyId;
        
        // 1. Default Path Logic: data/State/County/Images
        const defaultPath = `data/${stateName}/${countyName}/Images`;
        document.getElementById('scanPathInput').value = defaultPath;
        
        // 2. Reset View
        document.getElementById('unindexedTableBody').innerHTML = '';
        document.getElementById('unindexedImagePreview').style.display = 'none';
        document.getElementById('noImageMsg').style.display = 'block';
        document.getElementById('scanSplitToggle').checked = false; // Reset toggle
        
        // Reset debug toggle if present
        const debugToggle = document.getElementById('scanDebugToggle');
        if(debugToggle) debugToggle.checked = false;
        
        // 3. Show & Load
        unindexedReviewModal.show();
        loadUnindexedTable(countyId);
        
        // 4. Force layout check immediately
        adjustUnindexedModalLayout();
    }

    function closeUnindexedModal() {
        unindexedReviewModal.hide();
    }

    function scanForUnindexed() {
        const countyId = document.getElementById('currentReviewCountyId').value;
        const path = document.getElementById('scanPathInput').value;
        const checkSplit = document.getElementById('scanSplitToggle').checked;
        const debugMode = document.getElementById('scanDebugToggle') ? document.getElementById('scanDebugToggle').checked : false; 
        
        if(!path) { showNotification("Please enter a directory path to scan."); return; }
        
        document.getElementById('globalLoader').style.display = 'flex';
        
        fetch('/api/edata/scan-unindexed', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                county_id: countyId, 
                scan_path: path,
                check_split: checkSplit,
                debug: debugMode // Send to API
            })
        })
        .then(r => r.json())
        .then(d => {
            document.getElementById('globalLoader').style.display = 'none';
            if(d.success) {
                showNotification(d.message);
                loadUnindexedTable(countyId);
            } else {
                showNotification("Scan Failed: " + d.message);
            }
        });
    }

    function loadUnindexedTable(countyId) {
        fetch(`/api/edata/unindexed-list/${countyId}`)
        .then(r => r.json())
        .then(data => {
            const tbody = document.getElementById('unindexedTableBody');
            tbody.innerHTML = '';
            
            data.forEach(img => {
                const tr = document.createElement('tr');
                tr.onclick = () => selectUnindexedRow(tr, img.id);
                tr.style.cursor = 'pointer';
                
                // Column 1: Path/Name
                const tdName = document.createElement('td');
                tdName.className = "ps-3 text-truncate";
                tdName.style.maxWidth = "200px";
                tdName.title = img.path;
                tdName.innerText = img.display_name;
                
                // Column 2: Toggle
                const tdAction = document.createElement('td');
                tdAction.className = "text-center";
                tdAction.onclick = (e) => e.stopPropagation(); 
                
                const select = document.createElement('select');
                select.className = "form-select form-select-sm bg-transparent text-light border-0 text-center fw-bold";
                select.style.cursor = "pointer";
                select.innerHTML = `
                    <option value="false" ${!img.require_indexing ? 'selected' : ''}>False</option>
                    <option value="true" ${img.require_indexing ? 'selected' : ''}>True</option>
                `;
                select.style.color = img.require_indexing ? '#198754' : '#6c757d'; 
                select.onchange = (e) => {
                    const val = e.target.value === 'true';
                    updateUnindexedStatus(img.id, val, select);
                };
                
                tdAction.appendChild(select);
                tr.appendChild(tdName);
                tr.appendChild(tdAction);
                tbody.appendChild(tr);
            });
        });
    }

    function selectUnindexedRow(tr, imgId) {
        const rows = document.getElementById('unindexedTableBody').querySelectorAll('tr');
        rows.forEach(r => r.classList.remove('table-active', 'border-primary', 'border-start', 'border-3'));
        tr.classList.add('table-active', 'border-primary', 'border-start', 'border-3');
        
        const imgEl = document.getElementById('unindexedImagePreview');
        const noImg = document.getElementById('noImageMsg');
        const loader = document.getElementById('imageLoader');
        
        noImg.style.display = 'none';
        imgEl.style.display = 'none';
        loader.classList.remove('d-none');
        
        resetPanZoom();

        // Check debug toggle to enable verbose backend logs for this image
        const debugMode = document.getElementById('scanDebugToggle') ? document.getElementById('scanDebugToggle').checked : false;
        
        // Add debug param if checked
        imgEl.src = `/api/edata/view-image/${imgId}?t=${new Date().getTime()}${debugMode ? '&debug=true' : ''}`;
        
        imgEl.onload = () => {
            loader.classList.add('d-none');
            imgEl.style.display = 'block';
        };
        imgEl.onerror = () => {
            loader.classList.add('d-none');
            showNotification("Could not load image file.");
        };
    }

    function updateUnindexedStatus(id, status, selectEl) {
        fetch('/api/edata/update-image-status', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id: id, require_indexing: status })
        })
        .then(r => r.json())
        .then(d => {
            if(d.success) {
                selectEl.style.color = status ? '#198754' : '#6c757d';
            } else {
                showNotification("Update Failed");
                selectEl.value = (!status).toString();
            }
        });
    }

    function adjustUnindexedModalLayout() {
        const modalDialog = document.getElementById('unindexedModalDialog');
        if (!modalDialog || !unindexedReviewModal._isShown) return;

        const isSidebarOpen = document.querySelector('.menu-panel.open') !== null;
        const newLeft = isSidebarOpen ? '250px' : '60px';
        modalDialog.style.left = newLeft;
        modalDialog.style.maxWidth = 'none';
    }

    // --- PAN & ZOOM LOGIC (Drag based) ---
    let zoomLevel = 1;
    let panX = 0;
    let panY = 0;
    let isPanning = false;
    let startX = 0;
    let startY = 0;

    function initPanZoom() {
        const container = document.getElementById('imagePanContainer');
        if(!container) return; 

        const img = document.getElementById('unindexedImagePreview');
        if (img) {
            img.addEventListener('dragstart', (e) => e.preventDefault());
        }

        container.addEventListener('wheel', (e) => {
            if(!img || img.style.display === 'none') return;
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            zoomLevel = Math.min(Math.max(0.1, zoomLevel + delta), 5);
            updateTransform();
        });

        container.addEventListener('mousedown', (e) => {
            if(!img || img.style.display === 'none') return;
            isPanning = true;
            startX = e.clientX - panX;
            startY = e.clientY - panY;
            container.style.cursor = 'grabbing';
        });

        window.addEventListener('mousemove', (e) => {
            if (!isPanning) return;
            e.preventDefault();
            panX = e.clientX - startX;
            panY = e.clientY - startY;
            updateTransform();
        });

        window.addEventListener('mouseup', () => {
            if(isPanning) {
                isPanning = false;
                if(container) container.style.cursor = 'grab';
            }
        });
    }

    function updateTransform() {
        const img = document.getElementById('unindexedImagePreview');
        if(img) img.style.transform = `translate(${panX}px, ${panY}px) scale(${zoomLevel})`;
    }

    function resetPanZoom() {
        zoomLevel = 1;
        panX = 0;
        panY = 0;
        updateTransform();
    }

// ==========================================
    // ALTER DATABASE FIELDS TOOLS (Renamed from Schema)
    // ==========================================

    const alterDbModal = new bootstrap.Modal(document.getElementById('alterDbModal'));

    function openAlterDbTool() {
        closeAllModals();
        // Reset state
        document.getElementById('alterDbSqlPreview').innerText = "-- Click 'Generate SQL Preview' to analyze the database state...";
        document.getElementById('btnRunAlterDb').disabled = true;
        document.getElementById('alterDbStatusMsg').innerText = "Ready";
        document.getElementById('alterDbStatusMsg').className = "text-muted small";
        alterDbModal.show();
    }

    function previewAlterDb() {
        const loader = document.getElementById('alterDbLoader');
        const previewBox = document.getElementById('alterDbSqlPreview');
        const runBtn = document.getElementById('btnRunAlterDb');
        
        loader.classList.remove('d-none');
        
        // Updated API Endpoint
        fetch('/api/admin/alter-db/preview')
            .then(r => r.json())
            .then(data => {
                loader.classList.add('d-none');
                if (data.success) {
                    previewBox.innerText = data.sql;
                    const hasCode = data.sql.split('\n').some(line => line.trim() && !line.trim().startsWith('--'));
                    
                    if (hasCode) {
                        runBtn.disabled = false;
                        setAlterDbStatus("Changes detected. Ready to execute.", "text-warning");
                    } else {
                        runBtn.disabled = true;
                        setAlterDbStatus("Database is already up to date.", "text-success");
                    }
                } else {
                    previewBox.innerText = "-- Error --\n" + data.message;
                }
            })
            .catch(err => {
                loader.classList.add('d-none');
                previewBox.innerText = "Connection Error: " + err;
            });
    }

    function runAlterDbMigration() {
        // --- FIX: Using Custom Confirmation Popup ---
        showConfirmation("Are you sure you want to alter the database schema? This cannot be easily undone.", () => {
            
            const debugMode = document.getElementById('alterDbDebugToggle').checked;
            const loader = document.getElementById('alterDbLoader');
            
            loader.classList.remove('d-none');
            setAlterDbStatus("Executing SQL...", "text-info");

            // Updated API Endpoint
            fetch('/api/admin/alter-db/execute', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ debug: debugMode })
            })
            .then(r => r.json())
            .then(data => {
                loader.classList.add('d-none');
                if (data.success) {
                    setAlterDbStatus(data.message, "text-success");
                    previewAlterDb(); // Refresh preview to show it's clean
                    showNotification("Database updated successfully!");
                    if(data.debug_log) console.log(data.debug_log);
                } else {
                    setAlterDbStatus("Migration Failed.", "text-danger");
                    showNotification("Error: " + data.message);
                }
            })
            .catch(err => {
                loader.classList.add('d-none');
                setAlterDbStatus("Execution Error.", "text-danger");
            });
        });
    }

    function copyAlterDbSql() {
        const text = document.getElementById('alterDbSqlPreview').innerText;
        navigator.clipboard.writeText(text).then(() => {
            showNotification("SQL copied to clipboard");
        });
    }

    function setAlterDbStatus(msg, colorClass) {
        const el = document.getElementById('alterDbStatusMsg');
        el.innerText = msg;
        el.className = "small fw-bold " + colorClass;
    }

// ==========================================
    // INITIAL PREPARATION TOOL (RENAMED)
    // ==========================================
    const initialPrepModal = new bootstrap.Modal(document.getElementById('initialPrepModal'));
    let currentPrepCountyId = null;

    function openInitialPrepTool(id) {
        closeAllModals();
        currentPrepCountyId = id;
        
        // 1. Reset UI
        document.getElementById('prepResult').innerHTML = '';
        document.getElementById('prepSqlPreview').value = '';
        document.getElementById('prepProgressContainer').classList.add('d-none');
        document.getElementById('prepProgressBar').style.width = '0%';
        
        // 2. Reset Toggle & Visibility
        const toggle = document.getElementById('prepToggleBook');
        if(toggle) {
            toggle.checked = false;
            document.getElementById('prepBookInputsContainer').classList.add('d-none');
            document.getElementById('prepBookStart').value = '';
            document.getElementById('prepBookEnd').value = '';
        }
        
        // 3. Debug Visibility
        const isGlobalDebug = document.getElementById('debugModeToggle') && document.getElementById('debugModeToggle').checked;
        const previewBtn = document.getElementById('btnPrepPreview');
        const debugPanel = document.getElementById('prepDebugPanel');
        
        if (isGlobalDebug) { 
            previewBtn.classList.remove('d-none'); 
            debugPanel.classList.remove('d-none');
        } else { 
            previewBtn.classList.add('d-none'); 
            debugPanel.classList.add('d-none');
        }
        
        initialPrepModal.show();
    }

    function togglePrepBookInputs() {
        const isChecked = document.getElementById('prepToggleBook').checked;
        const container = document.getElementById('prepBookInputsContainer');
        const startInput = document.getElementById('prepBookStart');
        const endInput = document.getElementById('prepBookEnd');
        const statusTxt = document.getElementById('prepBookStatus');

        if (isChecked) {
            container.classList.remove('d-none');
            // Auto-Fill
            if (startInput.value === '' || startInput.value === '---') {
                statusTxt.innerText = "Scanning folders...";
                statusTxt.className = "text-warning small fst-italic";
                
                fetch('/api/tools/initial-prep/get-book-range/' + currentPrepCountyId)
                .then(r => r.json())
                .then(d => {
                    if (d.success && d.found) {
                        startInput.value = d.start;
                        endInput.value = d.end;
                        statusTxt.innerText = "Auto-filled detected range";
                        statusTxt.className = "text-success small fst-italic";
                    } else {
                        statusTxt.innerText = "No images folder found";
                        statusTxt.className = "text-danger small fst-italic";
                    }
                })
                .catch(e => {
                    statusTxt.innerText = "Error scanning folders";
                    statusTxt.className = "text-danger small fst-italic";
                });
            }
        } else {
            container.classList.add('d-none');
            startInput.value = '';
            endInput.value = '';
        }
    }

    function previewPrepSql() {
        const isBook = document.getElementById('prepToggleBook').checked;
        const pStart = isBook ? document.getElementById('prepBookStart').value : null;
        const pEnd = isBook ? document.getElementById('prepBookEnd').value : null;
        
        document.getElementById('prepSqlPreview').value = "-- Generating...";
        
        fetch('/api/tools/initial-prep/preview', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ county_id: currentPrepCountyId, book_start: pStart, book_end: pEnd })
        }).then(r => r.json()).then(d => { document.getElementById('prepSqlPreview').value = d.success ? d.sql : "-- Error generating preview."; });
    }

    function copyPrepSql() { navigator.clipboard.writeText(document.getElementById('prepSqlPreview').value).then(() => showNotification("SQL Copied")); }

    function runPrepTool() {
        showConfirmation("This will modify the database. Backup will be created. Proceed?", async () => {
            const btn = document.getElementById('btnRunPrep');
            const resultDiv = document.getElementById('prepResult');
            const progContainer = document.getElementById('prepProgressContainer');
            const progBar = document.getElementById('prepProgressBar');
            const progLabel = document.getElementById('prepProgressLabel');
            const progPercent = document.getElementById('prepProgressPercent');
            
            const isBook = document.getElementById('prepToggleBook').checked;
            const pStart = isBook ? document.getElementById('prepBookStart').value : null;
            const pEnd = isBook ? document.getElementById('prepBookEnd').value : null;
    
            btn.disabled = true; 
            resultDiv.innerHTML = '';
            progContainer.classList.remove('d-none');
            progBar.style.width = '1%';
            progLabel.innerText = "Initializing...";
            progPercent.innerText = "1%";
    
            try {
                const response = await fetch('/api/tools/initial-prep/execute', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ county_id: currentPrepCountyId, book_start: pStart, book_end: pEnd })
                });
                
                const reader = response.body.getReader(); 
                const decoder = new TextDecoder("utf-8"); 
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read(); 
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true }); 
                    const lines = buffer.split('\n'); 
                    buffer = lines.pop();
                    for (const line of lines) { 
                        if (!line.trim()) continue; 
                        try { 
                            const data = JSON.parse(line);
                            if (data.type === 'progress') {
                                progBar.style.width = data.percent + '%';
                                progLabel.innerText = data.message;
                                progPercent.innerText = data.percent + '%';
                            } 
                            else if (data.type === 'complete') {
                                progBar.style.width = '100%';
                                progBar.classList.remove('progress-bar-animated');
                                progBar.classList.add('bg-success');
                                progLabel.innerText = "Done";
                                progPercent.innerText = "100%";
                                resultDiv.innerHTML = `<div class="alert alert-success py-2 mt-3"><i class="bi bi-check-circle me-2"></i>${data.message}</div>`;
                            } 
                            else if (data.type === 'error') {
                                progBar.classList.add('bg-danger');
                                resultDiv.innerHTML = `<div class="alert alert-danger py-2 mt-3">${data.message}</div>`;
                            }
                        } catch (e) {} 
                    }
                }
            } catch (e) { 
                resultDiv.innerHTML = `<div class="text-danger">Connection Error</div>`; 
            } finally { 
                btn.disabled = false; 
            }
        });
    }

// ==========================================
    // INSTRUMENT TYPE CORRECTIONS TOOL
    // ==========================================
    const instCorrectionModal = new bootstrap.Modal(document.getElementById('instCorrectionModal'));
    let itcCountyId = null;
    let itcImages = [];
    let itcImgIndex = 0;
    
    // Pan/Zoom State
    let itcZoom = 1;
    let itcPanX = 0;
    let itcPanY = 0;
    let itcIsPanning = false;
    let itcStartX = 0;
    let itcStartY = 0;
    
    // Resizer State
    let itcIsResizing = false;
    
    // Edit State
    let itcActiveRecordId = null; 
    let itcActiveOriginalVal = null;

    function openInstCorrectionTool(id, stateName, countyName) {
        closeAllModals();
        itcCountyId = id;
        
        // 1. Auto-Fill Path
        // Backend handles joining this with root path if relative
        const defaultPath = `data/${stateName}/${countyName}/Images`;
        document.getElementById('itcPathInput').value = defaultPath;

        // 2. Reset UI
        document.getElementById('itcRecordList').innerHTML = '';
        document.getElementById('itcListStatus').innerText = "Initializing...";
        document.getElementById('itcThumbnailStrip').innerHTML = '';
        document.getElementById('itcMainImage').style.display = 'none';
        document.getElementById('itcNoImage').classList.remove('d-none');
        document.getElementById('itcHideCompleted').checked = true;
        
        document.getElementById('itcHeaderDisplay').innerText = "---";
        document.getElementById('itcOriginalDisplay').innerText = "---";
        document.getElementById('itcCurrentDisplay').innerText = "---";
        
        itcHidePopover();
        itcResetPanZoom();

        // 3. Show & Initialize Layout Tools
        instCorrectionModal.show();
        adjustItcModalLayout(); // Position based on sidebar
        itcInitPanZoom();       // Image controls
        itcInitResizer();       // Resizer controls
        
        fetch('/api/tools/inst-corrections/init', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ county_id: itcCountyId })
        })
        .then(r => r.json())
        .then(d => {
            if(d.success) itcFetchList();
            else showNotification("Error initializing: " + d.message);
        });
    }

    function adjustItcModalLayout() {
        const modalDialog = document.getElementById('itcModalDialog');
        if (!modalDialog) return;
        const isSidebarOpen = document.querySelector('.menu-panel.open') !== null;
        modalDialog.style.left = isSidebarOpen ? '250px' : '60px';
    }

    // --- RESIZER LOGIC (Expandable Panel) ---
    function itcInitResizer() {
        const resizer = document.getElementById('itcResizer');
        const leftPanel = document.getElementById('itcLeftPanel');
        const modalBody = document.getElementById('itcModalBody');
        
        if(!resizer || !leftPanel || !modalBody) return;

        if (resizer.dataset.initialized === 'true') return;
        resizer.dataset.initialized = 'true';

        resizer.addEventListener('mousedown', (e) => {
            itcIsResizing = true;
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none'; 
            resizer.classList.add('bg-primary');
        });

        document.addEventListener('mousemove', (e) => {
            if (!itcIsResizing) return;
            
            const bodyRect = modalBody.getBoundingClientRect();
            let newWidth = e.clientX - bodyRect.left;
            const maxWidth = bodyRect.width * 0.6;
            
            if (newWidth > 250 && newWidth < maxWidth) {
                leftPanel.style.width = newWidth + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            if(itcIsResizing) {
                itcIsResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                resizer.classList.remove('bg-primary');
            }
        });
    }

    // --- DATA LOADING ---
    function itcFetchList() {
        const hideCompleted = document.getElementById('itcHideCompleted').checked;
        document.getElementById('itcListStatus').innerText = "Loading records...";
        
        fetch('/api/tools/inst-corrections/list', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ county_id: itcCountyId, hide_completed: hideCompleted })
        })
        .then(r => r.json())
        .then(d => {
            const listEl = document.getElementById('itcRecordList');
            listEl.innerHTML = '';
            
            if (d.records.length === 0) {
                document.getElementById('itcListStatus').innerText = "No records found.";
                return;
            }
            
            document.getElementById('itcListStatus').innerText = `${d.records.length} records found`;
            
            d.records.forEach(rec => {
                const item = document.createElement('div');
                item.className = 'd-flex align-items-center border-bottom border-secondary p-2 hover-bg-dark';
                item.id = `itc-row-${rec.id}`;
                
                const isDone = !!rec.corrected;
                const statusIcon = isDone ? '<i class="bi bi-check-circle-fill me-2 text-success"></i>' : '';
                const valToEdit = isDone ? rec.corrected : ''; 
                
                let labelHtml = `<span class="text-white">${rec.value}</span>`;
                if(isDone) labelHtml += ` <i class="bi bi-arrow-right text-muted mx-1"></i> <span class="text-success">${rec.corrected}</span>`;

                item.onclick = (e) => {
                    if(e.target.closest('.itc-edit-btn')) return;
                    
                    document.getElementById('itcOriginalDisplay').innerText = rec.value;
                    document.getElementById('itcCurrentDisplay').innerText = rec.corrected || rec.value;
                    document.getElementById('itcHeaderDisplay').innerText = "Loading...";
                    
                    itcLoadImages(rec.value);
                    document.querySelectorAll('#itcRecordList > div').forEach(el => el.classList.remove('bg-secondary'));
                    item.classList.add('bg-secondary');
                };

                item.innerHTML = `
                    <div class="flex-grow-1 text-truncate pe-2 font-monospace small" title="${rec.value}">
                        ${statusIcon}${labelHtml}
                    </div>
                    <button class="btn btn-sm btn-outline-light itc-edit-btn" 
                            onclick="itcShowPopover(event, ${rec.id}, '${rec.value.replace(/'/g, "\\'")}', '${valToEdit.replace(/'/g, "\\'")}')">
                        <i class="bi bi-pencil-fill"></i>
                    </button>
                `;
                listEl.appendChild(item);
            });
        });
    }

    function itcLoadImages(val) {
        const path = document.getElementById('itcPathInput').value;
        itcResetPanZoom(); 
        
        fetch('/api/tools/inst-corrections/images', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                county_id: itcCountyId, 
                value: val,
                base_path: path 
            })
        })
        .then(r => r.json())
        .then(d => {
            itcImages = d.images || [];
            itcImgIndex = 0;
            document.getElementById('itcHeaderDisplay').innerText = d.header_text || "No Header Found";
            itcUpdateImageView();
        });
    }

    function itcUpdateImageView() {
        const imgEl = document.getElementById('itcMainImage');
        const strip = document.getElementById('itcThumbnailStrip');
        const noImg = document.getElementById('itcNoImage');
        
        if (itcImages.length === 0) {
            imgEl.style.display = 'none';
            noImg.classList.remove('d-none');
            noImg.innerText = "No images found for this type.";
            strip.innerHTML = '';
            return;
        }
        
        imgEl.style.display = 'block';
        noImg.classList.add('d-none');
        
        const currentObj = itcImages[itcImgIndex];
        imgEl.src = currentObj.src;
        imgEl.title = currentObj.path;
        
        itcUpdateTransform();
        
        let start = Math.max(0, Math.min(itcImgIndex - 2, itcImages.length - 5));
        let end = Math.min(start + 5, itcImages.length);
        let html = '';
        for (let i = start; i < end; i++) {
            let activeClass = (i === itcImgIndex) ? 'border-warning opacity-100' : 'border-secondary opacity-50';
            html += `<img src="${itcImages[i].src}" class="border ${activeClass}" 
                     style="height: 60px; width: 60px; object-fit: cover; cursor: pointer;"
                     onclick="itcJumpTo(${i})" title="${itcImages[i].path}">`;
        }
        strip.innerHTML = html;
    }

    // --- PAN/ZOOM LOGIC ---
    function itcInitPanZoom() {
        const container = document.getElementById('itcImagePanContainer');
        const img = document.getElementById('itcMainImage');
        if(!container || !img) return;
        
        img.addEventListener('dragstart', (e) => e.preventDefault());

        container.onwheel = (e) => {
            if(img.style.display === 'none') return;
            e.preventDefault();

            if (itcIsPanning) {
                // ZOOM (Mouse Held + Wheel)
                const rect = container.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                const newZoom = Math.min(Math.max(0.1, itcZoom + delta), 10); 
                if (newZoom !== itcZoom) {
                    const scale = newZoom / itcZoom;
                    itcPanX = mouseX - (mouseX - itcPanX) * scale;
                    itcPanY = mouseY - (mouseY - itcPanY) * scale;
                    itcZoom = newZoom;
                    itcUpdateTransform();
                }
            } else {
                // SCROLL (Wheel Only)
                itcPanY -= (e.deltaY * 1.0);
                itcUpdateTransform();
            }
        };

        container.onmousedown = (e) => {
            if(img.style.display === 'none') return;
            if(e.target.closest('.position-absolute') && !e.target.closest('#itcNoImage')) return;
            
            itcIsPanning = true;
            itcStartX = e.clientX - itcPanX;
            itcStartY = e.clientY - itcPanY;
            container.style.cursor = 'grabbing';
        };

        window.onmousemove = (e) => {
            if (!itcIsPanning) return;
            e.preventDefault();
            itcPanX = e.clientX - itcStartX;
            itcPanY = e.clientY - itcStartY;
            itcUpdateTransform();
        };

        window.onmouseup = () => {
            if(itcIsPanning) {
                itcIsPanning = false;
                if(container) container.style.cursor = 'grab';
            }
        };
    }

    function itcUpdateTransform() {
        const img = document.getElementById('itcMainImage');
        if(img) img.style.transform = `translate(${itcPanX}px, ${itcPanY}px) scale(${itcZoom})`;
    }

    function itcResetPanZoom() {
        itcZoom = 1; itcPanX = 0; itcPanY = 0; itcIsPanning = false;
        itcUpdateTransform();
    }
    
    function itcNextImage() { if(itcImages.length) { itcImgIndex = (itcImgIndex + 1) % itcImages.length; itcUpdateImageView(); } }
    function itcPrevImage() { if(itcImages.length) { itcImgIndex = (itcImgIndex - 1 + itcImages.length) % itcImages.length; itcUpdateImageView(); } }
    function itcJumpTo(i) { itcImgIndex = i; itcUpdateImageView(); }

    // --- POPOVER LOGIC ---
    function itcShowPopover(event, id, originalVal, currentCorrected) {
        event.stopPropagation();
        itcActiveRecordId = id;
        itcActiveOriginalVal = originalVal;
        
        const pop = document.getElementById('itcPopover');
        const searchIn = document.getElementById('itcPopSearch');
        const results = document.getElementById('itcPopResults');
        const modalBody = document.querySelector('#instCorrectionModal .modal-body');

        const btnRect = event.target.getBoundingClientRect();
        const bodyRect = modalBody.getBoundingClientRect();
        
        const top = btnRect.top - bodyRect.top;
        const left = btnRect.left - bodyRect.left;
        
        pop.style.top = (top + 10) + 'px';
        if (left > bodyRect.width - 320) {
             pop.style.left = (left - 300) + 'px';
        } else {
             pop.style.left = (left + 10) + 'px';
        }
        
        pop.classList.remove('d-none');
        
        searchIn.value = currentCorrected || ''; 
        setTimeout(() => searchIn.focus(), 100);

        if(currentCorrected) itcPopSearch(); 
        else results.innerHTML = '<div class="text-muted p-2 small">Type to search...</div>';
    }

    function itcHidePopover() {
        document.getElementById('itcPopover').classList.add('d-none');
        itcActiveRecordId = null;
    }

    function itcPopSearch() {
        const term = document.getElementById('itcPopSearch').value;
        const results = document.getElementById('itcPopResults');
        
        if (term.length < 2) return;
        
        fetch('/api/tools/inst-corrections/search', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ county_id: itcCountyId, term: term })
        })
        .then(r => r.json())
        .then(data => {
            results.innerHTML = '';
            if (data.length === 0) {
                results.innerHTML = '<div class="text-danger p-2 small">No matches found.</div>';
                return;
            }
            data.forEach(val => {
                const row = document.createElement('div');
                row.className = 'p-2 border-bottom border-secondary text-white hover-bg-secondary cursor-pointer small';
                
                let html = `<div class="fw-bold">${val.name}</div>`;
                if(val.desc) html += `<div class="text-muted x-small">${val.desc}</div>`;
                if(val.type) html += `<div class="text-info x-small fst-italic mt-1"><i class="bi bi-tag me-1"></i>${val.type}</div>`;
                
                row.innerHTML = html;
                row.onclick = () => itcApplyCorrection(val.name);
                results.appendChild(row);
            });
        });
    }

    function itcApplyCorrection(correctedVal) {
        if (!itcActiveRecordId) return;
        
        const hideCompleted = document.getElementById('itcHideCompleted').checked;
        const row = document.getElementById(`itc-row-${itcActiveRecordId}`);
        
        itcHidePopover();
        
        fetch('/api/tools/inst-corrections/save', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                county_id: itcCountyId,
                id: itcActiveRecordId,
                original: itcActiveOriginalVal,
                corrected: correctedVal
            })
        })
        .then(r => r.json())
        .then(d => {
            if(d.success) {
                showNotification("Correction Saved", "success");
                
                // Update Info Display Immediately
                document.getElementById('itcCurrentDisplay').innerText = correctedVal;

                // Handle List UI (Hide or Update)
                if (hideCompleted) {
                    if(row) row.remove();
                    // Auto-select next row
                    const nextRow = document.querySelector('#itcRecordList > div');
                    if(nextRow) nextRow.click();
                    else {
                         document.getElementById('itcMainImage').style.display = 'none';
                         document.getElementById('itcNoImage').classList.remove('d-none');
                    }
                } else {
                    itcFetchList(); 
                }
            } else {
                showNotification("Save Failed: " + d.message);
            }
        });
    }
</script>