<script>
    var rloCountyId = null;
    var rloCurrentRecord = null;

    function openReviewLegalOthersModal(id) {
        closeAllModals(); 
        rloCountyId = id;
        if(document.getElementById('reviewLegalOthersModal')) {
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('reviewLegalOthersModal'));
            modal.show();
        }
        rloFetchList();
    }

    // --- LIST & LOAD ---
    function rloFetchList() {
        const list = document.getElementById('rloList');
        list.innerHTML = '<div class="text-muted p-2 small">Loading...</div>';
        
        fetch('/api/tools/legal-others/init', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({county_id: rloCountyId})
        }).then(r => r.json()).then(d => {
            list.innerHTML = '';
            
            if(!d.success) {
                const debugEl = document.getElementById('debugModeToggle');
                if (debugEl && debugEl.checked) {
                    list.innerHTML = `<div class="p-3 text-danger small border-bottom border-danger bg-danger bg-opacity-10">Error: ${d.message}</div>`;
                } else {
                    list.innerHTML = `<div class="p-3 text-muted small border-bottom text-center">Unable to load. Check debug mode.</div>`;
                }
                return;
            }

            if(d.records.length === 0) {
                list.innerHTML = '<div class="text-muted p-2 small">No records found.</div>';
                return;
            }
            
            d.records.forEach(r => {
                const item = document.createElement('div');
                item.className = 'p-2 border-bottom border-secondary text-white small rlo-item text-truncate';
                item.style.cursor = 'pointer';
                // Display Original Value (Key)
                item.innerText = r.desc || `Record ${r.id}`;
                item.title = "Click to Copy & Load";
                
                item.onclick = () => {
                    // Clipboard Copy
                    if(r.desc) navigator.clipboard.writeText(r.desc);
                    // Load
                    rloLoadRecord(r);
                };
                list.appendChild(item);
            });
        }).catch(err => {
            list.innerHTML = `<div class="text-danger p-2 small">Connection Error</div>`;
        });
    }

    function rloLoadRecord(record) {
        rloCurrentRecord = record;
        // Header Text matches Record Key
        document.getElementById('rloCurrentRecordLabel').innerText = record.desc || `Record #${record.id}`;
        
        // Load Fields
        document.getElementById('rloCol02').value = record.fields.col02 || '';
        document.getElementById('rloCol03').value = record.fields.col03 || '';
        document.getElementById('rloCol04').value = record.fields.col04 || '';
        document.getElementById('rloCol05').value = record.fields.col05 || '';
        document.getElementById('rloCol06').value = record.fields.col06 || '';
        document.getElementById('rloCol07').value = record.fields.col07 || '';
        
        // Load Directions (Col 8)
        document.getElementById('rloDirTags').innerHTML = '';
        if(record.fields.col08) {
            record.fields.col08.split(',').forEach(d => { if(d.trim()) rloAddDir(d.trim()); });
        }
        rloUpdateDirInput(false);

        // Reset Image Area
        const mainImg = document.getElementById('rloMainImage');
        const strip = document.getElementById('rloThumbnailStrip');
        mainImg.style.display = 'none';
        strip.innerHTML = '';
        document.getElementById('rloNoImage').style.display = 'block';
        
        // Fetch Images
        fetch('/api/tools/legal-others/images', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({county_id: rloCountyId, record_id: record.id})
        }).then(r => r.json()).then(d => {
            if(d.success && d.images.length > 0) {
                // Show Main Image (First one)
                mainImg.src = d.images[0].src;
                mainImg.style.display = 'block';
                document.getElementById('rloNoImage').style.display = 'none';

                // Populate Thumbnails
                d.images.forEach(img => {
                    const thumb = document.createElement('img');
                    thumb.src = img.src;
                    thumb.className = 'h-100 border border-secondary';
                    thumb.style.cursor = 'pointer';
                    thumb.style.opacity = '0.7';
                    thumb.onmouseover = () => thumb.style.opacity = '1';
                    thumb.onmouseout = () => thumb.style.opacity = '0.7';
                    thumb.onclick = () => { mainImg.src = img.src; };
                    strip.appendChild(thumb);
                });
            }
        });
        
        // Highlight active list item
        document.querySelectorAll('.rlo-item').forEach(el => el.classList.remove('bg-primary'));
        event.target.classList.add('bg-primary');
    }

    // --- VALIDATION & LOOKUPS ---
    function rloValidateSection(input) {
        let val = parseInt(input.value);
        if(val < 1) input.value = 1;
        if(val > 32) input.value = 32;
    }

    function rloSearchTR(input, mode) {
        const listId = mode === 'township' ? 'rloTownshipList' : 'rloRangeList';
        fetch('/api/tools/legal-others/search-tr', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({county_id: rloCountyId, term: input.value, mode: mode})
        }).then(r => r.json()).then(data => {
            const dl = document.getElementById(listId); dl.innerHTML = '';
            data.forEach(val => { const opt = document.createElement('option'); opt.value = val; dl.appendChild(opt); });
        });
    }

    function rloSearchAdd(input) {
        fetch('/api/tools/legal-others/search-adds', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({county_id: rloCountyId, term: input.value})
        }).then(r => r.json()).then(data => {
            const dl = document.getElementById('rloAddList'); dl.innerHTML = '';
            data.forEach(val => { const opt = document.createElement('option'); opt.value = val; dl.appendChild(opt); });
        });
    }

    // --- DIRECTION TAGS ---
    function rloAddDir(val) {
        const container = document.getElementById('rloDirTags');
        if([...container.children].some(c => c.dataset.val === val)) return;
        
        const tag = document.createElement('span');
        tag.className = 'badge bg-secondary d-flex align-items-center';
        tag.dataset.val = val;
        tag.innerHTML = `${val} <i class="bi bi-x ms-1" style="cursor:pointer" onclick="this.parentElement.remove(); rloUpdateDirInput(true);"></i>`;
        container.appendChild(tag);
        rloUpdateDirInput(true);
    }

    function rloUpdateDirInput(triggerSave = true) {
        const vals = [...document.getElementById('rloDirTags').children].map(c => c.dataset.val);
        document.getElementById('rloCol08').value = vals.join(', ');
        if(triggerSave) rloAutoSave();
    }

    // --- AUTO SAVE ---
    function rloAutoSave() {
        if(!rloCurrentRecord) return;
        const statusEl = document.getElementById('rloSaveStatus');
        statusEl.innerText = 'Saving...';
        
        const payload = {
            id: rloCurrentRecord.id,
            county_id: rloCountyId,
            col02: document.getElementById('rloCol02').value,
            col03: document.getElementById('rloCol03').value,
            col04: document.getElementById('rloCol04').value,
            col05: document.getElementById('rloCol05').value,
            col06: document.getElementById('rloCol06').value,
            col07: document.getElementById('rloCol07').value,
            col08: document.getElementById('rloCol08').value
        };
        
        fetch('/api/tools/legal-others/save', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(r => r.json()).then(d => {
            if(d.success) {
                statusEl.innerText = 'Saved';
                setTimeout(() => { if(statusEl.innerText === 'Saved') statusEl.innerText = ''; }, 2000);
            } else {
                 statusEl.innerText = 'Error!';
            }
        });
    }
</script>