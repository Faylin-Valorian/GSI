{% include "components/scripts/ImageManager.html" %}

<script>
    var uecState = {
        countyId: null,
        errorKey: null,
        targetRecordId: null, 
        selectedRecordId: null, 
        contextData: [],
        isEditing: false, 
        imgManager: null,
        isInternalSelection: false // Flag to prevent recursion loops
    };

    document.addEventListener('DOMContentLoaded', () => {
        if(typeof ImageManager !== 'undefined') {
            uecState.imgManager = new ImageManager({
                prefix: 'uec',
                apiEndpoint: null,
                // [NEW] Handle thumbnail click
                onSelect: (imgData, index) => {
                    if(!uecState.isInternalSelection && imgData.recordId) {
                         uecSelectRow(imgData.recordId, true); // true = called from image
                    }
                }
            });
        }
        
        initUecResizer();
    });

    // ... (initUecResizer code remains the same) ...
    function initUecResizer() {
        const resizer = document.getElementById('uecResizer');
        const bottomPane = document.getElementById('uecBottomPane'); 
        const container = resizer.parentElement;
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'row-resize';
            e.preventDefault(); 
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const containerRect = container.getBoundingClientRect();
            let newHeight = containerRect.bottom - e.clientY;
            let percentHeight = (newHeight / containerRect.height) * 100;
            if (percentHeight < 5) percentHeight = 5; 
            if (percentHeight > 95) percentHeight = 95;
            bottomPane.style.height = `${percentHeight}%`;
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = 'default';
                if(uecState.imgManager && uecState.imgManager.updateTransform) {
                    uecState.imgManager.updateTransform();
                }
            }
        });
    }

    // ... (openUniversalErrorTool and uecFetchQueue remain the same) ...
    function openUniversalErrorTool(countyId, errorKey, title) {
        uecState.countyId = countyId;
        uecState.errorKey = errorKey;
        
        document.getElementById('uecModalTitle').innerText = title || 'Error Correction';
        document.getElementById('uecModalSubtitle').innerText = errorKey;
        document.getElementById('uecList').innerHTML = '<div class="text-center p-3 text-muted"><div class="spinner-border spinner-border-sm"></div></div>';
        document.getElementById('uecTableBody').innerHTML = '';
        
        const img = document.getElementById('uecMainImage');
        if(img) { img.style.display = 'none'; img.src = ''; }
        const noImg = document.getElementById('uecNoImage');
        if(noImg) noImg.classList.remove('d-none');

        const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('universalErrorModal'));
        modal.show();

        if(uecState.imgManager) uecState.imgManager.resetUI();
        uecFetchQueue();
    }

    function uecFetchQueue() {
        fetch('/api/tools/edata-errors/records', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ county_id: uecState.countyId, error_key: uecState.errorKey })
        })
        .then(r => r.json())
        .then(data => {
            const list = document.getElementById('uecList');
            document.getElementById('uecCount').innerText = data.records ? data.records.length : 0;
            list.innerHTML = '';
            if(!data.success || !data.records || data.records.length === 0) {
                list.innerHTML = '<div class="text-muted p-2 small text-center">No records found.</div>';
                return;
            }
            data.records.forEach(rec => {
                const item = document.createElement('div');
                item.className = 'p-2 border-bottom border-secondary text-white small uec-item text-truncate';
                item.style.cursor = 'pointer';
                item.innerText = rec.desc || `ID: ${rec.id}`;
                item.onclick = () => uecLoadContext(rec.id);
                list.appendChild(item);
            });
            if(data.records.length > 0) uecLoadContext(data.records[0].id);
        });
    }

    function uecLoadContext(targetId) {
        uecState.targetRecordId = targetId;
        uecState.selectedRecordId = targetId;
        uecState.isEditing = false;
        
        document.getElementById('uecEditBtn').disabled = true;

        fetch('/api/tools/edata-errors/context', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ record_id: targetId })
        })
        .then(r => r.json())
        .then(data => {
            if(data.success && data.rows) {
                uecState.contextData = data.rows;
                
                // [NEW] Populate Image Manager with ALL context images
                if(uecState.imgManager) {
                    const imgs = data.rows.map(r => ({
                        src: r.safe_image_url ? `/api/tools/edata-errors/view-image?path=${r.safe_image_url}` : null,
                        name: `ID: ${r.id}`,
                        recordId: r.id
                    }));
                    uecState.imgManager.images = imgs;
                    uecState.imgManager.renderThumbnails();
                    
                    // Select the target image initially
                    const idx = data.rows.findIndex(r => r.id === targetId);
                    if(idx >= 0) {
                        uecState.isInternalSelection = true;
                        uecState.imgManager.select(idx);
                        uecState.isInternalSelection = false;
                    }
                }
                
                uecRenderTable();
            } else {
                document.getElementById('uecTableBody').innerHTML = '<tr><td colspan="9" class="text-center text-danger">Failed to load context.</td></tr>';
            }
        });
    }

    function uecRenderTable() {
        const tbody = document.getElementById('uecTableBody');
        tbody.innerHTML = '';
        uecState.contextData.forEach(row => {
            const isTarget = (row.id === uecState.targetRecordId);
            const isSelected = (row.id === uecState.selectedRecordId);
            
            const tr = document.createElement('tr');
            tr.className = isTarget ? 'table-danger text-dark fw-bold' : (isSelected ? 'table-active' : '');
            if(!isTarget && !isSelected) tr.classList.add('text-secondary');
            
            tr.style.cursor = 'pointer';
            tr.onclick = () => uecSelectRow(row.id);

            const editMode = isTarget || (isSelected && uecState.isEditing);
            let html = `<td class="text-center">${row.id}</td>`;
            for(let i=1; i<=8; i++) {
                const val = row[`col0${i}varchar`] || '';
                if(editMode) {
                    html += `<td class="p-0"><input type="text" class="form-control form-control-sm border-0 rounded-0 uec-input" 
                             style="${isTarget ? 'background: #f8d7da; color: #000;' : 'background: #2c3034; color: #fff;'}"
                             data-col="col0${i}varchar" value="${val}"></td>`;
                } else {
                    html += `<td>${val}</td>`;
                }
            }
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });
    }

    function uecSelectRow(id, fromImage = false) {
        if(uecState.selectedRecordId === id && !fromImage) return;
        
        uecState.selectedRecordId = id;
        uecState.isEditing = false;
        
        // Sync Image Manager if clicked from table
        if(uecState.imgManager && !fromImage) {
            const idx = uecState.contextData.findIndex(r => r.id === id);
            if(idx >= 0) {
                uecState.isInternalSelection = true;
                uecState.imgManager.select(idx);
                uecState.isInternalSelection = false;
            }
        }
        
        const isTarget = (id === uecState.targetRecordId);
        document.getElementById('uecEditBtn').disabled = isTarget; 
        
        uecRenderTable();
    }

    // ... (rest of functions: uecEnableEditing, uecSaveChanges remain the same) ...
    function uecEnableEditing() {
        if(uecState.selectedRecordId === uecState.targetRecordId) return;
        uecState.isEditing = true;
        uecRenderTable();
    }

    function uecSaveChanges() {
        let saveId = uecState.targetRecordId;
        if(uecState.selectedRecordId !== uecState.targetRecordId && uecState.isEditing) {
            saveId = uecState.selectedRecordId;
        }

        const inputs = document.querySelectorAll('.uec-input');
        if(inputs.length === 0) return;

        const payload = {
            county_id: uecState.countyId,
            error_key: uecState.errorKey,
            record_id: saveId,
            fields: {}
        };

        inputs.forEach(inp => {
            payload.fields[inp.getAttribute('data-col')] = inp.value;
        });

        const statusEl = document.getElementById('uecSaveStatus');
        statusEl.innerText = 'Saving...';
        
        const endpoint = (saveId === uecState.targetRecordId) 
            ? '/api/tools/edata-errors/save-record' 
            : '/api/tools/edata-errors/save-generic';

        fetch(endpoint, {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(data => {
            if(data.success) {
                statusEl.innerText = 'Saved!';
                statusEl.className = 'text-success small fw-bold me-2';
                const row = uecState.contextData.find(r => r.id === saveId);
                if(row) {
                    for(const [k, v] of Object.entries(payload.fields)) row[k] = v;
                }
                uecState.isEditing = false;
                uecRenderTable();
                setTimeout(() => statusEl.innerText = '', 2000);
            } else {
                statusEl.innerText = 'Error!';
                statusEl.className = 'text-danger small fw-bold me-2';
                alert(data.message);
            }
        });
    }
</script>