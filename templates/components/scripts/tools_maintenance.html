<script>
    // ==========================================
    // MAINTENANCE TOOLS
    // ==========================================

    // --- DB COMPATIBILITY ---
    function openDbCompatModal() { 
        closeAllModals(); 
        const input = document.getElementById('targetCompatLevel');
        if(input) {
            input.placeholder = "Loading...";
            fetch('/api/tools/db-compatibility/current')
                .then(r => r.json())
                .then(d => { input.placeholder = d.success ? d.level : "Error"; });
        }
        if(dbCompatModal) dbCompatModal.show(); 
    }
    
    function submitDbCompat() {
        fetch('/api/admin/db-compat/update', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({level:document.getElementById('targetCompatLevel').value})})
        .then(r=>r.json()).then(d=>{ showNotification(d.message); if(dbCompatModal) dbCompatModal.hide(); });
    }
    function openDbDowngradeModal() { closeAllModals(); if(dbDowngradeModal) dbDowngradeModal.show(); }
    function confirmDowngrade() { fetch('/api/admin/db-compat/downgrade', {method:'POST'}).then(r=>r.json()).then(d=>{ showNotification(d.message); if(dbDowngradeModal) dbDowngradeModal.hide(); }); }
    
    function openProceduresModal() { closeAllModals(); if(proceduresModal) proceduresModal.show(); }
    function submitProcedures() { fetch('/api/admin/setup-procedures/execute', {method:'POST'}).then(r=>r.json()).then(d=>{ showNotification(d.message); if(proceduresModal) proceduresModal.hide(); }); }

    // --- PATCH MANAGER ---
    function openPatchModal() { 
        closeAllModals(); 
        document.getElementById('patchFileInput').value = '';
        document.getElementById('patchError').innerText = '';
        if(patchModal) patchModal.show(); 
    }
    function closePatchModal() { if(patchModal) patchModal.hide(); }

    function submitPatchFile() {
        const file = document.getElementById('patchFileInput').files[0];
        if (!file) return;
        const fd = new FormData(); fd.append('patch_file', file);
        document.getElementById('globalLoader').style.display='flex';
        
        fetch('/api/admin/patch/apply', { method: 'POST', body: fd }).then(r => r.json()).then(d => {
            document.getElementById('globalLoader').style.display='none';
            if (d.success) { showNotification("Patch Applied! Reloading..."); setTimeout(() => location.reload(), 1500); } 
            else document.getElementById('patchError').innerText = d.message;
        });
    }

    // --- ALTER DATABASE ---
    
    function openAlterDbTool() { 
        closeAllModals(); 
        
        // Reset UI State
        const container = document.getElementById('alterDbPreviewContainer');
        const btn = document.getElementById('btnTogglePreview');
        
        if(container) container.classList.add('d-none');
        if(btn) btn.innerHTML = '<i class="bi bi-code-square me-2"></i>Generate Preview';
        
        document.getElementById('btnRunAlterDb').disabled = false; 
        document.getElementById('alterDbSqlPreview').innerText = "";

        if(alterDbModal) alterDbModal.show(); 
    }

    function toggleAlterDbPreview() {
        const container = document.getElementById('alterDbPreviewContainer');
        const btn = document.getElementById('btnTogglePreview');
        const isHidden = container.classList.contains('d-none');

        if (isHidden) {
            // OPEN
            container.classList.remove('d-none');
            btn.innerHTML = '<i class="bi bi-x-square me-2"></i>Close Preview';
            previewAlterDb(); // Load data
        } else {
            // CLOSE
            container.classList.add('d-none');
            btn.innerHTML = '<i class="bi bi-code-square me-2"></i>Generate Preview';
        }
    }

    function previewAlterDb() {
        document.getElementById('alterDbSqlPreview').innerText = "-- Generating Preview...";
        
        fetch('/api/admin/alter-db/preview')
        .then(r => r.json())
        .then(d => {
            const content = d.success ? d.sql : "-- Error: " + d.message;
            document.getElementById('alterDbSqlPreview').innerText = content;
        })
        .catch(e => {
            document.getElementById('alterDbSqlPreview').innerText = "-- Network Error";
        });
    }

    function runAlterDbMigration() {
        // Define the execution logic
        const performMigration = () => {
            const btn = document.getElementById('btnRunAlterDb');
            btn.disabled = true;
            
            fetch('/api/admin/alter-db/execute', {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({})
            })
            .then(r => r.json())
            .then(d => { 
                showNotification(d.message); 
                btn.disabled = false;
                // Update preview if it's currently open
                if(d.success && !document.getElementById('alterDbPreviewContainer').classList.contains('d-none')) {
                    previewAlterDb();
                }
            })
            .catch(e => {
                showNotification("Error: " + e);
                btn.disabled = false;
            });
        };

        // EXPLICITLY USE CUSTOM POPUP (No Fallback)
        if (typeof showConfirmation === 'function') {
            showConfirmation("Alter Database Schema?", performMigration);
        } else {
            console.error("showConfirmation function is missing! Ensure scripts_core.html is loaded.");
        }
    }
    
    function copyAlterDbSql() {
        const text = document.getElementById('alterDbSqlPreview').innerText;
        navigator.clipboard.writeText(text).then(() => showNotification("SQL Copied"));
    }
</script>