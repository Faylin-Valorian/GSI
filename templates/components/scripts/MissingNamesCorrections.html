<script>
    var missingNamesModal;
    var mnCountyId = null;
    var mnCurrentRecord = null;
    var mnImgMgr = null;
    var mnBasePath = "";

    document.addEventListener('DOMContentLoaded', () => {
        const el = document.getElementById('missingNamesModal');
        if (el) missingNamesModal = new bootstrap.Modal(el);
    });

    function openMissingNamesTool(id, s, c) {
        closeAllModals(); 
        mnCountyId = id;
        mnBasePath = `data/${s}/${c}/Images`; 
        
        if(!mnImgMgr) {
            mnImgMgr = new ImageManager({
                prefix: 'mn',
                apiEndpoint: '/api/tools/missing-names/images' 
            });
        }
        mnImgMgr.resetUI();
        
        if(missingNamesModal) missingNamesModal.show();
        
        document.getElementById('mnListStatus').innerText = 'Initializing...';
        fetch('/api/tools/missing-names/init', {
            method:'POST', headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify({county_id:id})
        })
        .then(r => r.json())
        .then(d => { 
            if(d.success) {
                mnFetchList(); 
            } else {
                document.getElementById('mnListStatus').innerText = 'Error';
                alert("Tool Initialization Failed: " + (d.message || "Unknown Error"));
            }
        })
        .catch(err => {
            console.error(err);
            document.getElementById('mnListStatus').innerText = 'Connection Error';
            alert("Network/Server Error: " + err);
        });
    }

    function mnFetchList() {
        document.getElementById('mnListStatus').innerText = 'Loading Records...';
        fetch('/api/tools/missing-names/list', {
            method:'POST', headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify({county_id:mnCountyId})
        })
        .then(r => r.json())
        .then(d => {
            if(!d.success) {
                document.getElementById('mnListStatus').innerText = 'Error Loading List';
                alert("Error loading list: " + d.message);
                return;
            }

            const l = document.getElementById('mnRecordList'); l.innerHTML = '';
            document.getElementById('mnListStatus').innerText = `${d.records.length} Records Found`;
            
            d.records.forEach(r => {
                const item = document.createElement('div'); 
                item.className='p-2 border-bottom text-white mn-item small'; 
                item.style.cursor = 'pointer';
                
                item.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <span class="badge bg-secondary">${r.type}</span>
                        <span class="text-muted x-small">#${r.inst_id}</span>
                    </div>
                `;
                item.onclick = () => mnLoadRecord(r, item);
                l.appendChild(item);
            });
            
            if(d.records.length > 0) mnLoadRecord(d.records[0], l.firstChild);
        })
        .catch(err => {
            document.getElementById('mnListStatus').innerText = 'List Fetch Error';
        });
    }

    function mnLoadRecord(r, el) {
        mnCurrentRecord = r;
        document.querySelectorAll('.mn-item').forEach(e => e.classList.remove('bg-danger'));
        if(el) el.classList.add('bg-danger');

        document.getElementById('mnTypeDisplay').innerText = r.type;
        
        // Key Display
        const keyDisplay = document.getElementById('mnKeyDisplay');
        if(keyDisplay) keyDisplay.innerText = r.key_val || '---';
        
        // NEW: Related Names Display
        const relDisplay = document.getElementById('mnRelatedInfo');
        if(relDisplay) {
            relDisplay.innerText = r.related_names ? r.related_names : "";
            relDisplay.title = r.related_names || "No related names";
        }
        
        document.getElementById('mnInput').value = '';
        document.getElementById('mnReverseToggle').checked = false;

        mnImgMgr.load({
            county_id: mnCountyId,
            record_id: r.id, 
            base_path: mnBasePath
        });
    }

    function mnSave() {
        if(!mnCurrentRecord) return;
        const val = document.getElementById('mnInput').value;
        const rev = document.getElementById('mnReverseToggle').checked;
        
        if(!val) { alert("Please enter a name or click Skip."); return; }

        fetch('/api/tools/missing-names/save', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                county_id: mnCountyId,
                id: mnCurrentRecord.id,
                value: val,
                reverse: rev
            })
        }).then(r=>r.json()).then(d => {
            if(d.success) mnFetchList();
            else alert("Error: " + d.message);
        });
    }

    function mnSkip() {
        if(!mnCurrentRecord) return;
        if(!confirm("Are you sure? This will either:\n1. Copy the other name if it exists.\n2. DELETE the entire instrument if no names exist.")) return;

        fetch('/api/tools/missing-names/skip', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                county_id: mnCountyId,
                id: mnCurrentRecord.id
            })
        }).then(r=>r.json()).then(d => {
            if(d.success) mnFetchList();
            else alert("Error: " + d.message);
        });
    }
</script>