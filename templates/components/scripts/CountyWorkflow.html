<script>
    // ==========================================
    // COUNTY WORKFLOW & POPUP LOGIC
    // ==========================================

    function openCountyPopup(props, layer) {
        const dbId = props.db_id;
        
        // Fetch the pre-rendered HTML from the server
        fetch(`/api/county/${dbId}/popup`)
            .then(r => r.text())
            .then(html => {
                // Bind the HTML directly to the popup
                layer.bindPopup(html, {minWidth: 460, maxWidth: 500}).openPopup();
            })
            .catch(err => console.error("Popup Error:", err));
    }

    // --- WORKFLOW ACTIONS ---

    function toggleWork(id, status) {
        fetch('/api/user/set-working', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({county_id: id, active: status})
        }).then(r=>r.json()).then(d => {
            if(d.success) {
                if(typeof refreshMapLayers === 'function') refreshMapLayers(); 
                map.closePopup(); 
                showNotification(status ? "Set as Working County" : "Stopped Working");
            } else {
                showNotification(d.message);
                // Optional: Re-open popup to show state didn't change, or just alert user
            }
        });
    }

    function toggleGlobalActiveFromPopup(id) {
        fetch(`/api/county/${id}/set-global-active`, {method: 'POST'})
        .then(r=>r.json()).then(d => {
            if(d.success) {
                if(typeof refreshMapLayers === 'function') refreshMapLayers();
                map.closePopup(); 
                showNotification("County Status Updated");
            } else {
                showNotification("Action Failed: " + (d.message || "Unknown error"));
            }
        });
    }

    function saveNotes(id, text) {
        fetch(`/api/county/${id}/save-notes`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({notes: text})
        });
    }

    function triggerUpload(id, isMine) {
        if(!isMine) return;
        document.getElementById(`upload-${id}`).click();
    }

    function uploadImage(id, input) {
        if (input.files && input.files[0]) {
            const formData = new FormData();
            formData.append('file', input.files[0]);

            fetch(`/api/county/${id}/upload`, {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(d => {
                if(d.success) {
                     map.closePopup(); // Refresh popup to force image reload
                } else {
                    showNotification("Upload failed: " + d.message);
                }
            });
        }
    }
</script>