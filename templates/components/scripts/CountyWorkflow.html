<script>
    // ==========================================
    // COUNTY WORKFLOW & POPUP LOGIC
    // ==========================================

    function openCountyPopup(props, layer) {
        const dbId = props.db_id;
        
        // Fetch the pre-rendered HTML from the server
        fetch(`/api/county/${dbId}/popup`)
            .then(r => r.text())
            .then(html => {
                // Bind the HTML directly to the popup
                layer.bindPopup(html, {minWidth: 460, maxWidth: 500}).openPopup();
            })
            .catch(err => console.error("Popup Error:", err));
    }

    // --- WORKFLOW ACTIONS ---

    function toggleWork(id, status) {
        fetch('/api/user/set-working', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({county_id: id, active: status})
        }).then(r=>r.json()).then(d => {
            if(d.success) {
                if(typeof refreshMapLayers === 'function') refreshMapLayers(); 
                map.closePopup(); 
                showNotification(status ? "Set as Working County" : "Stopped Working");
            } else {
                showNotification(d.message);
                // Optional: Re-open popup to show state didn't change, or just alert user
            }
        });
    }

    function toggleGlobalActiveFromPopup(id) {
        fetch(`/api/county/${id}/set-global-active`, {method: 'POST'})
        .then(r=>r.json()).then(d => {
            if(d.success) {
                if(typeof refreshMapLayers === 'function') refreshMapLayers();
                map.closePopup(); 
                showNotification("County Status Updated");
            } else {
                showNotification("Action Failed: " + (d.message || "Unknown error"));
            }
        });
    }

    function saveNotes(id, text) {
        fetch(`/api/county/${id}/save-notes`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({notes: text})
        });
    }

    function triggerUpload(id, isMine) {
        if(!isMine) return;
        document.getElementById(`upload-${id}`).click();
    }

    function uploadImage(id, input) {
        if (input.files && input.files[0]) {
            const formData = new FormData();
            formData.append('file', input.files[0]);

            fetch(`/api/county/${id}/upload`, {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(d => {
                if(d.success) {
                     map.closePopup(); // Refresh popup to force image reload
                } else {
                    showNotification("Upload failed: " + d.message);
                }
            });
        }
    }

    // ==========================================
    // eDATA ERRORS TAB LOGIC
    // ==========================================
    
    const errorDefinitions = {
        "Header": ["Non Numeric Page Number", "Duplicate Book & Page", "Duplicate Instrument Number", "Incorrect Record Series", "Incorrect Instrument Number Length", "Missing Beginning Page Number", "Missing Book Number", "Missing Instrument Number", "Missing Record Series", "Non Numeric Instrument Number", "Valid Book Range"],
        "Image": ["Duplicate Book & Page", "Incorrect Book Length", "Incorrect Page Length", "Incorrect Path Length", "Non Numeric Page Number", "Non Numeric Book Number", "Missing Page Number", "Missing Book Number"],
        "Legal": ["Incorrect Section Number", "Incorrect Township & Range", "Incorrect Quarter Section", "Missing Section Number", "Missing Township & Range", "Missing Quarter Section"],
        "Name": ["Duplicate Names"],
        "Reference": ["Not Within Book Range"]
    };

    window.renderCountyErrors = function(id) {
        const sel = document.getElementById('errorCat_' + id);
        const con = document.getElementById('errorBtnContainer_' + id);
        if (!sel || !con) return;

        const cat = sel.value;
        const list = errorDefinitions[cat] || [];
        let h = '';

        if (list.length === 0) {
            h = '<div class="text-muted small text-center my-2">No errors defined.</div>';
        } else {
            list.forEach(e => {
                // Use btn-outline-secondary to match the theme color scheme defined in CSS
                h += `<button class="btn btn-sm btn-outline-secondary text-start" onclick="openErrorTool('${cat}', '${e}', ${id})"><i class="bi bi-bug me-2"></i>${e}</button>`;
            });
        }
        con.innerHTML = h;
    };

    window.openErrorTool = function(cat, err, id) {
        console.log(`Open Error Tool: [${cat}] ${err} (County: ${id})`);
        // TODO: Wire this to your actual error correction modal when ready
        showNotification(`Opening ${err}...`, "info");
    };
</script>