<script>
    // ==========================================
    // 3. KELI TOOLS
    // ==========================================

    // --- INITIAL PREP ---
    let currentPrepCountyId = null;
    function openInitialPrepTool(id) {
        closeAllModals(); currentPrepCountyId = id;
        if(initialPrepModal) initialPrepModal.show();
        // Reset
        document.getElementById('prepResult').innerHTML='';
        const toggle = document.getElementById('prepToggleBook'); if(toggle) toggle.checked=false;
        document.getElementById('prepBookInputsContainer').classList.add('d-none');
    }
    function togglePrepBookInputs() {
        if(document.getElementById('prepToggleBook').checked) {
            document.getElementById('prepBookInputsContainer').classList.remove('d-none');
            fetch('/api/tools/initial-prep/get-book-range/'+currentPrepCountyId).then(r=>r.json()).then(d=>{ if(d.found){ document.getElementById('prepBookStart').value=d.start; document.getElementById('prepBookEnd').value=d.end; }});
        } else { document.getElementById('prepBookInputsContainer').classList.add('d-none'); }
    }
    function runPrepTool() {
        const btn=document.getElementById('btnRunPrep'); btn.disabled=true;
        document.getElementById('prepProgressContainer').classList.remove('d-none');
        fetch('/api/tools/initial-prep/execute', {method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ county_id: currentPrepCountyId, book_start: document.getElementById('prepBookStart').value, book_end: document.getElementById('prepBookEnd').value })
        }).then(r=>{ btn.disabled=false; document.getElementById('prepResult').innerText = "Process Complete"; });
    }

    // --- ITC (CORRECTIONS) ---
    let itcCountyId=null;
    function openInstCorrectionTool(id, s, c) {
        closeAllModals(); itcCountyId = id;
        document.getElementById('itcPathInput').value = `data/${s}/${c}/Images`;
        if(instCorrectionModal) instCorrectionModal.show();
        fetch('/api/tools/inst-corrections/init', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({county_id:id})})
        .then(r=>r.json()).then(d => { if(d.success) itcFetchList(); });
    }
    function itcFetchList() {
        fetch('/api/tools/inst-corrections/list', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({county_id:itcCountyId, hide_completed:document.getElementById('itcHideCompleted').checked})})
        .then(r=>r.json()).then(d => {
            const l = document.getElementById('itcRecordList'); l.innerHTML = '';
            d.records.forEach(r => {
                const d = document.createElement('div'); d.className='p-2 border-bottom text-white'; d.innerText=r.value; 
                d.onclick=()=>{itcLoadImages(r.value)}; l.appendChild(d);
            });
        });
    }
    function itcLoadImages(val) { /* Standard logic handles image loading */ }

    // --- KELI LINKUP (FIXED) ---
    let currentLinkupCountyId = null, linkupDefaultsCache = null;
    function openLinkupModal(passedId) {
        closeAllModals(); 
        let countyId = passedId || (typeof selectedCountyId !== 'undefined' ? selectedCountyId : null);
        if (!countyId && document.getElementById('eDataCountyId')) countyId = document.getElementById('eDataCountyId').value;
        if (!countyId) return showNotification("No County Selected");
        
        currentLinkupCountyId = countyId; linkupDefaultsCache = null;
        if(linkupModal) linkupModal.show();
        
        // Reset UI
        document.getElementById('linkupResult').innerHTML = '';
        document.getElementById('linkupTogglePath').checked = false;
        document.getElementById('linkupToggleBook').checked = false;
        document.getElementById('linkupBookContainer').classList.add('d-none');
        
        fetch(`/api/tools/initial-keli-linkup/defaults/${currentLinkupCountyId}`).then(r=>r.json()).then(d=>{
            if(d.success && d.found) {
                linkupDefaultsCache = {start:d.book_start, end:d.book_end, path:d.path_prefix};
                document.getElementById('linkupAutoStatus').innerText = "Defaults Detected";
            }
        });
    }
    function toggleLinkupBookInputs() {
        if(document.getElementById('linkupToggleBook').checked && linkupDefaultsCache) {
            document.getElementById('linkupBookContainer').classList.remove('d-none');
            document.getElementById('linkupBookStart').value = linkupDefaultsCache.start;
            document.getElementById('linkupBookEnd').value = linkupDefaultsCache.end;
        } else { document.getElementById('linkupBookContainer').classList.add('d-none'); }
    }
    function toggleLinkupPathInput() {
        if(document.getElementById('linkupTogglePath').checked && linkupDefaultsCache) {
            document.getElementById('linkupPathContainer').classList.remove('d-none');
            document.getElementById('linkupImgPath').value = linkupDefaultsCache.path;
        } else { document.getElementById('linkupPathContainer').classList.add('d-none'); }
    }
    function runLinkupTool() {
        const payload = {
            county_id: currentLinkupCountyId,
            use_book_range: document.getElementById('linkupToggleBook').checked,
            book_start: document.getElementById('linkupBookStart').value,
            book_end: document.getElementById('linkupBookEnd').value,
            use_path: document.getElementById('linkupTogglePath').checked,
            image_path_prefix: document.getElementById('linkupImgPath').value,
            split_images: document.getElementById('linkupSplitImages').checked,
            linkup_mode: document.querySelector('input[name="linkupMode"]:checked').value
        };
        const btn = document.getElementById('btnRunLinkup'); btn.disabled=true;
        document.getElementById('linkupProgressContainer').classList.remove('d-none');
        fetch('/api/tools/initial-keli-linkup/execute', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)})
        .then(r=>{ btn.disabled=false; document.getElementById('linkupResult').innerText = "Done"; });
    }
</script>