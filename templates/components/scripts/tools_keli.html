<script>
    // ==========================================
    // KELI TOOLS (Integrated)
    // ==========================================

    // --- GLOBAL DEBUG VISIBILITY ---
    // Controls preview buttons for Prep, Linkup, and Alter DB tools
    function updateDebugVisibility() {
        const toggle = document.getElementById('debugModeToggle');
        const isDebug = toggle && toggle.checked;
        const buttons = ['btnPrepPreview', 'btnLinkupPreview', 'btnAlterDbPreview'];
        
        buttons.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                if (isDebug) btn.classList.remove('d-none');
                else btn.classList.add('d-none');
            }
        });
    }

    // Attach listener to global toggle
    document.addEventListener('DOMContentLoaded', () => {
        const toggle = document.getElementById('debugModeToggle');
        if(toggle) {
            toggle.addEventListener('change', updateDebugVisibility);
            // Run once on load to set initial state
            updateDebugVisibility();
        }
    });

    // --- SETUP KELI TABLES ---
    function openKeliModal(id, stateName, countyName) { 
        closeAllModals();
        document.getElementById('keliCountyId').value = id;
        const displayPath = `/data/${stateName}/${countyName}/Keli Files`;
        document.getElementById('keliDisplayPath').innerText = displayPath;
        if(keliModal) keliModal.show(); 
    }
    
    function closeKeliModal() { if(keliModal) keliModal.hide(); }

    async function submitKeliSetup() {
        const btn = document.querySelector('#keliModal .btn[onclick="submitKeliSetup()"]');
        const resultDiv = document.getElementById('keliResult');
        const idVal = document.getElementById('keliCountyId').value;
        
        btn.disabled = true; resultDiv.innerHTML = '';
        
        // Reset Progress
        document.getElementById('keliProgressContainer').classList.remove('d-none');
        document.getElementById('keliProgressBar').style.width = '0%';
        document.getElementById('keliProgressText').innerText = '0%';

        try {
            const response = await fetch('/api/tools/setup-keli', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ county_id: idVal })
            });
            const reader = response.body.getReader(); const decoder = new TextDecoder();
            while (true) {
                const { done, value } = await reader.read(); if (done) break;
                const lines = decoder.decode(value).split('\n');
                lines.forEach(l => { if(l) try {
                    const d = JSON.parse(l);
                    if(d.type==='progress') {
                        document.getElementById('keliProgressBar').style.width = d.percent+'%';
                        document.getElementById('keliProgressText').innerText = d.percent+'%';
                    }
                    if(d.type==='complete') {
                        document.getElementById('keliProgressBar').style.width = '100%';
                        document.getElementById('keliProgressText').innerText = '100%';
                        resultDiv.innerHTML=`<div class="alert alert-success">${d.message}</div>`;
                    }
                } catch(e){} });
            }
        } catch (e) { resultDiv.innerHTML = '<div class="alert alert-danger">Connection Failed</div>'; } 
        finally { btn.disabled = false; }
    }

    // --- INITIAL PREP TOOL ---
    var currentPrepCountyId = null; 

    function openInitialPrepTool(id) {
        closeAllModals(); 
        currentPrepCountyId = id;
        
        // Reset UI
        document.getElementById('prepResult').innerHTML='';
        document.getElementById('prepProgressContainer').classList.add('d-none');
        document.getElementById('prepProgressBar').style.width = '0%';
        document.getElementById('prepProgressPercent').innerText = '0%';
        document.getElementById('prepDebugPanel').classList.add('d-none');

        // Check debug state
        updateDebugVisibility();
        
        if(initialPrepModal) initialPrepModal.show();
    }

    function togglePrepBookInputs() {
        if(document.getElementById('prepToggleBook').checked) {
            document.getElementById('prepBookInputsContainer').classList.remove('d-none');
            fetch('/api/tools/initial-prep/get-book-range/'+currentPrepCountyId).then(r=>r.json()).then(d=>{ if(d.found){ document.getElementById('prepBookStart').value=d.start; document.getElementById('prepBookEnd').value=d.end; }});
        } else { document.getElementById('prepBookInputsContainer').classList.add('d-none'); }
    }

    function previewPrepSql() {
        const btn = document.getElementById('btnPrepPreview');
        const resultDiv = document.getElementById('prepResult');
        const textarea = document.getElementById('prepSqlPreview');
        btn.disabled = true;

        const payload = { 
            county_id: currentPrepCountyId, 
            book_start: document.getElementById('prepBookStart').value, 
            book_end: document.getElementById('prepBookEnd').value 
        };

        fetch('/api/tools/initial-prep/preview', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(d => {
            btn.disabled = false;
            if(d.success) {
                document.getElementById('prepDebugPanel').classList.remove('d-none');
                textarea.value = d.sql;
                resultDiv.innerHTML = '';
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger">${d.message}</div>`;
            }
        })
        .catch(e => { btn.disabled = false; resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${e}</div>`; });
    }

    function copyPrepSql() {
        const copyText = document.getElementById("prepSqlPreview");
        copyText.select();
        navigator.clipboard.writeText(copyText.value);
    }

    function runPrepTool() {
        const btn = document.getElementById('btnRunPrep'); 
        btn.disabled = true;
        
        document.getElementById('prepProgressContainer').classList.remove('d-none');
        document.getElementById('prepProgressBar').style.width = '0%';
        document.getElementById('prepProgressPercent').innerText = '0%';
        document.getElementById('prepResult').innerHTML = '';

        fetch('/api/tools/initial-prep/execute', {
            method:'POST', 
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ 
                county_id: currentPrepCountyId, 
                book_start: document.getElementById('prepBookStart').value, 
                book_end: document.getElementById('prepBookEnd').value 
            })
        }).then(response => {
            const reader = response.body.getReader(); 
            const decoder = new TextDecoder();
            
            function read() { 
                reader.read().then(({ done, value }) => {
                    if (done) { btn.disabled = false; return; }
                    const lines = decoder.decode(value).split('\n');
                    lines.forEach(l => {
                        try { 
                            const d = JSON.parse(l);
                            if(d.type === 'progress') {
                                document.getElementById('prepProgressBar').style.width = d.percent + '%';
                                document.getElementById('prepProgressPercent').innerText = d.percent + '%'; 
                                document.getElementById('prepProgressLabel').innerText = d.message; 
                            }
                            if(d.type === 'complete') {
                                document.getElementById('prepProgressBar').style.width = '100%';
                                document.getElementById('prepProgressPercent').innerText = '100%';
                                document.getElementById('prepResult').innerHTML = `<div class="alert alert-success">${d.message}</div>`;
                            }
                            if(d.type === 'error') {
                                document.getElementById('prepResult').innerHTML = `<div class="alert alert-danger">${d.message}</div>`;
                            }
                        } catch(e){}
                    });
                    read();
                }); 
            } 
            read();
        }).catch(err => {
            btn.disabled = false;
            document.getElementById('prepResult').innerHTML = '<div class="alert alert-danger">Connection Failed: ' + err + '</div>';
        });
    }

    // --- ITC (CORRECTIONS) ---
    var itcCountyId = null; 
    function openInstCorrectionTool(id, s, c) {
        closeAllModals(); itcCountyId = id;
        document.getElementById('itcPathInput').value = `data/${s}/${c}/Images`;
        if(instCorrectionModal) instCorrectionModal.show();
        fetch('/api/tools/inst-corrections/init', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({county_id:id})})
        .then(r=>r.json()).then(d => { if(d.success) itcFetchList(); });
    }
    function itcFetchList() {
        fetch('/api/tools/inst-corrections/list', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({county_id:itcCountyId, hide_completed:document.getElementById('itcHideCompleted').checked})})
        .then(r=>r.json()).then(d => {
            const l = document.getElementById('itcRecordList'); l.innerHTML = '';
            d.records.forEach(r => {
                const d = document.createElement('div'); d.className='p-2 border-bottom text-white'; d.innerText=r.value; 
                d.onclick=()=>{itcLoadImages(r.value)}; l.appendChild(d);
            });
        });
    }
    function itcLoadImages(val) { console.log("Load ITC: "+val); }

    // --- KELI LINKUP ---
    var currentLinkupCountyId = null, linkupDefaultsCache = null; 
    function openLinkupModal(passedId) {
        closeAllModals(); 
        let countyId = passedId || (typeof selectedCountyId !== 'undefined' ? selectedCountyId : null);
        if (!countyId && document.getElementById('eDataCountyId')) countyId = document.getElementById('eDataCountyId').value;
        if (!countyId) return showNotification("No County Selected");
        
        currentLinkupCountyId = countyId; 
        
        if(linkupModal) linkupModal.show();
        
        // Reset UI
        document.getElementById('linkupResult').innerHTML = '';
        document.getElementById('linkupTogglePath').checked = false;
        document.getElementById('linkupToggleBook').checked = false;
        document.getElementById('linkupBookContainer').classList.add('d-none');
        document.getElementById('linkupPathContainer').classList.add('d-none');
        document.getElementById('linkupProgressContainer').classList.add('d-none');
        document.getElementById('linkupDebugPanel').classList.add('d-none');
        
        // Check Debug State
        updateDebugVisibility();

        // Fetch Defaults (Optional)
        fetch(`/api/tools/initial-keli-linkup/defaults/${currentLinkupCountyId}`).then(r=>r.json()).then(d=>{
            if(d.success && d.found) {
                linkupDefaultsCache = {start:d.book_start, end:d.book_end, path:d.path_prefix};
                document.getElementById('linkupAutoStatus').innerText = "Defaults Detected";
                // Pre-fill
                document.getElementById('linkupBookStart').value = d.book_start;
                document.getElementById('linkupBookEnd').value = d.book_end;
                document.getElementById('linkupImgPath').value = d.path_prefix;
            } else {
                linkupDefaultsCache = null;
                document.getElementById('linkupAutoStatus').innerText = "No defaults found";
            }
        });
    }

    // FIX: Toggles now work regardless of defaults cache
    function toggleLinkupBookInputs() {
        if(document.getElementById('linkupToggleBook').checked) {
            document.getElementById('linkupBookContainer').classList.remove('d-none');
        } else { document.getElementById('linkupBookContainer').classList.add('d-none'); }
    }
    
    function toggleLinkupPathInput() {
        if(document.getElementById('linkupTogglePath').checked) {
            document.getElementById('linkupPathContainer').classList.remove('d-none');
        } else { document.getElementById('linkupPathContainer').classList.add('d-none'); }
    }

    function previewLinkupSql() {
        const btn = document.getElementById('btnLinkupPreview');
        const resultDiv = document.getElementById('linkupResult');
        const textarea = document.getElementById('linkupSqlPreview');
        btn.disabled = true;

        const payload = {
            county_id: currentLinkupCountyId,
            use_book_range: document.getElementById('linkupToggleBook').checked,
            book_start: document.getElementById('linkupBookStart').value,
            book_end: document.getElementById('linkupBookEnd').value,
            use_path: document.getElementById('linkupTogglePath').checked,
            image_path_prefix: document.getElementById('linkupImgPath').value,
            split_images: document.getElementById('linkupSplitImages').checked,
            linkup_mode: document.querySelector('input[name="linkupMode"]:checked').value
        };

        fetch('/api/tools/initial-keli-linkup/preview', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(d => {
            btn.disabled = false;
            if(d.success) {
                document.getElementById('linkupDebugPanel').classList.remove('d-none');
                textarea.value = d.sql;
                resultDiv.innerHTML = '';
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger">${d.message}</div>`;
            }
        })
        .catch(e => { btn.disabled = false; resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${e}</div>`; });
    }

    function copyLinkupSql() {
        const copyText = document.getElementById("linkupSqlPreview");
        copyText.select();
        navigator.clipboard.writeText(copyText.value);
    }

    // FIX: Replaced simple fetch with STREAMING READER for progress bar
    function runLinkupTool() {
        const payload = {
            county_id: currentLinkupCountyId,
            use_book_range: document.getElementById('linkupToggleBook').checked,
            book_start: document.getElementById('linkupBookStart').value,
            book_end: document.getElementById('linkupBookEnd').value,
            use_path: document.getElementById('linkupTogglePath').checked,
            image_path_prefix: document.getElementById('linkupImgPath').value,
            split_images: document.getElementById('linkupSplitImages').checked,
            linkup_mode: document.querySelector('input[name="linkupMode"]:checked').value
        };
        const btn = document.getElementById('btnRunLinkup'); 
        const resultDiv = document.getElementById('linkupResult');
        btn.disabled=true;

        document.getElementById('linkupProgressContainer').classList.remove('d-none');
        const pBar = document.getElementById('linkupProgressBar');
        
        // FIX: Correct ID is linkupProgressPercent, NOT linkupProgressText
        const pText = document.getElementById('linkupProgressPercent');
        
        pBar.style.width = '0%';
        pText.innerText = '0%';
        resultDiv.innerHTML = '';

        fetch('/api/tools/initial-keli-linkup/execute', {
            method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
        })
        .then(response => {
            const reader = response.body.getReader(); 
            const decoder = new TextDecoder();
            
            function read() { 
                reader.read().then(({ done, value }) => {
                    if (done) { btn.disabled = false; return; }
                    const lines = decoder.decode(value).split('\n');
                    lines.forEach(l => {
                        try { 
                            const d = JSON.parse(l);
                            if(d.type === 'progress') {
                                pBar.style.width = d.percent + '%';
                                pText.innerText = d.percent + '%';
                                if(d.message) document.getElementById('linkupProgressLabel').innerText = d.message;
                            }
                            if(d.type === 'complete') {
                                pBar.style.width = '100%';
                                pText.innerText = '100%';
                                resultDiv.innerHTML = `<div class="alert alert-success">${d.message}</div>`;
                            }
                            if(d.type === 'error') {
                                resultDiv.innerHTML = `<div class="alert alert-danger">${d.message}</div>`;
                            }
                        } catch(e){}
                    });
                    read();
                }); 
            } 
            read();
        })
        .catch(err => {
            btn.disabled = false;
            resultDiv.innerText = "Error: " + err;
        });
    }
</script>