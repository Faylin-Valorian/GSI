<script>
    let edeErrorsMgr = null;
    let currentEdeErrorsId = null;
    let currentMergeType = null; // Track which merge button was clicked

    function openEdataErrorsModal(id) {
        closeAllModals(); 
        currentEdeErrorsId = id;
        
        if(document.getElementById('eDataCountyId')) document.getElementById('eDataCountyId').value = id;

        if(document.getElementById('edataErrorsModal')) {
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('edataErrorsModal'));
            modal.show();
        }

        // Reset UI
        document.getElementById('edeResult').innerHTML = '';
        if(document.getElementById('edeProgressContainer')) document.getElementById('edeProgressContainer').classList.add('d-none');
        document.getElementById('edeMergeResult').innerHTML = ''; // Reset merge result

        // Init Preview Manager
        if(!edeErrorsMgr) {
            edeErrorsMgr = new PreviewManager({
                prefix: 'edeErrors',
                apiPreview: '/api/tools/edata-errors/preview',
                apiDownload: '/api/tools/edata-errors/download-sql',
                filename: 'Error_Scan.sql',
                payloadProvider: () => ({ 
                    county_id: currentEdeErrorsId,
                    book_start: document.getElementById('edeBookStart').value,
                    book_end: document.getElementById('edeBookEnd').value,
                    townships: document.getElementById('edeTownships').value,
                    split_images: document.getElementById('edeSplitImages').checked
                })
            });
        }
        edeErrorsMgr.reset();

        // Get Defaults
        fetch(`/api/tools/edata-errors/get-defaults/${id}`).then(r=>r.json()).then(d=>{
            if(d.success) { 
                if(document.getElementById('edeBookStart')) document.getElementById('edeBookStart').value = d.book_start; 
                if(document.getElementById('edeBookEnd')) document.getElementById('edeBookEnd').value = d.book_end; 
                if(document.getElementById('edeTownships')) document.getElementById('edeTownships').value = d.townships; 
            }
        });
    }

    function runEdataErrors() {
        // (Existing Scan Logic - Unchanged)
        const btn = document.getElementById('btnRunEde'); 
        btn.disabled = true;
        document.getElementById('edeProgressContainer').classList.remove('d-none');
        const pBar = document.getElementById('edeProgressBar'); 
        pBar.style.width = '0%';
        document.getElementById('edeLogBox').innerHTML = '';
        document.getElementById('edeResult').innerText = '';
        
        if(edeErrorsMgr) edeErrorsMgr.reset();
        const payload = edeErrorsMgr.payloadProvider();

        fetch('/api/tools/edata-errors/execute', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
        }).then(response => {
            const reader = response.body.getReader(); const decoder = new TextDecoder();
            function read() { reader.read().then(({ done, value }) => {
                if (done) { btn.disabled = false; document.getElementById('edeResult').innerText = "Done"; pBar.style.width = '100%'; return; }
                const lines = decoder.decode(value).split('\n');
                lines.forEach(l => { try { const d = JSON.parse(l); 
                    if(d.type === 'progress') { pBar.style.width = d.percent + '%'; document.getElementById('edeProgressPercent').innerText = d.percent + '%'; }
                    if(d.type === 'log') { const div = document.createElement('div'); div.innerText = d.message; document.getElementById('edeLogBox').appendChild(div); }
                    if(d.type === 'error') { document.getElementById('edeResult').innerHTML = `<div class="alert alert-danger">${d.message}</div>`; }
                } catch(e){} });
                read();
            }); } read();
        }).catch(e => { 
            btn.disabled = false; 
            document.getElementById('edeResult').innerHTML = `<div class="alert alert-danger">Error: ${e}</div>`; 
        });
    }
    
    // [NEW] Merge Logic
    function edeOpenConfirm(type) {
        currentMergeType = type;
        const confirmModal = new bootstrap.Modal(document.getElementById('edeConfirmModal'));
        confirmModal.show();
    }

    function edeRunMerge() {
        // Hide confirm modal
        const confirmModalEl = document.getElementById('edeConfirmModal');
        const confirmModal = bootstrap.Modal.getInstance(confirmModalEl);
        confirmModal.hide();

        const resDiv = document.getElementById('edeMergeResult');
        resDiv.innerHTML = '<div class="spinner-border text-warning" role="status"></div><div class="small text-muted">Merging Data...</div>';

        fetch('/api/tools/edata-errors/merge-corrections', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ county_id: currentEdeErrorsId, merge_type: currentMergeType })
        })
        .then(r => r.json())
        .then(data => {
            if(data.success) {
                resDiv.innerHTML = `<div class="alert alert-success small"><i class="bi bi-check-circle-fill me-2"></i>${data.message}</div>`;
            } else {
                resDiv.innerHTML = `<div class="alert alert-danger small"><i class="bi bi-exclamation-triangle-fill me-2"></i>${data.message}</div>`;
            }
        })
        .catch(e => {
            resDiv.innerHTML = `<div class="alert alert-danger small">Error: ${e}</div>`;
        });
    }

    window.openEDataErrorsModal = openEdataErrorsModal;
</script>