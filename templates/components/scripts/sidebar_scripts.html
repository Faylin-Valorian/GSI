<script>
    // ==========================================
    // 6. UI UTILITIES & INIT
    // ==========================================
    
    // --- LAYER TOGGLES ---
    function toggleStateLayer(cb) {
        if (cb.checked) {
            map.addLayer(stateLayerGroup);
            loadStateLayers(); 
        } else {
            map.removeLayer(stateLayerGroup);
        }
    }

    function toggleCountyLayer(cb) {
        if (cb.checked) {
            map.addLayer(countyLayerGroup);
            loadCountyLayers();
        } else {
            map.removeLayer(countyLayerGroup);
        }
    }

    // --- TABLE FILTERING ---
    function filterCountiesTable() {
        const filter = document.getElementById('countySearchInput').value.toLowerCase();
        const rows = document.getElementById('countiesTableBody').getElementsByTagName('tr');
        for (let i = 0; i < rows.length; i++) {
            const td = rows[i].getElementsByClassName("county-name")[0];
            if (td) rows[i].style.display = (td.innerText.toLowerCase().indexOf(filter) > -1) ? "" : "none";
        }
    }

    // --- THEME TOGGLE ---
    function toggleTheme() {
        const h = document.documentElement; 
        const newTheme = h.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
        h.setAttribute('data-bs-theme', newTheme);
        
        map.removeLayer(currentLayer); 
        currentLayer = newTheme === 'dark' ? darkLayer : lightLayer; 
        currentLayer.addTo(map);

        if(document.getElementById('layerToggleStates').checked) loadStateLayers();
        if(document.getElementById('layerToggleCounties').checked) loadCountyLayers();
    }
    
    // --- PANEL TOGGLE ---
    let activePanelId=null;
    function togglePanel(id, tab) {
        const p = document.getElementById(id);
        if(activePanelId===id){ 
            p.classList.remove('open'); 
            tab.classList.remove('active'); 
            activePanelId=null; 
        } else { 
            document.querySelectorAll('.menu-panel').forEach(x=>x.classList.remove('open')); 
            document.querySelectorAll('.dock-tab').forEach(x=>x.classList.remove('active')); 
            p.classList.add('open'); 
            tab.classList.add('active'); 
            activePanelId=id; 
        }
    }
    
    // --- DEBUG MODE TOGGLE ---
    function toggleDebugMode(cb) {
        const userRole = cb.getAttribute('data-user-role');
        const isTurningOn = cb.checked;

        if (userRole === 'admin') {
            fetch('/api/admin/debug/toggle', {method: 'POST'})
                .then(r => r.json())
                .then(d => {
                    if(d.success) console.log("Debug Mode:", d.debug_mode ? "ON" : "OFF");
                    else { cb.checked = !cb.checked; showNotification("Action Failed"); }
                });
        } else {
            if (isTurningOn) {
                cb.checked = false; 
                openAdminAuthModal();
            } else {
                fetch('/api/user/debug/disable', {method: 'POST'})
                .then(r => r.json());
            }
        }
    }

    // --- ADMIN AUTH ---
    function openAdminAuthModal() {
        document.getElementById('adminAuthUser').value = '';
        document.getElementById('adminAuthPass').value = '';
        if(adminAuthModal) adminAuthModal.show();
    }

    function submitAdminAuth() {
        const u = document.getElementById('adminAuthUser').value;
        const p = document.getElementById('adminAuthPass').value;
        if(!u || !p) return;

        fetch('/api/user/debug/auth-enable', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: u, password: p })
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                if(adminAuthModal) adminAuthModal.hide();
                document.getElementById('debugModeToggle').checked = true;
                showNotification("Debug Mode Enabled", "success");
            } else {
                document.getElementById('adminAuthError').innerText = "Invalid Admin Credentials.";
            }
        });
    }

    function loadDebugStatus() {
        fetch('/api/admin/debug/status')
            .then(r => r.json())
            .then(d => {
                const toggle = document.getElementById('debugModeToggle');
                if(toggle) toggle.checked = d.debug_mode;
            });
    }

    // --- ACTIVITY MONITOR ---
    function resetActivity(){fetch('/keep-alive',{method:'POST'}).then(()=>startInactivityTimer())}
    let inactT,logT;
    function startInactivityTimer() {
        clearTimeout(inactT); clearTimeout(logT);
        inactT=setTimeout(()=>{ if(timeoutModal) timeoutModal.show(); logT=setTimeout(()=>window.location.href="/logout",6e5) },66e5);
    }
    document.onmousemove=function(){if(!document.querySelector('.modal.show'))startInactivityTimer()}

    // --- INIT ---
    window.onload = function() { 
        loadDebugStatus();
        // Removed Map Init calls - MapVisualization handles this now
    };
</script>