<script>
    let currentPrepCountyId = null;
    let prepMgr = null;

    function openPrepModal(id, name) {
        closeAllModals(); currentPrepCountyId = id;
        document.getElementById('prepCountyName').innerText = name;
        
        if(!prepMgr) {
            prepMgr = new PreviewManager({
                prefix: 'prep',
                apiPreview: '/api/tools/initial-prep/preview',
                apiDownload: '/api/tools/initial-prep/download-sql',
                filename: 'Initial_Prep.sql',
                payloadProvider: () => ({ county_id: currentPrepCountyId, book_start: document.getElementById('prepBookStart').value, book_end: document.getElementById('prepBookEnd').value })
            });
        }
        prepMgr.reset();
        
        if(typeof updateAllToolsDebug === 'function') updateAllToolsDebug();
        if(prepModal) prepModal.show();
    }

    function closePrepModal() { if(prepModal) prepModal.hide(); }

    function runPrepTool() {
        const btn = document.querySelector('#prepModal .btn-primary');
        const res = document.getElementById('prepResult');
        btn.disabled = true; res.innerHTML = '<span class="spinner-border spinner-border-sm text-primary"></span> Processing...';
        
        if(prepMgr) prepMgr.reset();
        
        fetch('/api/tools/initial-prep/run', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ county_id: currentPrepCountyId, book_start: document.getElementById('prepBookStart').value, book_end: document.getElementById('prepBookEnd').value })
        }).then(r => r.json()).then(d => {
            btn.disabled = false;
            if(d.success) res.innerHTML = `<div class="alert alert-success">${d.message}</div>`;
            else res.innerHTML = `<div class="alert alert-danger">${d.message}</div>`;
        }).catch(e => { btn.disabled = false; res.innerHTML = `<div class="alert alert-danger">Error: ${e}</div>`; });
    }

    // --- FIX: Add Aliases for Backward Compatibility ---
    window.openInitialPrepTool = openPrepModal;
</script>