<script>
    var currentPrepCountyId = null; 
    let prepMgr = null;

    function openInitialPrepTool(id) {
        closeAllModals(); currentPrepCountyId = id;
        document.getElementById('prepResult').innerHTML='';
        document.getElementById('prepProgressContainer').classList.add('d-none');
        
        if(!prepMgr) {
            prepMgr = new PreviewManager({
                prefix: 'prep',
                apiPreview: '/api/tools/initial-prep/preview',
                apiDownload: '/api/tools/initial-prep/download-sql',
                filename: 'Initial_Prep.sql',
                payloadProvider: () => ({ 
                    county_id: currentPrepCountyId, 
                    book_start: document.getElementById('prepBookStart').value, 
                    book_end: document.getElementById('prepBookEnd').value,
                    image_path_prefix: document.getElementById('prepImgPath').value
                })
            });
        }
        prepMgr.reset();

        if(typeof updateAllToolsDebug === 'function') updateAllToolsDebug();

        // Fetch defaults immediately upon opening
        fetch('/api/tools/initial-prep/get-defaults/'+currentPrepCountyId).then(r=>r.json()).then(d=>{ 
            if(d.found){ 
                document.getElementById('prepBookStart').value = d.start; 
                document.getElementById('prepBookEnd').value = d.end;
                document.getElementById('prepImgPath').value = d.path_prefix;
            }
        });

        if(initialPrepModal) initialPrepModal.show();
    }

    function closeInitialPrepModal() { if(initialPrepModal) initialPrepModal.hide(); }

    function togglePrepBookInputs() {
        if(document.getElementById('prepToggleBook').checked) {
            document.getElementById('prepBookInputsContainer').classList.remove('d-none');
        } else { 
            document.getElementById('prepBookInputsContainer').classList.add('d-none'); 
        }
    }

    function runPrepTool() {
        const btn = document.getElementById('btnRunPrep'); btn.disabled = true;
        document.getElementById('prepProgressContainer').classList.remove('d-none');
        const pBar=document.getElementById('prepProgressBar'), pText=document.getElementById('prepProgressPercent');
        pBar.style.width='0%'; pText.innerText='0%';
        
        if(prepMgr) prepMgr.reset();

        fetch('/api/tools/initial-prep/execute', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ 
                county_id: currentPrepCountyId, 
                book_start: document.getElementById('prepBookStart').value, 
                book_end: document.getElementById('prepBookEnd').value,
                image_path_prefix: document.getElementById('prepImgPath').value
            })
        }).then(response => {
            const reader = response.body.getReader(); const decoder = new TextDecoder();
            function read() { reader.read().then(({ done, value }) => {
                if (done) { btn.disabled = false; return; }
                const lines = decoder.decode(value).split('\n');
                lines.forEach(l => { try { const d = JSON.parse(l); 
                    if(d.type === 'progress') { pBar.style.width = d.percent + '%'; pText.innerText = d.percent + '%'; document.getElementById('prepProgressLabel').innerText = d.message; }
                    if(d.type === 'complete') { pBar.style.width = '100%'; document.getElementById('prepResult').innerHTML = `<div class="alert alert-success">${d.message}</div>`; }
                    if(d.type === 'error') document.getElementById('prepResult').innerHTML = `<div class="alert alert-danger">${d.message}</div>`;
                } catch(e){} });
                read();
            }); } read();
        }).catch(err => { btn.disabled = false; document.getElementById('prepResult').innerHTML = '<div class="alert alert-danger">Failed: ' + err + '</div>'; });
    }
</script>