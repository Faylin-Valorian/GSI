<script>
    var currentPrepCountyId = null; 
    function openInitialPrepTool(id) {
        closeAllModals(); currentPrepCountyId = id;
        document.getElementById('prepResult').innerHTML='';
        document.getElementById('prepProgressContainer').classList.add('d-none');
        document.getElementById('prepDebugPanel').classList.add('d-none');
        if(typeof updateAllToolsDebug === 'function') updateAllToolsDebug();
        if(initialPrepModal) initialPrepModal.show();
    }
    function togglePrepBookInputs() {
        if(document.getElementById('prepToggleBook').checked) {
            document.getElementById('prepBookInputsContainer').classList.remove('d-none');
            fetch('/api/tools/initial-prep/get-book-range/'+currentPrepCountyId).then(r=>r.json()).then(d=>{ if(d.found){ document.getElementById('prepBookStart').value=d.start; document.getElementById('prepBookEnd').value=d.end; }});
        } else { document.getElementById('prepBookInputsContainer').classList.add('d-none'); }
    }
    function previewPrepSql() {
        const btn = document.getElementById('btnPrepPreview');
        const textarea = document.getElementById('prepSqlPreview');
        btn.disabled = true;
        fetch('/api/tools/initial-prep/preview', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ county_id: currentPrepCountyId, book_start: document.getElementById('prepBookStart').value, book_end: document.getElementById('prepBookEnd').value })
        }).then(r => r.json()).then(d => {
            btn.disabled = false;
            if(d.success) { document.getElementById('prepDebugPanel').classList.remove('d-none'); textarea.value = d.sql; document.getElementById('prepResult').innerHTML = ''; } 
            else { document.getElementById('prepResult').innerHTML = `<div class="alert alert-danger">${d.message}</div>`; }
        }).catch(e => { btn.disabled = false; document.getElementById('prepResult').innerHTML = `<div class="alert alert-danger">Error: ${e}</div>`; });
    }
    function copyPrepSql() { navigator.clipboard.writeText(document.getElementById("prepSqlPreview").value); }
    function runPrepTool() {
        const btn = document.getElementById('btnRunPrep'); btn.disabled = true;
        document.getElementById('prepProgressContainer').classList.remove('d-none');
        const pBar=document.getElementById('prepProgressBar'), pText=document.getElementById('prepProgressPercent');
        pBar.style.width='0%'; pText.innerText='0%';
        fetch('/api/tools/initial-prep/execute', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ county_id: currentPrepCountyId, book_start: document.getElementById('prepBookStart').value, book_end: document.getElementById('prepBookEnd').value })
        }).then(response => {
            const reader = response.body.getReader(); const decoder = new TextDecoder();
            function read() { reader.read().then(({ done, value }) => {
                if (done) { btn.disabled = false; return; }
                const lines = decoder.decode(value).split('\n');
                lines.forEach(l => { try { const d = JSON.parse(l); 
                    if(d.type === 'progress') { pBar.style.width = d.percent + '%'; pText.innerText = d.percent + '%'; document.getElementById('prepProgressLabel').innerText = d.message; }
                    if(d.type === 'complete') { pBar.style.width = '100%'; document.getElementById('prepResult').innerHTML = `<div class="alert alert-success">${d.message}</div>`; }
                    if(d.type === 'error') document.getElementById('prepResult').innerHTML = `<div class="alert alert-danger">${d.message}</div>`;
                } catch(e){} });
                read();
            }); } read();
        }).catch(err => { btn.disabled = false; document.getElementById('prepResult').innerHTML = '<div class="alert alert-danger">Failed: ' + err + '</div>'; });
    }
</script>