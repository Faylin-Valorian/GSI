<script>
    var currentImportEdeCountyId = null; 
    let importEdeMgr = null;

    function openImportEDataErrorsModal(passedId) {
        closeAllModals(); currentImportEdeCountyId = passedId;
        if(document.getElementById('importEDataErrorsModal')) {
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('importEDataErrorsModal'));
            modal.show();
        }
        
        document.getElementById('importEdeResult').innerText = '';
        document.getElementById('importEdeProgressContainer').classList.add('d-none');
        
        if(!importEdeMgr) {
            importEdeMgr = new PreviewManager({
                prefix: 'importEde',
                apiPreview: '/api/tools/import-edata-errors/preview',
                apiDownload: '/api/tools/import-edata-errors/download-sql',
                filename: 'Import_Errors.sql',
                payloadProvider: () => ({ county_id: currentImportEdeCountyId })
            });
        }
        importEdeMgr.reset();
        
        if(typeof updateAllToolsDebug === 'function') updateAllToolsDebug();
        
        fetch('/api/tools/import-edata-errors/init', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ county_id: passedId })})
        .then(r => r.json()).then(d => {
            if(d.success) {
                document.getElementById('importEdeDisplayPath').innerText = d.path;
                document.getElementById('importEdeFileCount').innerText = d.file_count + " files";
                document.getElementById('btnRunImportEde').disabled = (d.file_count === 0);
            }
        });
    }

    function runImportEDataErrors() {
        const btn = document.getElementById('btnRunImportEde'); btn.disabled = true;
        document.getElementById('importEdeProgressContainer').classList.remove('d-none');
        
        if(importEdeMgr) importEdeMgr.reset();
        
        const pBar = document.getElementById('importEdeProgressBar'); pBar.style.width = '0%';
        
        fetch('/api/tools/import-edata-errors/run', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ county_id: currentImportEdeCountyId })})
        .then(async response => {
            const reader = response.body.getReader(); const decoder = new TextDecoder();
            while(true) {
                const {done, value} = await reader.read(); if(done) break;
                const lines = decoder.decode(value).split('\n');
                lines.forEach(l => { if(l) {
                    try {
                        const d = JSON.parse(l);
                        if(d.type==='progress') { pBar.style.width = d.percent+'%'; document.getElementById('importEdeProgressText').innerText = d.percent+'%'; document.getElementById('importEdeCurrentFile').innerText = d.message; }
                        if(d.type==='complete') { pBar.style.width = '100%'; document.getElementById('importEdeResult').innerHTML = `<div class="alert alert-success">${d.message}</div>`; btn.disabled = false; }
                    } catch(e) {}
                }});
            }
        });
    }

    // --- ALIAS FOR SIDEBAR COMPATIBILITY ---
    window.openImportEDataErrorsTool = openImportEDataErrorsModal;
</script>